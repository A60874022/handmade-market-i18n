name: Deploy Ad Service with SSL

on:
  push:
    branches: [ master ]

jobs:
  build_and_push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: anton60874022/ad_service:latest

  deploy:
    name: Deploy to Server with SSL
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # === –°–û–ó–î–ê–ù–ò–ï .env –§–ê–ô–õ–ê ===
      - name: Create .env file from secrets
        run: |
          echo "üîß Creating .env file from GitHub Secrets..."
          cat > .env << EOF
          # Django
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=${{ secrets.DEBUG }}
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          
          # Database (PostgreSQL) - –í–ê–ñ–ù–û: DB_HOST=db –¥–ª—è Docker —Å–µ—Ç–∏
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          
          # Redis
          REDIS_URL=redis://redis:6379/0
          
          # Email
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          EMAIL_USE_TLS=${{ secrets.EMAIL_USE_TLS }}
          EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}
          EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}
          DEFAULT_FROM_EMAIL=${{ secrets.DEFAULT_FROM_EMAIL }}
          
          # Security
          CSRF_TRUSTED_ORIGINS=${{ secrets.CSRF_TRUSTED_ORIGINS }}
          EOF
          
          echo "‚úÖ .env file created"
          echo "Key PostgreSQL variables:"
          grep -E "(POSTGRES_|DB_)" .env

      # === –°–æ–∑–¥–∞—ë–º –±–∞–∑–æ–≤—ã–π nginx.conf –¥–ª—è certbot webroot ===
      - name: Create nginx configuration for certbot
        run: |
          echo "üîß Creating temporary nginx.conf for certbot..."
          mkdir -p infra/nginx
          cat > infra/nginx/nginx.conf << 'EOF'
          events {
              worker_connections 1024;
          }
          
          http {
              server {
                  listen 80;
                  server_name mart.akatosphere.com www.mart.akatosphere.com;
                  
                  location /.well-known/acme-challenge/ {
                      root /var/www/certbot;
                  }
                  
                  location / {
                      return 404;
                  }
              }
          }
          EOF
          echo "‚úÖ Temporary nginx.conf created for certbot"

      - name: Install Docker Compose on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üì¶ Installing Docker Compose..."
            if command -v docker-compose &> /dev/null; then
              echo "‚úÖ Docker Compose already installed"
              docker-compose --version
            else
              echo "Installing Docker Compose..."
              curl -SL https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
              echo "‚úÖ Docker Compose installed"
              docker-compose --version
            fi

      - name: Clean server safely (targeted cleanup)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üßπ Safe server cleanup (targeted)..."
            
            # –¢–æ–ª—å–∫–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
            if [ -d "/root/ad_service" ]; then
              cd /root/ad_service
              echo "Stopping project containers..."
              docker-compose down 2>/dev/null || true
            fi
            
            echo "Removing ONLY project containers..."
            # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–æ –∏–º–µ–Ω–∞–º –ø—Ä–æ–µ–∫—Ç–∞
            docker ps -a --filter "name=handmade" --format "{{.ID}}" | xargs -r docker rm -f 2>/dev/null || true
            docker ps -a --filter "name=db" --format "{{.ID}}" | xargs -r docker rm -f 2>/dev/null || true
            docker ps -a --filter "name=redis" --format "{{.ID}}" | xargs -r docker rm -f 2>/dev/null || true
            
            echo "Removing ONLY project images..."
            docker images "anton60874022/ad_service" -q | xargs -r docker rmi -f 2>/dev/null || true
            
            echo "Cleaning unused Docker resources (safe)..."
            docker system prune -f 2>/dev/null || true
            
            echo "‚úÖ Safe cleanup completed, database volume preserved"

      - name: Copy infrastructure files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "infra/"
          target: "/root/ad_service/"
          overwrite: true
          strip_components: 1

      - name: Copy .env to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          source: ".env"
          target: "/root/ad_service/"
          overwrite: true

      - name: Check Docker ports instead of system ports
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîç Checking Docker container ports..."
            echo "Docker containers using ports 80/443:"
            docker ps --format "table {{.Names}}\t{{.Ports}}" | grep -E "(80|443)" || echo "No containers using ports 80/443"
            
            echo "Stopping any conflicting Docker containers..."
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, —Å–ª—É—à–∞—é—â–∏–µ –ø–æ—Ä—Ç—ã 80/443
            docker ps --filter "publish=80" --format "{{.ID}}" | xargs -r docker stop 2>/dev/null || true
            docker ps --filter "publish=443" --format "{{.ID}}" | xargs -r docker stop 2>/dev/null || true
            
            echo "‚úÖ Docker port check completed"

      - name: Deploy application services (without nginx)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üöÄ Deploying application services..."
            cd /root/ad_service/
            
            echo "1. Verifying environment..."
            ls -la
            echo "=== PostgreSQL variables ==="
            grep -E "(POSTGRES_|DB_)" .env
            
            echo "2. Logging in to Docker Hub..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            echo "3. Pulling latest application image..."
            docker pull anton60874022/ad_service:latest
            
            echo "4. Starting PostgreSQL and Redis..."
            docker-compose up -d db redis
            
            echo "5. Waiting for PostgreSQL to be ready..."
            for i in {1..30}; do
              if docker-compose exec -T db pg_isready -U postgres; then
                echo "‚úÖ PostgreSQL is ready!"
                break
              else
                echo "‚è≥ Waiting for PostgreSQL... ($i/30)"
                sleep 2
              fi
            done
            
            echo "6. Creating database and user if not exists..."
            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
            docker-compose exec -T db psql -U postgres -c "CREATE USER ${{ secrets.POSTGRES_USER }} WITH PASSWORD '${{ secrets.POSTGRES_PASSWORD }}';" 2>/dev/null || echo "User already exists or error"
            docker-compose exec -T db psql -U postgres -c "CREATE DATABASE ${{ secrets.POSTGRES_DB }} OWNER ${{ secrets.POSTGRES_USER }};" 2>/dev/null || echo "Database already exists or error"
            docker-compose exec -T db psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE ${{ secrets.POSTGRES_DB }} TO ${{ secrets.POSTGRES_USER }};" 2>/dev/null || true
            
            echo "7. Starting web application..."
            docker-compose up -d web
            
            echo "8. Checking environment variables in web container..."
            docker-compose exec -T web printenv | grep -E "(SECRET_KEY|POSTGRES_|DB_)"
            
            echo "9. Testing PostgreSQL connection from Django..."
            docker-compose exec -T web python -c "
import os
import sys
try:
    import psycopg2
    conn = psycopg2.connect(
        dbname=os.getenv('POSTGRES_DB', '${{ secrets.POSTGRES_DB }}'),
        user=os.getenv('POSTGRES_USER', '${{ secrets.POSTGRES_USER }}'),
        password=os.getenv('POSTGRES_PASSWORD', '${{ secrets.POSTGRES_PASSWORD }}'),
        host=os.getenv('DB_HOST', 'db'),
        port=os.getenv('DB_PORT', '5432')
    )
    print('‚úÖ PostgreSQL connection test SUCCESSFUL')
    conn.close()
except ImportError:
    print('‚ùå psycopg2 not installed. Check requirements.txt')
    sys.exit(1)
except Exception as e:
    print(f'‚ùå PostgreSQL connection FAILED: {e}')
    print('Debug info:')
    print(f'  DB_NAME: {os.getenv(\"POSTGRES_DB\")}')
    print(f'  DB_USER: {os.getenv(\"POSTGRES_USER\")}')
    print(f'  DB_HOST: {os.getenv(\"DB_HOST\")}')
    sys.exit(1)
"
            
            echo "10. Running migrations..."
            docker-compose exec -T web python manage.py migrate --noinput
            
            echo "11. Collecting static files..."
            docker-compose exec -T web python manage.py collectstatic --noinput --clear
            
            echo "‚úÖ Application services deployed successfully!"

      - name: Prepare for SSL (create directories and update config)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üìÅ Preparing for SSL certificate..."
            cd /root/ad_service/
            
            echo "1. Creating certbot webroot directory..."
            mkdir -p certbot_webroot
            chmod 755 certbot_webroot
            
            echo "2. Updating docker-compose.yml to use bind mount..."
            # –ò–∑–º–µ–Ω—è–µ–º —Ç–æ–º –Ω–∞ bind mount –¥–ª—è certbot_webroot
            sed -i 's|- certbot_webroot:/var/www/certbot|- ./certbot_webroot:/var/www/certbot|' docker-compose.yml
            
            echo "3. Creating nginx directory if not exists..."
            mkdir -p nginx
            
            echo "‚úÖ SSL preparation completed"

      - name: Deploy nginx for certbot (HTTP only)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üåê Deploying nginx for certbot (HTTP mode)..."
            cd /root/ad_service/
            
            echo "1. Starting nginx with temporary HTTP config..."
            docker-compose up -d nginx
            
            echo "2. Waiting for nginx to start..."
            sleep 5
            
            echo "3. Testing nginx configuration..."
            docker-compose exec nginx nginx -t
            
            echo "4. Checking nginx is serving certbot challenges..."
            docker-compose exec nginx ls -la /var/www/certbot/.well-known/acme-challenge/ 2>/dev/null || echo "Directory will be created by certbot"
            
            echo "‚úÖ Nginx is ready for certbot webroot validation"

      - name: Obtain SSL certificate using webroot (–±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –ø–æ—Ä—Ç–æ–≤)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üîê Obtaining SSL certificate via webroot method..."
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º certbot –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if ! command -v certbot &> /dev/null; then
              apt-get update
              apt-get install -y certbot
            fi
            
            echo "1. Checking if domain resolves to this server..."
            nslookup mart.akatosphere.com || echo "DNS check skipped"
            
            echo "2. Requesting SSL certificate for mart.akatosphere.com..."
            certbot certonly --webroot \
              -w /root/ad_service/certbot_webroot \
              -d mart.akatosphere.com \
              -d www.mart.akatosphere.com \
              --non-interactive \
              --agree-tos \
              --email anton60874022@mail.ru \
              --preferred-challenges http
            
            echo "‚úÖ SSL certificate obtained successfully!"
            
            echo "3. Certificate details:"
            ls -la /etc/letsencrypt/live/mart.akatosphere.com/

      - name: Update nginx with SSL configuration
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üîÑ Updating nginx with SSL configuration..."
            cd /root/ad_service/
            
            echo "1. Creating production nginx.conf with SSL..."
            cat > nginx/nginx.conf << 'EOF'
            events {
                worker_connections 1024;
            }
            
            http {
                upstream django {
                    server web:8000;
                }
                
                # HTTP -> HTTPS redirect
                server {
                    listen 80;
                    server_name mart.akatosphere.com www.mart.akatosphere.com;
                    return 301 https://$server_name$request_uri;
                }
                
                # HTTPS server
                server {
                    listen 443 ssl http2;
                    server_name mart.akatosphere.com www.mart.akatosphere.com;
                    
                    # SSL certificates (–º–æ–Ω—Ç–∏—Ä—É—é—Ç—Å—è –∏–∑ /etc/letsencrypt)
                    ssl_certificate /etc/letsencrypt/live/mart.akatosphere.com/fullchain.pem;
                    ssl_certificate_key /etc/letsencrypt/live/mart.akatosphere.com/privkey.pem;
                    ssl_protocols TLSv1.2 TLSv1.3;
                    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
                    ssl_prefer_server_ciphers off;
                    
                    # Security headers
                    add_header X-Frame-Options "SAMEORIGIN" always;
                    add_header X-Content-Type-Options "nosniff" always;
                    add_header X-XSS-Protection "1; mode=block" always;
                    
                    # Django application
                    location / {
                        proxy_pass http://django;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                        proxy_set_header Host $host;
                        proxy_redirect off;
                        proxy_buffering off;
                    }
                    
                    # Static files
                    location /static/ {
                        alias /app/staticfiles/;
                        expires 1y;
                        add_header Cache-Control "public, immutable";
                    }
                    
                    # Media files
                    location /media/ {
                        alias /app/media/;
                        expires 1d;
                        add_header Cache-Control "public";
                    }
                    
                    # Certbot renewal challenges
                    location /.well-known/acme-challenge/ {
                        root /var/www/certbot;
                    }
                }
            }
            EOF
            
            echo "2. Restarting nginx with SSL configuration..."
            docker-compose restart nginx
            
            echo "3. Testing nginx configuration..."
            docker-compose exec nginx nginx -t
            
            echo "‚úÖ Nginx updated with SSL!"

      - name: Setup SSL certificate auto-renewal (–±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ nginx)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîÑ Setting up SSL certificate auto-renewal (–±–µ–∑ downtime)..."
            
            # –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            cat > /root/renew_ssl.sh << 'EOF'
            #!/bin/bash
            echo "========================================"
            echo "$(date): Starting SSL certificate renewal"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑ webroot (–ë–ï–ó –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ nginx)
            certbot renew --webroot -w /root/ad_service/certbot_webroot --non-interactive --post-hook "cd /root/ad_service && docker-compose exec nginx nginx -s reload"
            
            if [ $? -eq 0 ]; then
                echo "$(date): SSL certificates renewed successfully"
                echo "Nginx reloaded with new certificates"
            else
                echo "$(date): SSL certificate renewal failed"
            fi
            echo "========================================"
            EOF
            
            chmod +x /root/renew_ssl.sh
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç
            echo "Testing renewal script..."
            bash -n /root/renew_ssl.sh && echo "‚úÖ Renewal script syntax is valid"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤ crontab (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3:00)
            (crontab -l 2>/dev/null | grep -v "renew_ssl.sh"; echo "0 3 * * * /root/renew_ssl.sh >> /var/log/ssl-renewal.log 2>&1") | crontab -
            
            echo "‚úÖ SSL auto-renewal configured (–±–µ–∑ downtime!)"

      - name: Verify deployment and run final tests
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üîç Final deployment verification..."
            cd /root/ad_service/
            
            echo "1. Container status:"
            docker-compose ps
            
            echo "2. Waiting for services to stabilize..."
            sleep 10
            
            echo "3. Testing Django application health..."
            if docker-compose exec -T web curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/ | grep -q "200\|302\|301"; then
              echo "‚úÖ Django application is responding (HTTP)"
            else
              echo "‚ö†Ô∏è Django HTTP check failed, checking logs..."
              docker-compose logs web --tail=20
            fi
            
            echo "4. Testing HTTPS from inside the server..."
            if curl -fsk -H "Host: mart.akatosphere.com" https://localhost/ > /dev/null; then
              echo "‚úÖ HTTPS is working internally"
            else
              echo "‚ùå HTTPS internal test failed"
              docker-compose logs nginx --tail=30
            fi
            
            echo "5. Testing PostgreSQL connectivity..."
            docker-compose exec -T db psql -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} -c "SELECT 'PostgreSQL connection OK' as status;"
            
            echo "6. Testing email functionality..."
            docker-compose exec -T web python -c "
import os
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'ad_service.settings')
import django
django.setup()
from django.core.mail import send_mail
from django.conf import settings

try:
    send_mail(
        'Deployment Verification - HTTPS Active',
        'Your Django application has been successfully deployed with HTTPS!\n\n'
        'Details:\n'
        f'- Domain: mart.akatosphere.com\n'
        f'- Database: PostgreSQL ({settings.DATABASES[\"default\"][\"HOST\"]})\n'
        f'- Redis: {settings.CACHES[\"default\"][\"LOCATION\"] if \"CACHES\" in dir(settings) else \"Not configured\"}',
        settings.DEFAULT_FROM_EMAIL,
        ['anton60874022@mail.ru'],
        fail_silently=False,
    )
    print('‚úÖ Verification email sent successfully!')
except Exception as e:
    print(f'‚ö†Ô∏è Email test failed (non-critical): {e}')
"
            
            echo "7. Checking SSL certificate expiration..."
            openssl x509 -in /etc/letsencrypt/live/mart.akatosphere.com/fullchain.pem -noout -dates
            
            echo "üéâ Deployment verification complete!"
            echo ""
            echo "=== SUMMARY ==="
            echo "‚úÖ PostgreSQL: Running"
            echo "‚úÖ Redis: Running" 
            echo "‚úÖ Django: Running"
            echo "‚úÖ Nginx: Running with SSL"
            echo "‚úÖ SSL Certificate: Installed"
            echo "‚úÖ Auto-renewal: Configured"
            echo ""
            echo "Your site should now be available at:"
            echo "  ‚Ä¢ https://mart.akatosphere.com"
            echo "  ‚Ä¢ https://www.mart.akatosphere.com"