name: –î–µ–ø–ª–æ–π Ad Service —Å SSL

on:
  push:
    branches: [ master ]

jobs:
  build_and_push:
    name: –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è Docker –æ–±—Ä–∞–∑–∞
    runs-on: ubuntu-latest
    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4

      - name: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ requirements.txt
        run: |
          echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          cat > requirements.txt << 'EOF'
          Django==5.2.7
          channels==4.1.0
          channels-redis==4.2.0
          psycopg2-binary==2.9.9
          whitenoise==6.6.0
          redis==5.0.1
          Pillow==10.0.1
          python-dotenv==1.0.0
          django-redis==5.4.0
          django-allauth==65.12.1
          django-parler==2.3
          django-rosetta==0.10.0
          daphne==4.1.0
          EOF
          
          echo "‚úÖ requirements.txt —Å–æ–∑–¥–∞–Ω"

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: –í—Ö–æ–¥ –≤ Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è Docker –æ–±—Ä–∞–∑–∞
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: anton60874022/ad_service:latest

  deploy:
    name: –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4

      # === –°–û–ó–î–ê–ù–ò–ï .env –§–ê–ô–õ–ê ===
      - name: –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
        run: |
          echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ GitHub..."
          cat > .env << 'EOF'
          # Django
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=True
          ALLOWED_HOSTS=localhost,127.0.0.1,72.56.82.4,mart.akatosphere.com,www.mart.akatosphere.com
          
          # Database
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          
          # Redis
          REDIS_URL=redis://redis:6379
          
          # Email
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          EMAIL_USE_TLS=${{ secrets.EMAIL_USE_TLS }}
          EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}
          EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}
          DEFAULT_FROM_EMAIL=${{ secrets.EMAIL_HOST_USER }}
          
          # Security
          CSRF_TRUSTED_ORIGINS=https://mart.akatosphere.com,https://www.mart.akatosphere.com
          EOF
          
          echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω"

      # === –ü–û–î–ì–û–¢–û–í–ö–ê –°–ï–†–í–ï–†–ê ===
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Docker Compose..."
            if ! command -v docker-compose &> /dev/null; then
              echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose..."
              curl -SL https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              echo "‚úÖ Docker Compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            else
              echo "‚úÖ Docker Compose —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            fi

      - name: –û—á–∏—Å—Ç–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
            cd /root
            
            echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker stop handmade_web handmade_nginx redis 2>/dev/null || true
            docker rm handmade_web handmade_nginx redis 2>/dev/null || true
            
            echo "–û—á–∏—Å—Ç–∫–∞ Docker..."
            docker system prune -f || true
            
            echo "–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –ø—Ä–æ–µ–∫—Ç–∞..."
            rm -rf /root/ad_service
            mkdir -p /root/ad_service/nginx
            mkdir -p /root/ad_service/logs
            
            echo "‚úÖ –°–µ—Ä–≤–µ—Ä –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω"

      # === –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –§–ê–ô–õ–û–í –ù–ê –°–ï–†–í–ï–† ===
      - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        uses: appleboy/scp-action@v0.1.4  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "infra/"
          target: "/root/ad_service/"
          overwrite: true
          strip_components: 1

      - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        uses: appleboy/scp-action@v0.1.4  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: ".env"
          target: "/root/ad_service/"
          overwrite: true

      # === –î–ï–ü–õ–û–ô –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===
      - name: –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            cd /root/ad_service/
            
            echo "1. –í—Ö–æ–¥ –≤ Docker Hub..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            echo "2. –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞–∑–∞..."
            docker pull anton60874022/ad_service:latest
            
            echo "3. –ó–∞–ø—É—Å–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ Redis..."
            docker-compose up -d db redis
            
            echo "4. –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
            for i in {1..20}; do
              if docker-compose exec -T db pg_isready -U postgres 2>/dev/null; then
                echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞!"
                break
              else
                echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö... ($i/20)"
                sleep 3
              fi
            done
            
            echo "5. –ó–∞–ø—É—Å–∫ web-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            docker-compose up -d web
            
            echo "6. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            sleep 15
            
            echo "7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker-compose ps
            
            echo "8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ web-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            docker-compose logs web --tail 20
            
            echo "9. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
            docker-compose exec -T web python manage.py migrate --noinput
            
            echo "10. –°–±–æ—Ä —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
            docker-compose exec -T web python manage.py collectstatic --noinput
            
            echo "11. –°–æ–∑–¥–∞–Ω–∏–µ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
            docker-compose exec -T web python -c "
import os
import django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'ad_service.settings')
django.setup()
from django.contrib.auth import get_user_model
User = get_user_model()
if not User.objects.filter(username='admin').exists():
    User.objects.create_superuser('admin', 'admin@example.com', 'admin123')
    print('‚úÖ –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω')
else:
    print('‚úÖ –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')
"
            
            echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ!"

      # === –ù–ê–°–¢–†–û–ô–ö–ê SSL –°–ï–†–¢–ò–§–ò–ö–ê–¢–ê ===
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
            
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot
            apt-get update
            apt-get install -y certbot
            
            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ nginx –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–æ—Ä—Ç–∞ 80
            cd /root/ad_service
            docker-compose stop nginx 2>/dev/null || true
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
            echo "–ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
            certbot certonly --standalone \
              -d mart.akatosphere.com \
              -d www.mart.akatosphere.com \
              --non-interactive \
              --agree-tos \
              --email anton60874022@mail.ru \
              --preferred-challenges http \
              --http-01-port 80
            
            echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ–ª—É—á–µ–Ω"

      # === –î–ï–ü–õ–û–ô NGINX ===
      - name: –î–µ–ø–ª–æ–π Nginx —Å SSL
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üöÄ –ó–∞–ø—É—Å–∫ Nginx —Å SSL..."
            cd /root/ad_service/
            
            echo "–ó–∞–ø—É—Å–∫ Nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            docker-compose up -d nginx
            
            echo "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ Nginx..."
            sleep 10
            
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
            docker-compose exec nginx nginx -t
            
            echo "–°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:"
            docker-compose ps
            
            echo "‚úÖ Nginx –∑–∞–ø—É—â–µ–Ω"

      # === –ù–ê–°–¢–†–û–ô–ö–ê –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–Ø SSL ===
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSL
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
            
            cat > /root/renew_ssl.sh << 'EOF'
            #!/bin/bash
            echo "$(date): –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
            
            cd /root/ad_service
            docker-compose stop nginx
            
            if certbot renew --standalone --non-interactive; then
                echo "SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
                docker-compose start nginx
                echo "Nginx –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
            else
                echo "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
                docker-compose start nginx
            fi
            EOF
            
            chmod +x /root/renew_ssl.sh
            
            # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ cron (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3:00)
            (crontab -l 2>/dev/null; echo "0 3 * * * /root/renew_ssl.sh >> /var/log/ssl-renewal.log 2>&1") | crontab -
            
            echo "‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"

      # === –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê ===
      - name: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
            cd /root/ad_service/
            
            echo "1. –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker-compose ps
            
            echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
            docker-compose exec -T web python -c "
import os
import django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'ad_service.settings')
django.setup()
from django.db import connection
try:
    connection.ensure_connection()
    print('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î: OK')
except Exception as e:
    print(f'‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: {e}')
"
            
            echo "3. –¢–µ—Å—Ç HTTPS –ª–æ–∫–∞–ª—å–Ω–æ..."
            if curl -f -H "Host: mart.akatosphere.com" https://localhost/ --insecure; then
              echo "‚úÖ HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ!"
            else
              echo "‚ö†Ô∏è  –õ–æ–∫–∞–ª—å–Ω—ã–π HTTPS —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª"
              docker-compose logs nginx --tail 20
            fi
            
            echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –æ—à–∏–±–∫–∏..."
            docker-compose logs web --tail 30 | grep -i error || echo "‚úÖ –û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
            
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"

      - name: –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç —Å GitHub runner
        run: |
          echo "üåê –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞..."
          sleep 30
          
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ https://mart.akatosphere.com..."
          for i in {1..3}; do
            echo "–ü–æ–ø—ã—Ç–∫–∞ $i/3..."
            if curl -f https://mart.akatosphere.com/ --max-time 30; then
              echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞!"
              exit 0
            else
              echo "‚è≥ –°–∞–π—Ç –µ—â–µ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∂–¥–µ–º 10 —Å–µ–∫—É–Ω–¥..."
              sleep 10
            fi
          done
          
          echo "‚ö†Ô∏è  –°–∞–π—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è"
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: docker-compose logs"