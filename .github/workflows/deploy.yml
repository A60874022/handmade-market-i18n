name: Deploy Ad Service with SSL

on:
  push:
    branches: [ master ]

jobs:
  build_and_push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: anton60874022/ad_service:latest

  deploy:
    name: Deploy to Server with SSL
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # === –°–û–ó–î–ê–ù–ò–ï .env –§–ê–ô–õ–ê ===
      - name: Create .env file from secrets
        run: |
          echo "üîß Creating .env file from GitHub Secrets..."
          cat > .env << EOF
          # Django
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=${{ secrets.DEBUG }}
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          
          # Database
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          
          # Redis
          REDIS_URL=${{ secrets.REDIS_URL }}
          
          # Email
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          EMAIL_USE_TLS=${{ secrets.EMAIL_USE_TLS }}
          EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}
          EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}
          DEFAULT_FROM_EMAIL=${{ secrets.EMAIL_HOST_USER }}
          
          # Security
          CSRF_TRUSTED_ORIGINS=${{ secrets.CSRF_TRUSTED_ORIGINS }}
          
          # SSL Certificates
          CERTBOT_EMAIL=${{ secrets.CERTBOT_EMAIL }}
          DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}
          EOF
          
          echo "‚úÖ .env file created"

      - name: Install Docker Compose on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üì¶ Checking Docker Compose..."
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing Docker Compose..."
              curl -SL https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
            fi
            docker-compose --version

      - name: Create deploy.sh script on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üìù Creating deploy.sh script..."
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            mkdir -p /root/ad_service
            
            # –°–æ–∑–¥–∞–µ–º deploy.sh —Å–∫—Ä–∏–ø—Ç
            cat > /root/ad_service/deploy.sh << 'EOF'
            #!/bin/bash
            set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è..."
            echo "========================================"
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /root/ad_service/infra
            
            # 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
            echo "1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker-compose down --remove-orphans 2>/dev/null || true
            
            # 2. –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—Ä–∞–∑—ã
            echo "2. –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ Docker –æ–±—Ä–∞–∑—ã..."
            docker-compose pull
            
            # 3. –ó–∞–ø—É—Å–∫–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, Redis –∏ Django (–±–µ–∑ nginx)
            echo "3. –ó–∞–ø—É—Å–∫–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, Redis –∏ Django..."
            docker-compose up -d db redis web
            
            # 4. –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ Django
            echo "4. –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ Django (30 —Å–µ–∫—É–Ω–¥)..."
            sleep 30
            
            # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ª–∏ Django
            if docker-compose ps web 2>/dev/null | grep -q "Up"; then
                echo "‚úÖ Django —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
            else
                echo "‚ùå Django –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
                docker-compose logs web --tail=20
                exit 1
            fi
            
            # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
            CERT_PATH="./certbot/conf/live/$DOMAIN_NAME/fullchain.pem"
            if [ -f "$CERT_PATH" ]; then
                echo "6. SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º SSL –∫–æ–Ω—Ñ–∏–≥"
                cp ./nginx/conf.d/django-ssl.conf ./nginx/conf.d/default.conf 2>/dev/null || echo "‚ö†Ô∏è SSL –∫–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º HTTP"
            else
                echo "6. SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º HTTP –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –∏—Ö –ø–æ–ª—É—á–µ–Ω–∏—è"
                cp ./nginx/conf.d/django.conf ./nginx/conf.d/default.conf 2>/dev/null || echo "‚ö†Ô∏è HTTP –∫–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
            
            # 7. –ó–∞–ø—É—Å–∫–∞–µ–º nginx
            echo "7. –ó–∞–ø—É—Å–∫–∞–µ–º nginx..."
            docker-compose up -d nginx
            
            # 8. –ï—Å–ª–∏ –Ω–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ - –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏—Ö
            if [ ! -f "$CERT_PATH" ]; then
                echo "8. –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã..."
                
                # –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
                mkdir -p ./certbot/www ./certbot/conf
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ –¥–æ–º–µ–Ω
                echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–æ–º–µ–Ω–∞ $DOMAIN_NAME..."
                if nslookup $DOMAIN_NAME 2>/dev/null | grep -q "address"; then
                    echo "‚úÖ –î–æ–º–µ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–ª—É—á–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã..."
                    
                    # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑ certbot –Ω–∞ —Ö–æ—Å—Ç–µ
                    certbot certonly --standalone \
                      -d $DOMAIN_NAME \
                      -d www.$DOMAIN_NAME \
                      --non-interactive \
                      --agree-tos \
                      --email $CERTBOT_EMAIL \
                      --preferred-challenges http \
                      --http-01-port 80 || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã"
                    
                    # –ï—Å–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã - –∫–æ–ø–∏—Ä—É–µ–º –∏—Ö
                    if [ -f "/etc/letsencrypt/live/$DOMAIN_NAME/fullchain.pem" ]; then
                        echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã, –∫–æ–ø–∏—Ä—É–µ–º..."
                        mkdir -p ./certbot/conf/live/$DOMAIN_NAME
                        cp /etc/letsencrypt/live/$DOMAIN_NAME/fullchain.pem ./certbot/conf/live/$DOMAIN_NAME/
                        cp /etc/letsencrypt/live/$DOMAIN_NAME/privkey.pem ./certbot/conf/live/$DOMAIN_NAME/
                        
                        # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ SSL –∫–æ–Ω—Ñ–∏–≥
                        if [ -f "./nginx/conf.d/django-ssl.conf" ]; then
                            cp ./nginx/conf.d/django-ssl.conf ./nginx/conf.d/default.conf
                            docker-compose restart nginx
                            echo "üéâ SSL –Ω–∞—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
                        fi
                    else
                        echo "‚ö†Ô∏è –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã. –°–∞–π—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ HTTP."
                        echo "–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è SSL —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:"
                        echo "1. –î–æ–º–µ–Ω $DOMAIN_NAME —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞"
                        echo "2. –ü–æ—Ä—Ç 80 –æ—Ç–∫—Ä—ã—Ç –≤ —Ñ–∞–µ—Ä–≤–æ–ª–µ"
                        echo "3. Email –≤ .env —Ñ–∞–π–ª–µ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
                    fi
                else
                    echo "‚ùå –î–æ–º–µ–Ω $DOMAIN_NAME –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. SSL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω."
                fi
            fi
            
            # 9. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "========================================"
            echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
            docker-compose ps 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
            
            # 10. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏ nginx –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            echo "========================================"
            echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ nginx:"
            docker-compose logs nginx --tail=20 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ nginx"
            
            echo "========================================"
            echo "üéâ –ü—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è –∑–∞–≤–µ—Ä—à–µ–Ω!"
            echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç –ø–æ –∞–¥—Ä–µ—Å—É: https://$DOMAIN_NAME"
            echo "üîß –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx: docker-compose exec nginx nginx -t"
            EOF
            
            # –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
            chmod +x /root/ad_service/deploy.sh
            echo "‚úÖ deploy.sh —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

      - name: Clean server and setup directories
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üßπ Cleaning server..."
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –µ—Å–ª–∏ –µ—Å—Ç—å
            if [ -d "/root/ad_service" ]; then
              cd /root/ad_service
              docker-compose down 2>/dev/null || true
            fi
            
            # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
            echo "Removing project containers..."
            docker ps -a --filter "name=handmade" --format "{{.Names}}" | xargs -r docker rm -f 2>/dev/null || true
            
            # –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞
            docker images --filter "reference=anton60874022/ad_service" --format "{{.ID}}" | xargs -r docker rmi -f 2>/dev/null || true
            
            echo "Cleaning unused Docker resources..."
            docker system prune -f 2>/dev/null || true
            
            echo "Recreating project directory..."
            rm -rf /root/ad_service/infra 2>/dev/null || true
            mkdir -p /root/ad_service/infra
            mkdir -p /root/ad_service/infra/nginx/conf.d
            mkdir -p /root/ad_service/logs
            mkdir -p /root/ad_service/logs/nginx
            mkdir -p /root/ad_service/certbot/conf
            mkdir -p /root/ad_service/certbot/www
            
            echo "‚úÖ Server prepared"

      - name: Copy infrastructure files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "infra/"
          target: "/root/ad_service/infra/"
          overwrite: true
          strip_components: 1

      - name: Copy .env to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: ".env"
          target: "/root/ad_service/infra/"
          overwrite: true

      - name: Setup nginx config directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üìÅ Setting up nginx configs..."
            cd /root/ad_service/infra
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤
            if [ -f "nginx/conf.d/django.conf" ]; then
                echo "‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥ nginx –Ω–∞–π–¥–µ–Ω"
            else
                echo "‚ö†Ô∏è –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥ nginx –Ω–µ –Ω–∞–π–¥–µ–Ω"
                # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
                cat > nginx/conf.d/django.conf << 'EOF'
                upstream django {
                    server web:8000;
                }
                
                server {
                    listen 80;
                    server_name $DOMAIN_NAME www.$DOMAIN_NAME;
                    
                    location / {
                        proxy_pass http://django;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                    }
                    
                    location /static/ {
                        alias /app/staticfiles/;
                    }
                    
                    location /media/ {
                        alias /app/media/;
                    }
                }
                EOF
            fi
            
            # –°–æ–∑–¥–∞–µ–º SSL –∫–æ–Ω—Ñ–∏–≥ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if [ ! -f "nginx/conf.d/django-ssl.conf" ]; then
                cat > nginx/conf.d/django-ssl.conf << 'EOF'
                upstream django {
                    server web:8000;
                }
                
                server {
                    listen 443 ssl http2;
                    server_name $DOMAIN_NAME www.$DOMAIN_NAME;

                    ssl_certificate /etc/letsencrypt/live/$DOMAIN_NAME/fullchain.pem;
                    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN_NAME/privkey.pem;

                    ssl_protocols TLSv1.2 TLSv1.3;
                    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
                    
                    location / {
                        proxy_pass http://django;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                    }
                    
                    location /static/ {
                        alias /app/staticfiles/;
                    }
                    
                    location /media/ {
                        alias /app/media/;
                    }
                }
                
                server {
                    listen 80;
                    server_name $DOMAIN_NAME www.$DOMAIN_NAME;
                    return 301 https://$server_name$request_uri;
                }
                EOF
            fi

      - name: Ensure ports are free
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîß Ensuring ports 80 and 443 are free..."
            systemctl stop nginx 2>/dev/null || true
            systemctl stop apache2 2>/dev/null || true
            
            # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç—ã
            for port in 80 443; do
              pid=$(lsof -ti :$port 2>/dev/null || true)
              if [ ! -z "$pid" ]; then
                echo "Killing process $pid on port $port"
                kill -9 $pid 2>/dev/null || true
              fi
            done

      - name: Install Certbot
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üîê Installing Certbot..."
            
            apt-get update
            apt-get install -y certbot python3-certbot-nginx
            
            echo "‚úÖ Certbot installed"

      - name: Run deploy script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üöÄ Running deploy script..."
            cd /root/ad_service
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
            if [ -f "infra/.env" ]; then
                export $(grep -v '^#' infra/.env | xargs)
                echo "‚úÖ .env variables loaded"
            else
                echo "‚ö†Ô∏è .env file not found"
            fi
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º deploy.sh
            ./deploy.sh
            
            echo "‚úÖ Deploy script completed"

      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîç Verifying deployment..."
            cd /root/ad_service/infra
            
            echo "1. Container status:"
            docker-compose ps 2>/dev/null || echo "Docker compose not available"
            
            echo "2. Testing web service..."
            if docker-compose ps web 2>/dev/null | grep -q "Up"; then
                echo "‚úÖ Web service is running"
            else
                echo "‚ùå Web service is not running"
                docker-compose logs web --tail=20 2>/dev/null || true
            fi
            
            echo "3. Testing nginx..."
            if docker-compose ps nginx 2>/dev/null | grep -q "Up"; then
                echo "‚úÖ Nginx is running"
                docker-compose exec nginx nginx -t 2>/dev/null && echo "‚úÖ Nginx config is valid"
            else
                echo "‚ùå Nginx is not running"
            fi
            
            echo "4. Checking SSL certificates..."
            if [ -f "certbot/conf/live/$DOMAIN_NAME/fullchain.pem" ]; then
                echo "‚úÖ SSL certificates found"
            else
                echo "‚ö†Ô∏è SSL certificates not found (running on HTTP)"
            fi
            
            echo "‚úÖ Verification completed!"