name: Deploy Ad Service with SSL and Diagnostics

on:
  push:
    branches: [ master ]

jobs:
  build_and_push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: anton60874022/ad_service:latest

  deploy:
    name: Deploy to Server with Diagnostics
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # === –°–û–ó–î–ê–ù–ò–ï .env –§–ê–ô–õ–ê –ù–ê GITHUB RUNNER ===
      - name: Create .env file from secrets
        run: |
          echo "üîß Creating .env file from GitHub Secrets..."
          cat > .env << EOF
          # Django
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=True
          ALLOWED_HOSTS=localhost,127.0.0.1,72.56.82.4,mart.akatosphere.com,www.mart.akatosphere.com
          
          # Database
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          
          # Redis
          REDIS_URL=redis://redis:6379
          
          # Email (Mail.ru)
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          EMAIL_USE_TLS=${{ secrets.EMAIL_USE_TLS }}
          EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}
          EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}
          DEFAULT_FROM_EMAIL=${{ secrets.EMAIL_HOST_USER }}
          
          # Security (–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
          CSRF_TRUSTED_ORIGINS=https://mart.akatosphere.com,https://www.mart.akatosphere.com
          EOF
          
          echo "‚úÖ .env file created"
          echo "=== CHECKING .env FILE ==="
          cat .env
          echo "=========================="

      - name: Install Docker Compose on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üì¶ Installing Docker Compose..."
            
            if command -v docker-compose &> /dev/null; then
              echo "‚úÖ Docker Compose already installed"
              docker-compose --version
            else
              echo "Installing Docker Compose..."
              curl -SL https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
              echo "‚úÖ Docker Compose installed successfully"
              docker-compose --version
            fi

      - name: Clean server and setup directories (preserve DB)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üßπ Cleaning server (preserving database)..."
            cd /root
            
            echo "Stopping and removing application containers..."
            docker stop handmade_web handmade_nginx redis 2>/dev/null || true
            docker rm handmade_web handmade_nginx redis 2>/dev/null || true
            
            echo "Removing unused Docker resources..."
            docker system prune -f || true
            
            echo "Checking database volume..."
            docker volume ls | grep postgres_data || echo "Database volume not found (will be created)"
            
            echo "Recreating project directory..."
            rm -rf /root/ad_service
            mkdir -p /root/ad_service/nginx
            mkdir -p /root/ad_service/logs/nginx
            
            echo "‚úÖ Server cleaned (database data preserved)"

      - name: Copy infrastructure files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "infra/"
          target: "/root/ad_service/"
          overwrite: true
          strip_components: 1

      - name: Copy .env to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: ".env"
          target: "/root/ad_service/"
          overwrite: true

      - name: Ensure ports are free
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîß Ensuring ports 80 and 443 are free..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç—ã
            echo "Checking port status:"
            netstat -tulpn | grep -E ':(80|443)' || echo "Ports are free"
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
            systemctl stop nginx 2>/dev/null || echo "nginx was not running"
            systemctl stop apache2 2>/dev/null || echo "apache2 was not running"
            
            echo "‚úÖ Port check completed"

      - name: Deploy application with step-by-step diagnostics
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üöÄ Starting deployment with diagnostics..."
            cd /root/ad_service/
            
            echo "=== PHASE 1: ENVIRONMENT VERIFICATION ==="
            echo "1. Checking .env file..."
            if [ -f .env ]; then
              echo "‚úÖ .env file exists"
              echo "Key variables:"
              grep -E "^(SECRET_KEY|DEBUG|POSTGRES|DB_|REDIS|EMAIL)" .env
            else
              echo "‚ùå .env file not found!"
              exit 1
            fi
            
            echo "2. Verifying docker-compose.yml..."
            if [ -f docker-compose.yml ]; then
              echo "‚úÖ docker-compose.yml exists"
            else
              echo "‚ùå docker-compose.yml not found!"
              exit 1
            fi
            
            echo "=== PHASE 2: DOCKER SETUP ==="
            echo "3. Logging in to Docker Hub..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            echo "4. Pulling latest application image..."
            docker pull anton60874022/ad_service:latest
            
            echo "5. Creating Docker network if needed..."
            docker network create ad_service_backend 2>/dev/null || true
            
            echo "=== PHASE 3: DATABASE AND REDIS ==="
            echo "6. Starting database and redis only..."
            docker-compose up -d db redis
            
            echo "7. Waiting for database to be ready..."
            for i in {1..30}; do
              if docker-compose exec -T db pg_isready -U postgres 2>/dev/null; then
                echo "‚úÖ Database is ready!"
                break
              else
                echo "‚è≥ Waiting for database... ($i/30)"
                sleep 2
              fi
              
              if [ $i -eq 30 ]; then
                echo "‚ùå Database did not become ready in time"
                docker-compose logs db
                exit 1
              fi
            done
            
            echo "=== PHASE 4: WEB CONTAINER DIAGNOSTICS ==="
            echo "8. Testing web container with simple command..."
            echo "Running test container to check Django settings..."
            
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            cat > test_django.py << 'EOF'
            import os
            os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'ad_service.settings')
            try:
                import django
                django.setup()
                from django.conf import settings
                print("‚úÖ Django settings loaded successfully")
                print(f"DEBUG: {settings.DEBUG}")
                print(f"ALLOWED_HOSTS: {settings.ALLOWED_HOSTS}")
                print(f"DATABASE ENGINE: {settings.DATABASES['default']['ENGINE']}")
                print(f"DATABASE NAME: {settings.DATABASES['default']['NAME']}")
                print(f"DATABASE HOST: {settings.DATABASES['default']['HOST']}")
            except Exception as e:
                print(f"‚ùå Django setup failed: {e}")
                import traceback
                traceback.print_exc()
                exit(1)
            EOF
            
            # –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
            docker run --rm --network ad_service_backend \
              --env-file .env \
              -v $(pwd)/test_django.py:/app/test_django.py \
              anton60874022/ad_service:latest \
              python test_django.py
            
            echo "9. Starting web container in test mode..."
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø—Ä–æ—Å—Ç–æ–π –∫–æ–º–∞–Ω–¥–æ–π –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            docker run -d --name web_test \
              --network ad_service_backend \
              --env-file .env \
              anton60874022/ad_service:latest \
              sleep 3600
            
            echo "10. Checking web container status..."
            sleep 5
            if docker ps | grep -q web_test; then
              echo "‚úÖ Web container is running"
              
              echo "11. Testing Django commands inside container..."
              docker exec web_test python manage.py check || {
                echo "‚ùå Django check failed"
                docker logs web_test
                exit 1
              }
              
              echo "12. Running migrations in test container..."
              docker exec web_test python manage.py migrate --noinput || {
                echo "‚ùå Migrations failed"
                docker logs web_test
                exit 1
              }
              
              echo "13. Testing Django shell..."
              docker exec web_test python -c "
              import django
              django.setup()
              from django.contrib.auth import get_user_model
              print('‚úÖ Django shell works')
              "
              
              echo "14. Stopping test container..."
              docker stop web_test
              docker rm web_test
            else
              echo "‚ùå Web container failed to start"
              docker logs web_test 2>/dev/null || true
              exit 1
            fi
            
            echo "=== PHASE 5: FULL DEPLOYMENT ==="
            echo "15. Starting all services with docker-compose..."
            docker-compose up -d web
            
            echo "16. Waiting for web service to stabilize..."
            for i in {1..20}; do
              if docker-compose ps web | grep -q "Up"; then
                echo "‚úÖ Web service is running"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
                RESTART_COUNT=$(docker inspect handmade_web --format='{{.RestartCount}}')
                if [ "$RESTART_COUNT" -gt 0 ]; then
                  echo "‚ö†Ô∏è  Container has restarted $RESTART_COUNT times"
                  docker-compose logs web --tail 50
                fi
                break
              else
                echo "‚è≥ Waiting for web service... ($i/20)"
                sleep 3
              fi
            done
            
            echo "17. Checking web service logs..."
            docker-compose logs web --tail 20
            
            echo "18. Running final migrations..."
            docker-compose exec -T web python manage.py migrate --noinput
            
            echo "19. Collecting static files..."
            docker-compose exec -T web python manage.py collectstatic --noinput
            
            echo "20. Creating superuser if not exists..."
            docker-compose exec -T web python -c "
            import os
            import django
            os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'ad_service.settings')
            django.setup()
            from django.contrib.auth import get_user_model
            User = get_user_model()
            if not User.objects.filter(username='admin').exists():
                User.objects.create_superuser('admin', 'admin@example.com', 'admin123')
                print('‚úÖ Superuser created')
            else:
                print('‚úÖ Superuser already exists')
            "
            
            echo "‚úÖ Application deployment completed successfully!"

      - name: Install Certbot and obtain SSL certificate
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üîê Installing Certbot and obtaining SSL certificate..."
            
            apt-get update
            apt-get install -y certbot
            
            echo "Stopping nginx to free port 80..."
            docker-compose stop nginx 2>/dev/null || true
            
            echo "Obtaining SSL certificate using standalone method..."
            certbot certonly --standalone \
              -d mart.akatosphere.com \
              -d www.mart.akatosphere.com \
              --non-interactive \
              --agree-tos \
              --email anton60874022@mail.ru \
              --preferred-challenges http \
              --http-01-port 80
            
            echo "‚úÖ SSL certificate obtained successfully!"
            
            echo "Checking certificate files..."
            ls -la /etc/letsencrypt/live/mart.akatosphere.com/

      - name: Deploy nginx with SSL configuration
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üöÄ Deploying nginx with SSL configuration..."
            cd /root/ad_service/
            
            echo "1. Checking nginx configuration..."
            docker-compose config
            
            echo "2. Starting nginx container..."
            docker-compose up -d nginx
            
            echo "3. Waiting for nginx to start..."
            sleep 10
            
            echo "4. Testing nginx configuration..."
            docker-compose exec nginx nginx -t
            
            echo "5. Checking all services status..."
            docker-compose ps
            
            echo "6. Testing application through nginx..."
            curl -f -H "Host: mart.akatosphere.com" http://localhost/ --insecure || {
              echo "‚ö†Ô∏è  HTTP test failed, checking logs..."
              docker-compose logs nginx --tail 20
              docker-compose logs web --tail 20
            }
            
            echo "‚úÖ Nginx deployment completed!"

      - name: Setup SSL certificate auto-renewal
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîÑ Setting up SSL certificate auto-renewal..."
            
            cat > /root/renew_ssl.sh << 'EOF'
            #!/bin/bash
            echo "$(date): Starting SSL certificate renewal..."
            
            cd /root/ad_service
            docker-compose stop nginx
            
            if certbot renew --standalone --non-interactive; then
                echo "SSL certificates renewed successfully"
                docker-compose start nginx
                echo "Nginx restarted with new certificates"
            else
                echo "SSL certificate renewal failed"
                docker-compose start nginx
            fi
            EOF
            
            chmod +x /root/renew_ssl.sh
            
            (crontab -l 2>/dev/null; echo "0 3 * * * /root/renew_ssl.sh >> /var/log/ssl-renewal.log 2>&1") | crontab -
            
            echo "‚úÖ SSL auto-renewal configured!"

      - name: Final verification and tests
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîç Final deployment verification..."
            cd /root/ad_service/
            
            echo "1. Container status:"
            docker-compose ps
            
            echo "2. Testing Django health endpoint..."
            docker-compose exec -T web python -c "
            import os
            os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'ad_service.settings')
            import django
            django.setup()
            from django.db import connection
            try:
                connection.ensure_connection()
                print('‚úÖ Database connection: OK')
            except Exception as e:
                print(f'‚ùå Database connection failed: {e}')
            "
            
            echo "3. Testing email functionality..."
            docker-compose exec -T web python -c "
            import os
            os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'ad_service.settings')
            import django
            django.setup()
            from django.core.mail import send_mail
            from django.conf import settings
            
            print(f'EMAIL_HOST: {settings.EMAIL_HOST}')
            print(f'EMAIL_PORT: {settings.EMAIL_PORT}')
            print(f'EMAIL_HOST_USER: {settings.EMAIL_HOST_USER}')
            
            try:
                send_mail(
                    'Deployment Test Email',
                    'This is a test email from the deployed application.',
                    settings.DEFAULT_FROM_EMAIL,
                    ['anton60874022@mail.ru'],
                    fail_silently=False,
                )
                print('‚úÖ Test email sent successfully!')
            except Exception as e:
                print(f'‚ö†Ô∏è  Email test failed (but deployment continues): {e}')
            "
            
            echo "4. Testing HTTPS accessibility locally..."
            if curl -f -H "Host: mart.akatosphere.com" https://localhost/ --insecure; then
              echo "‚úÖ HTTPS is working locally!"
            else
              echo "‚ö†Ô∏è  Local HTTPS test failed"
              docker-compose logs nginx --tail 30
            fi
            
            echo "5. Checking application logs for errors..."
            docker-compose logs web --tail 20 | grep -i error || echo "‚úÖ No errors found in recent logs"
            
            echo "üéâ Deployment verification complete!"

      - name: Final HTTPS test from runner
        run: |
          echo "üîç Testing HTTPS from GitHub runner..."
          sleep 30  # –î–∞–µ–º –≤—Ä–µ–º—è DNS –∏ —Å–µ—Ä–≤–∏—Å–∞–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
          
          echo "Testing HTTPS domain accessibility..."
          MAX_RETRIES=5
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            if curl -f https://mart.akatosphere.com/ --max-time 30; then
              echo "‚úÖ HTTPS domain is accessible from internet"
              exit 0
            else
              echo "‚ö†Ô∏è  Domain not accessible yet, retrying in 10 seconds..."
              sleep 10
            fi
          done
          
          echo "‚ö†Ô∏è  Domain might not be fully accessible yet (this is common immediately after deployment)"
          echo "The deployment completed successfully on the server. Domain propagation may take some time."