name: Deploy Ad Service with SSL

on:
  push:
    branches: [ master ]

jobs:
  build_and_push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build and push
        run: |
          docker build -t anton60874022/ad_service:latest .
          docker push anton60874022/ad_service:latest

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "üîß Creating .env file..."
          echo "# Django" > .env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "DEBUG=${{ secrets.DEBUG }}" >> .env
          echo "ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}" >> .env
          echo "" >> .env
          echo "# Database" >> .env
          echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
          echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env
          echo "" >> .env
          echo "# Redis" >> .env
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env
          echo "" >> .env
          echo "# Email" >> .env
          echo "EMAIL_HOST=${{ secrets.EMAIL_HOST }}" >> .env
          echo "EMAIL_PORT=${{ secrets.EMAIL_PORT }}" >> .env
          echo "EMAIL_USE_TLS=${{ secrets.EMAIL_USE_TLS }}" >> .env
          echo "EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}" >> .env
          echo "EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}" >> .env
          echo "DEFAULT_FROM_EMAIL=${{ secrets.EMAIL_HOST_USER }}" >> .env
          echo "" >> .env
          echo "# Security" >> .env
          echo "CSRF_TRUSTED_ORIGINS=${{ secrets.CSRF_TRUSTED_ORIGINS }}" >> .env
          echo "" >> .env
          echo "# SSL" >> .env
          echo "CERTBOT_EMAIL=${{ secrets.CERTBOT_EMAIL }}" >> .env
          echo "DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}" >> .env
          echo "‚úÖ .env file created"

      # ========== –û–°–ù–û–í–ù–´–ï –®–ê–ì–ò –î–ï–ü–õ–û–Ø ==========
      - name: Clean old containers
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üßπ Cleaning old containers..."
            docker stop handmade_web handmade_nginx handmade_db handmade_redis 2>/dev/null || true
            docker rm handmade_web handmade_nginx handmade_db handmade_redis 2>/dev/null || true
            echo "‚úÖ Old containers cleaned"

      - name: Create directories
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üìÅ Creating directories..."
            mkdir -p /root/ad_service
            mkdir -p /root/ad_service/nginx/conf.d
            mkdir -p /root/ad_service/logs
            mkdir -p /root/ad_service/certbot/conf
            mkdir -p /root/ad_service/certbot/www
            echo "‚úÖ Directories created"

      - name: Copy docker-compose.yml
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "infra/docker-compose.yml"
          target: "/root/ad_service/"
          overwrite: true

      - name: Copy nginx configs
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "infra/nginx/"
          target: "/root/ad_service/"
          overwrite: true
          strip_components: 1

      - name: Copy .env file
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: ".env"
          target: "/root/ad_service/"
          overwrite: true

      - name: Create basic nginx config if missing
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîß Creating basic nginx config..."
            cd /root/ad_service
            
            if [ ! -f "nginx/conf.d/django.conf" ]; then
              echo 'upstream django {' > nginx/conf.d/django.conf
              echo '    server web:8000;' >> nginx/conf.d/django.conf
              echo '}' >> nginx/conf.d/django.conf
              echo '' >> nginx/conf.d/django.conf
              echo 'server {' >> nginx/conf.d/django.conf
              echo '    listen 80;' >> nginx/conf.d/django.conf
              echo '    server_name mart.akatosphere.com www.mart.akatosphere.com;' >> nginx/conf.d/django.conf
              echo '' >> nginx/conf.d/django.conf
              echo '    location / {' >> nginx/conf.d/django.conf
              echo '        proxy_pass http://django;' >> nginx/conf.d/django.conf
              echo '        proxy_set_header Host $host;' >> nginx/conf.d/django.conf
              echo '        proxy_set_header X-Real-IP $remote_addr;' >> nginx/conf.d/django.conf
              echo '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' >> nginx/conf.d/django.conf
              echo '        proxy_set_header X-Forwarded-Proto $scheme;' >> nginx/conf.d/django.conf
              echo '    }' >> nginx/conf.d/django.conf
              echo '' >> nginx/conf.d/django.conf
              echo '    location /static/ {' >> nginx/conf.d/django.conf
              echo '        alias /app/staticfiles/;' >> nginx/conf.d/django.conf
              echo '    }' >> nginx/conf.d/django.conf
              echo '' >> nginx/conf.d/django.conf
              echo '    location /media/ {' >> nginx/conf.d/django.conf
              echo '        alias /app/media/;' >> nginx/conf.d/django.conf
              echo '    }' >> nginx/conf.d/django.conf
              echo '}' >> nginx/conf.d/django.conf
              echo "‚úÖ Basic nginx config created"
            else
              echo "‚úÖ Nginx config already exists"
            fi

      - name: Stop system nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üõë Stopping system nginx..."
            systemctl stop nginx 2>/dev/null || true
            echo "‚úÖ System nginx stopped"

      - name: Pull and start services
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üöÄ Starting services..."
            cd /root/ad_service
            
            echo "Logging in to Docker Hub..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            echo "Pulling images..."
            docker pull anton60874022/ad_service:latest
            docker pull postgres:15-alpine
            docker pull redis:7-alpine
            docker pull nginx:alpine
            
            echo "Starting services..."
            docker-compose up -d
            
            echo "Waiting for services to start..."
            sleep 30
            
            echo "‚úÖ Services started"
            docker-compose ps

      - name: Install Certbot
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîê Installing Certbot..."
            apt-get update
            apt-get install -y certbot python3-certbot-nginx
            echo "‚úÖ Certbot installed"

      - name: Get SSL certificate
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üìú Getting SSL certificate..."
            cd /root/ad_service
            
            docker-compose stop nginx 2>/dev/null || true
            
            certbot certonly --standalone \
              -d mart.akatosphere.com \
              -d www.mart.akatosphere.com \
              --non-interactive \
              --agree-tos \
              --email ${{ secrets.CERTBOT_EMAIL }} \
              --preferred-challenges http \
              --http-01-port 80
            
            echo "‚úÖ SSL certificate obtained!"
            
            mkdir -p /root/ad_service/certbot/conf/live/mart.akatosphere.com
            cp /etc/letsencrypt/live/mart.akatosphere.com/fullchain.pem /root/ad_service/certbot/conf/live/mart.akatosphere.com/
            cp /etc/letsencrypt/live/mart.akatosphere.com/privkey.pem /root/ad_service/certbot/conf/live/mart.akatosphere.com/

      - name: Update nginx config for SSL
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîß Updating nginx config for SSL..."
            cd /root/ad_service
            
            echo 'upstream django {' > nginx/conf.d/django-ssl.conf
            echo '    server web:8000;' >> nginx/conf.d/django-ssl.conf
            echo '}' >> nginx/conf.d/django-ssl.conf
            echo '' >> nginx/conf.d/django-ssl.conf
            echo 'server {' >> nginx/conf.d/django-ssl.conf
            echo '    listen 443 ssl http2;' >> nginx/conf.d/django-ssl.conf
            echo '    server_name mart.akatosphere.com www.mart.akatosphere.com;' >> nginx/conf.d/django-ssl.conf
            echo '' >> nginx/conf.d/django-ssl.conf
            echo '    ssl_certificate /etc/letsencrypt/live/mart.akatosphere.com/fullchain.pem;' >> nginx/conf.d/django-ssl.conf
            echo '    ssl_certificate_key /etc/letsencrypt/live/mart.akatosphere.com/privkey.pem;' >> nginx/conf.d/django-ssl.conf
            echo '' >> nginx/conf.d/django-ssl.conf
            echo '    ssl_protocols TLSv1.2 TLSv1.3;' >> nginx/conf.d/django-ssl.conf
            echo '    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;' >> nginx/conf.d/django-ssl.conf
            echo '' >> nginx/conf.d/django-ssl.conf
            echo '    location / {' >> nginx/conf.d/django-ssl.conf
            echo '        proxy_pass http://django;' >> nginx/conf.d/django-ssl.conf
            echo '        proxy_set_header Host $host;' >> nginx/conf.d/django-ssl.conf
            echo '        proxy_set_header X-Real-IP $remote_addr;' >> nginx/conf.d/django-ssl.conf
            echo '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' >> nginx/conf.d/django-ssl.conf
            echo '        proxy_set_header X-Forwarded-Proto $scheme;' >> nginx/conf.d/django-ssl.conf
            echo '    }' >> nginx/conf.d/django-ssl.conf
            echo '' >> nginx/conf.d/django-ssl.conf
            echo '    location /static/ {' >> nginx/conf.d/django-ssl.conf
            echo '        alias /app/staticfiles/;' >> nginx/conf.d/django-ssl.conf
            echo '    }' >> nginx/conf.d/django-ssl.conf
            echo '' >> nginx/conf.d/django-ssl.conf
            echo '    location /media/ {' >> nginx/conf.d/django-ssl.conf
            echo '        alias /app/media/;' >> nginx/conf.d/django-ssl.conf
            echo '    }' >> nginx/conf.d/django-ssl.conf
            echo '}' >> nginx/conf.d/django-ssl.conf
            echo '' >> nginx/conf.d/django-ssl.conf
            echo 'server {' >> nginx/conf.d/django-ssl.conf
            echo '    listen 80;' >> nginx/conf.d/django-ssl.conf
            echo '    server_name mart.akatosphere.com www.mart.akatosphere.com;' >> nginx/conf.d/django-ssl.conf
            echo '    return 301 https://$server_name$request_uri;' >> nginx/conf.d/django-ssl.conf
            echo '}' >> nginx/conf.d/django-ssl.conf
            
            mv nginx/conf.d/django.conf nginx/conf.d/django.conf.backup
            mv nginx/conf.d/django-ssl.conf nginx/conf.d/django.conf
            
            docker-compose restart nginx
            
            echo "‚úÖ SSL configured"

      - name: Final verification
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "üîç Final verification..."
            cd /root/ad_service
            
            echo "1. Container status:"
            docker-compose ps
            
            echo ""
            echo "2. Testing nginx config..."
            docker-compose exec nginx nginx -t || echo "Nginx config test failed"
            
            echo ""
            echo "3. Logs (last 10 lines):"
            docker-compose logs --tail=10
            
            echo ""
            echo "üéâ Deployment completed!"