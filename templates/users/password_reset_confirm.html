{% extends "users/base_auth.html" %}
{% load static i18n %}

{% block title %}{% trans "Enter New Password" %}{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <h2 class="fw-bold">{% trans "Enter New Password" %}</h2>
    <p class="text-muted">{% trans "Choose a secure password for your account" %}</p>
</div>

<!-- System messages (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}

{% if validlink %}
<form method="POST" id="passwordResetForm" novalidate>
    {% csrf_token %}

    <!-- New password -->
    <div class="mb-3">
        <label for="id_new_password1" class="form-label">{% trans "New Password" %}</label>
        <div class="input-group">
            <input type="password" name="new_password1" id="id_new_password1" class="form-control password-input"
                placeholder="{% trans 'Create a strong password' %}" required autocomplete="new-password" minlength="8">
            <button type="button" class="btn btn-outline-secondary toggle-password" data-target="id_new_password1"
                aria-label="{% trans 'Toggle password visibility' %}">
                <span class="eye-icon">üëÅÔ∏è</span>
            </button>
        </div>
        <div class="form-text mt-1">
            {% trans "Password requirements: at least 8 characters, a mix of upper and lower case letters, numbers and symbols." %}
        </div>
    </div>

    <!-- Password confirmation -->
    <div class="mb-3">
        <label for="id_new_password2" class="form-label">{% trans "Confirm New Password" %}</label>
        <div class="input-group">
            <input type="password" name="new_password2" id="id_new_password2" class="form-control password-input"
                placeholder="{% trans 'Repeat your password' %}" required autocomplete="new-password" minlength="8">
            <button type="button" class="btn btn-outline-secondary toggle-password" data-target="id_new_password2"
                aria-label="{% trans 'Toggle password visibility' %}">
                <span class="eye-icon">üëÅÔ∏è</span>
            </button>
        </div>
        <!-- –º–µ—Å—Ç–æ –¥–ª—è –æ—à–∏–±–∫–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è/–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ -->
        <!-- –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ invalid-feedback –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ -->
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–ª—ã –ø–∞—Ä–æ–ª—è (—Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ JS) -->
    <!-- –º–µ—Å—Ç–æ —Ä–µ–∑–µ—Ä–≤–∞ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–æ—è–≤–∏—Ç—Å—è —Ä—è–¥–æ–º —Å –ø–µ—Ä–≤—ã–º –ø–æ–ª–µ–º -->

    <div class="alert alert-info mb-4">
        <div class="d-flex">
            <div class="me-3">üîê</div>
            <div>
                <strong>{% trans "Password safety tips" %}</strong><br>
                {% trans "Use a unique password for this account and avoid common words." %}
            </div>
        </div>
    </div>

    <button type="submit" class="btn btn-primary w-100 py-2 mb-3 fw-bold">{% trans "Update Password" %}</button>

    <div class="text-center">
        <a href="{% url 'users:login' %}" class="text-decoration-none">{% trans "Back to login" %}</a>
    </div>
</form>

<!-- –°—Ç–∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–æ —Å—Ç–∏–ª–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<style>
    .input-group {
        position: relative;
        display: flex;
        align-items: stretch;
        width: 100%;
    }

    .input-group .form-control {
        position: relative;
        flex: 1 1 auto;
        width: 1%;
        min-width: 0;
        border-right: none;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }

    .input-group .btn {
        border-left: none;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.375rem 0.75rem;
        background-color: #f8f9fa;
        border-color: #ced4da;
        transition: all 0.15s ease-in-out;
    }

    .input-group .btn:hover {
        background-color: #e9ecef;
        border-color: #ced4da;
    }

    .input-group .btn:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        z-index: 3;
    }

    .eye-icon {
        font-size: 0.9rem;
        transition: opacity 0.2s ease;
    }

    .password-visible .eye-icon {
        opacity: 0.7;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–ª—ã –ø–∞—Ä–æ–ª—è */
    .password-strength {
        margin-top: 0.25rem;
        font-size: 0.875rem;
    }

    .strength-bar {
        height: 3px;
        border-radius: 2px;
        transition: all 0.3s ease;
    }

    .strength-weak {
        width: 33%;
        background-color: #dc3545;
    }

    .strength-medium {
        width: 66%;
        background-color: #ffc107;
    }

    .strength-strong {
        width: 100%;
        background-color: #198754;
    }

    /* Bootstrap-like invalid style */
    .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.125rem rgba(220, 53, 69, .15) !important;
    }

    @media (max-width: 576px) {
        .input-group .btn {
            padding: 0.375rem 0.5rem;
            min-width: 50px;
        }

        .eye-icon {
            font-size: 0.8rem;
        }
    }
</style>

<!-- –°–∫—Ä–∏–ø—Ç: –ª–æ–≥–∏–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏, –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–ª—ã, –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ submit -->
<script>
    // –ü–µ—Ä–µ–≤–æ–¥—ã –∫–∞–∫ –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º –∫–æ–¥–µ
    const TRANSLATIONS = {
        passwordStrength: "{% trans 'Password strength' %}",
        weak: "{% trans 'Weak' %}",
        medium: "{% trans 'Medium' %}",
        strong: "{% trans 'Strong' %}",
        passwordsNoMatch: "{% trans 'Passwords do not match' %}",
        passwordRequirements: "{% trans 'At least 8 characters, upper & lower case, number and symbol' %}"
    };

    (function () {
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const form = document.getElementById('passwordResetForm');
        const pw1 = document.getElementById('id_new_password1');
        const pw2 = document.getElementById('id_new_password2');

        if (!form || !pw1 || !pw2) return;

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è (–∫–∞–∫ –≤ registration-template)
        function togglePasswordVisibility(button) {
            const targetId = button.getAttribute('data-target');
            const passwordInput = document.getElementById(targetId);

            if (!passwordInput) return;

            const isPasswordVisible = passwordInput.type === 'text';
            passwordInput.type = isPasswordVisible ? 'password' : 'text';

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∏ –∫–ª–∞—Å—Å
            const eyeIcon = button.querySelector('.eye-icon');
            if (eyeIcon) {
                if (isPasswordVisible) {
                    eyeIcon.textContent = 'üëÅÔ∏è';
                    button.classList.remove('password-visible');
                } else {
                    eyeIcon.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                    button.classList.add('password-visible');
                }
            }

            // –§–æ–∫—É—Å–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            passwordInput.focus();

            // –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
            button.style.transform = 'scale(0.97)';
            setTimeout(() => { button.style.transform = ''; }, 120);
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –Ω–∞ –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                togglePasswordVisibility(this);
            });

            button.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    togglePasswordVisibility(this);
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–ª—ã –ø–∞—Ä–æ–ª—è (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ –ª–æ–≥–∏–∫–µ –∏–∑ —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞)
        function checkPasswordStrength(password) {
            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            return strength;
        }

        // –°–æ–∑–¥–∞—ë–º UI –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–ª—ã –ø–∞—Ä–æ–ª—è —Ä—è–¥–æ–º —Å –ø–µ—Ä–≤—ã–º –ø–æ–ª–µ–º
        const strengthContainer = document.createElement('div');
        strengthContainer.className = 'password-strength';

        strengthContainer.innerHTML = `
            <div class="d-flex justify-content-between mb-1">
                <small>${TRANSLATIONS.passwordStrength}:</small>
                <small class="strength-text">-</small>
            </div>
            <div class="strength-bar-container bg-light rounded" style="height: 3px;">
                <div class="strength-bar"></div>
            </div>
        `;

        // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ .input-group —Ä–æ–¥–∏—Ç–µ–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—è
        const pw1Wrapper = pw1.parentNode; // .input-group
        if (pw1Wrapper && pw1Wrapper.parentNode) {
            pw1Wrapper.parentNode.appendChild(strengthContainer);
        }

        const strengthBar = strengthContainer.querySelector('.strength-bar');
        const strengthText = strengthContainer.querySelector('.strength-text');

        function updatePasswordStrength() {
            const password = pw1.value;
            const strength = checkPasswordStrength(password);

            if (password.length === 0) {
                strengthBar.className = 'strength-bar';
                strengthBar.style.width = '0%';
                strengthText.textContent = '-';
                strengthText.style.color = '';
                return;
            }

            switch (strength) {
                case 0:
                case 1:
                    strengthBar.className = 'strength-bar strength-weak';
                    strengthBar.style.width = '33%';
                    strengthText.textContent = TRANSLATIONS.weak;
                    strengthText.style.color = '#dc3545';
                    break;
                case 2:
                    strengthBar.className = 'strength-bar strength-medium';
                    strengthBar.style.width = '66%';
                    strengthText.textContent = TRANSLATIONS.medium;
                    strengthText.style.color = '#ffc107';
                    break;
                case 3:
                case 4:
                    strengthBar.className = 'strength-bar strength-strong';
                    strengthBar.style.width = '100%';
                    strengthText.textContent = TRANSLATIONS.strong;
                    strengthText.style.color = '#198754';
                    break;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π (–∏ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ is-invalid/is-valid)
        function checkPasswordMatch() {
            const password = pw1.value;
            const confirmPassword = pw2.value;

            // –µ—Å–ª–∏ –ø–æ–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—É—Å—Ç–æ–µ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
            if (confirmPassword.length === 0) {
                pw2.classList.remove('is-invalid');
                pw2.classList.remove('is-valid');
                return;
            }

            if (password !== confirmPassword) {
                pw2.classList.add('is-invalid');
                pw2.classList.remove('is-valid');
            } else {
                pw2.classList.remove('is-invalid');
                pw2.classList.add('is-valid');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞
        pw1.addEventListener('input', function () {
            updatePasswordStrength();
            checkPasswordMatch();
        });

        pw2.addEventListener('input', function () {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—É—é –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É –ø—Ä–∏ –≤–≤–æ–¥–µ
            const parent = pw2.parentNode;
            const existingErr = parent.querySelector('.password-match-error');
            if (existingErr) {
                existingErr.remove();
            }
            pw2.classList.remove('is-invalid');
            checkPasswordMatch();
        });

        updatePasswordStrength(); // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–Ω–∞ —Å–ª—É—á–∞–π –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è)

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ submit: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∞—Ä–æ–ª—é
        form.addEventListener('submit', function (e) {
            const password = pw1.value;
            const confirmPassword = pw2.value;

            // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (–≤–µ–∑–¥–µ —Å–µ—Ä–≤–µ—Ä –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç)
            const okLength = password.length >= 8;
            const okCase = /[a-z]/.test(password) && /[A-Z]/.test(password);
            const okDigit = /\d/.test(password);
            const okSymbol = /[^A-Za-z0-9]/.test(password);

            // –°–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫
            let errors = [];

            if (!okLength || !okCase || !okDigit || !okSymbol) {
                errors.push(TRANSLATIONS.passwordRequirements || '{% trans "Password does not meet requirements" %}');
            }

            if (password !== confirmPassword) {
                errors.push(TRANSLATIONS.passwordsNoMatch);
            }

            if (errors.length > 0) {
                e.preventDefault();

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Ä—è–¥–æ–º —Å –ø–æ–ª–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–∫–∞–∫ –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º –∫–æ–¥–µ)
                const parent = pw2.parentNode;
                let errorDiv = parent.querySelector('.invalid-feedback.password-match-error');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback password-match-error d-block';
                    parent.appendChild(errorDiv);
                }
                errorDiv.textContent = errors.join(' / ');

                // –ü–æ–¥—Å–≤–µ—Ç–∏–º –ø–æ–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ —Å—Ñ–æ–∫—É—Å–∏—Ä—É–µ–º –Ω–∞ –Ω—ë–º
                pw2.classList.add('is-invalid');
                pw2.focus();

                return false;
            }

            return true; // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º ‚Äî —Å–µ—Ä–≤–µ—Ä –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
        });

        // –∞–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è
        setTimeout(() => {
            try { pw1.focus(); } catch (e) { }
        }, 80);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –∞–ª–µ—Ä—Ç–æ–≤ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ (–∫–∞–∫ –≤ registration)
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                if (alert && alert.classList.contains('show')) {
                    try {
                        const bsAlert = bootstrap.Alert.getInstance(alert);
                        if (bsAlert) {
                            bsAlert.close();
                        }
                    } catch (err) {
                        // –µ—Å–ª–∏ bootstrap –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º
                        try { alert.classList.remove('show'); alert.style.display = 'none'; } catch (_) { }
                    }
                }
            }, 5000);
        });
    })();
</script>

{% else %}
<div class="alert alert-warning">
    {% trans "The password reset link is invalid, possibly because it has already been used. Please request a new password reset." %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}{% endblock %}