{% extends "base.html" %}
{% load static i18n tz %}

{% block title %}
{% if dialogue.product %}
{% blocktrans with title=dialogue.product.title %}Chat about "{{ title }}" | HandmadeMarket{% endblocktrans %}
{% else %}
{% trans "Chat | HandmadeMarket" %}
{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <!-- Product card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">üì¶ {% trans "Product information" %}</h5>

                    {% if dialogue.product %}
                    {% if dialogue.product.images.all %}
                    <img src="{{ dialogue.product.images.first.image.url }}" class="card-img-top rounded mb-3"
                        alt="{{ dialogue.product.title|escape }}" style="height:200px; object-fit:cover;">
                    {% else %}
                    <div class="bg-light rounded d-flex align-items-center justify-content-center mb-3"
                        style="height:200px;">
                        <span class="text-muted" style="font-size:3rem;">üé®</span>
                    </div>
                    {% endif %}

                    <h6 class="fw-bold text-brown">{{ dialogue.product.title }}</h6>
                    <p class="text-muted small mb-2">{{ dialogue.product.description|truncatewords:15 }}</p>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="h5 fw-bold text-brown">{{ dialogue.product.price }} ‚ÇΩ</span>
                        {% if dialogue.product.category %}
                        <span class="badge bg-brown">{{ dialogue.product.category.name }}</span>
                        {% endif %}
                    </div>

                    <div class="d-grid gap-2">
                        {% url 'products:product_detail' dialogue.product.pk as product_url %}
                        <a href="{{ product_url }}" class="btn btn-outline-primary btn-sm">üëÄ {% trans "Go to product"
                            %}</a>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <div class="mb-3" style="font-size:3rem;">‚ùå</div>
                        <h6 class="text-muted fw-bold">{% trans "Product unavailable" %}</h6>
                        <p class="text-muted small mb-0">{% trans "This product was removed or no longer exists." %}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Participants -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">üë• {% trans "Conversation participants" %}</h6>

                    <!-- Current user -->
                    <div class="d-flex align-items-center mb-3 p-2 bg-light rounded">
                        {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" class="rounded-circle me-2"
                            alt="{% trans 'Your avatar' %}" style="width:40px; height:40px; object-fit:cover;">
                        {% else %}
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-2"
                            style="width:40px; height:40px;">
                            <span class="text-white small">üë§</span>
                        </div>
                        {% endif %}
                        <div>
                            <small class="fw-bold d-block">{% trans "You" %}</small>
                            <small class="text-muted">
                                {% if user == dialogue.master %}
                                <span class="badge bg-success">üé® {% trans "Seller" %}</span>
                                {% else %}
                                <span class="badge bg-primary">üë§ {% trans "Buyer" %}</span>
                                {% endif %}
                            </small>
                        </div>
                    </div>

                    <!-- Interlocutor -->
                    <div class="d-flex align-items-center p-2 bg-light rounded">
                        {% if interlocutor.profile.avatar %}
                        <img src="{{ interlocutor.profile.avatar.url }}" class="rounded-circle me-2"
                            alt="{{ interlocutor.email|escape }}" style="width:40px; height:40px; object-fit:cover;">
                        {% else %}
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-2"
                            style="width:40px; height:40px;">
                            <span class="text-white small">üë§</span>
                        </div>
                        {% endif %}
                        <div>
                            <small class="fw-bold d-block">{{ interlocutor.email }}</small>
                            <small class="text-muted">
                                {% if interlocutor == dialogue.master %}
                                <span class="badge bg-success">üé® {% trans "Seller" %}</span>
                                {% else %}
                                <span class="badge bg-primary">üë§ {% trans "Buyer" %}</span>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat column -->
        <div class="col-md-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'chat:dialogue_list' %}" class="btn btn-outline-secondary me-3">‚Üê {% trans
                                "Back to dialogues" %}</a>
                            <div>
                                <h4 class="fw-bold mb-0">üí¨
                                    {% if dialogue.product %}
                                    {% trans "Product chat" %}
                                    {% else %}
                                    {% trans "Chat" %}
                                    {% endif %}
                                </h4>
                                <p class="text-muted mb-0">
                                    {% blocktrans with email=interlocutor.email %}with {{ email }}{% endblocktrans %}
                                </p>
                            </div>
                        </div>
                        <div class="d-none d-md-block">
                            <span id="messages-count-badge" class="badge bg-light text-dark">üí¨ {{
                                dialogue.messages.all.count }} {% trans "messages" %}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat window -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 fw-bold">üì® {% trans "Messages" %}</h6>
                            <small class="text-muted">
                                {% if dialogue.product %}
                                {% url 'products:product_detail' dialogue.product.pk as product_url %}
                                {% blocktrans with title=dialogue.product.title product_url=product_url %}
                                Discussion about: <a href="{{ product_url }}" class="text-brown text-decoration-none">{{title }}</a>
                                {% endblocktrans %}
                                {% else %}
                                <span class="text-warning">{% trans "Product no longer available" %}</span>
                                {% endif %}
                            </small>
                        </div>
                        <small class="text-muted" id="connection-status">
                            <span class="badge bg-secondary">‚ö™ {% trans "Connecting..." %}</span>
                        </small>
                    </div>
                </div>

                <div id="chat-messages" class="card-body p-4"
                    style="height:60vh; overflow-y:auto; background-color:#fafafa;">
                    {% if dialogue.messages.all %}
                    {% for message in dialogue.messages.all %}
                    <div class="message {% if message.sender == user %}message-own{% else %}message-other{% endif %} mb-4"
                        data-message-id="{{ message.pk }}">
                        <div class="message-header mb-1">
                            <small
                                class="fw-bold {% if message.sender == user %}text-primary{% else %}text-brown{% endif %}">
                                {% if message.sender == user %}
                                üë§ {% trans "You" %}
                                {% if user == dialogue.master %}
                                <span class="badge bg-success ms-1">üé®</span>
                                {% else %}
                                <span class="badge bg-primary ms-1">üë§</span>
                                {% endif %}
                                {% else %}
                                üé® {{ interlocutor.email }}
                                {% if interlocutor == dialogue.master %}
                                <span class="badge bg-success ms-1">üé®</span>
                                {% else %}
                                <span class="badge bg-primary ms-1">üë§</span>
                                {% endif %}
                                {% endif %}
                            </small>
                        </div>

                        <div
                            class="d-flex {% if message.sender == user %}justify-content-end{% else %}justify-content-start{% endif %}">
                            <div class="message-content">
                                <div class="{% if message.sender == user %}bg-primary text-white{% else %}bg-light text-dark border{% endif %} p-3 rounded-3"
                                    style="max-width:500px;">
                                    {{ message.text|linebreaksbr }}
                                </div>

                                <div
                                    class="d-flex align-items-center mt-1 {% if message.sender == user %}justify-content-end{% endif %}">
                                    <small class="text-muted me-2">{{ message.created_at|date:"H:i" }}</small>
                                    {% if message.sender == user %}
                                    <small class="text-muted">
                                        {% if message.is_read %}
                                        ‚úÖ {% trans "Read" %}
                                        {% else %}
                                        üïí {% trans "Sent" %}
                                        {% endif %}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-5 empty-chat">
                        <div class="mb-3" style="font-size:4rem;">üí≠</div>
                        <h5 class="text-muted">{% trans "Conversation started" %}</h5>
                        <p class="text-muted">
                            {% if dialogue.product %}
                            {% blocktrans with title=dialogue.product.title %}Write the first message about "{{ title
                            }}"{% endblocktrans %}
                            {% else %}
                            {% trans "Write the first message" %}
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                </div>

                <div class="card-footer bg-white border-top">
                    <form id="chat-form" class="d-flex gap-2 align-items-start" onsubmit="return false;">
                        {% csrf_token %}
                        <div class="flex-grow-1">
                            {% if dialogue.product %}
                            <textarea id="message-input" class="form-control"
                                placeholder="{% blocktrans with title=dialogue.product.title %}Type your message about '{{ title }}'...{% endblocktrans %}"
                                rows="1" maxlength="1000" style="resize:none;" required></textarea>
                            {% else %}
                            <textarea id="message-input" class="form-control"
                                placeholder="{% trans 'Type your message...' %}" rows="1" maxlength="1000"
                                style="resize:none;" required></textarea>
                            {% endif %}
                            <small class="text-muted mt-1 d-block">üí° {% trans "Enter to send, Shift+Enter for newline"%}</small>
                        </div>

                        <button type="button" id="send-button" class="btn btn-primary px-4 py-2"
                            style="min-width:100px;">
                            üì§ {% trans "Send" %}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .message-other .message-content {
        margin-right: auto;
    }

    .message-own .message-content {
        margin-left: auto;
    }

    .message-content {
        max-width: 70%;
    }

    #chat-messages {
        scroll-behavior: smooth;
        background-image: radial-gradient(circle at 1px 1px, rgba(0, 0, 0, 0.05) 1px, transparent 0);
        background-size: 20px 20px;
    }

    .text-brown {
        color: #8B4513;
    }

    .btn-primary {
        background-color: #8B4513;
        border-color: #8B4513;
    }

    .btn-primary:hover {
        background-color: #654321;
        border-color: #654321;
    }

    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-new {
        animation: messageSlideIn 0.3s ease-out;
    }

    .message-header {
        padding: 0 10px;
    }

    .bg-light {
        background-color: #f8f9fa !important;
        border-color: #e9ecef !important;
    }

    .bg-primary {
        background-color: #8B4513 !important;
        border-color: #8B4513 !important;
    }

    @media (max-width:768px) {
        .message-content {
            max-width: 85%;
        }

        #chat-messages {
            height: 50vh;
        }
    }
</style>

<script>
    const DIALOGUE_ID = {{ dialogue.id }};
    const CURRENT_USER_ID = {{ user.id }};
    const INTERLOCUTOR_EMAIL = "{{ interlocutor.email|escapejs }}";
    const PRODUCT_TITLE = {% if dialogue.product %}"{{ dialogue.product.title|escapejs }}"{% else %} null{% endif %};
    const IS_CURRENT_USER_MASTER = {% if user == dialogue.master %}true{% else %} false{% endif %};
    const IS_INTERLOCUTOR_MASTER = {% if interlocutor == dialogue.master %}true{% else %} false{% endif %};

    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const connectionStatus = document.getElementById('connection-status');
    const messagesCountBadge = document.getElementById('messages-count-badge');

    let chatSocket = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_DELAY = 30000;
    const renderedMessageIds = new Set();
    const pendingMessages = new Map(); // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º renderedMessageIds —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    (function initRenderedIds() {
        const nodes = chatMessages.querySelectorAll('[data-message-id]');
        nodes.forEach(n => {
            const id = n.getAttribute('data-message-id');
            if (id) renderedMessageIds.add(String(id));
        });
    })();

    function getCsrfToken() {
        const el = document.querySelector('[name=csrfmiddlewaretoken]');
        return el ? el.value : '';
    }

    function escapeHtml(s) {
        const d = document.createElement('div'); d.textContent = s; return d.innerHTML;
    }

    function formatTime(ts) {
        const d = new Date(ts); return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    }

    function makeFallbackId(sender_id, timestamp, text) {
        const s = `${sender_id}||${timestamp}||${text}`;
        let h = 0;
        for (let i = 0; i < s.length; i++) { h = ((h << 5) - h) + s.charCodeAt(i); h |= 0; }
        return 'fb_' + (h >>> 0);
    }

    function updateConnectionStatus(text, type) {
        connectionStatus.innerHTML = `<span class="badge bg-${type}">${text}</span>`;
    }

    function updateMessagesCount(delta = 0) {
        if (!messagesCountBadge) return;
        const raw = messagesCountBadge.textContent.trim();
        const matched = raw.match(/üí¨\s*(\d+)/);
        const current = matched ? parseInt(matched[1], 10) : 0;
        const next = Math.max(0, current + delta);
        messagesCountBadge.textContent = `üí¨ ${next} ${next === 1 ? 'message' : 'messages'}`;
    }

    function scrollToBottom() { chatMessages.scrollTop = chatMessages.scrollHeight; }

    function buildMessageNode(data, isTemp = false) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π, –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        const msgId = isTemp ? 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            : (data.message_id ? String(data.message_id) : makeFallbackId(data.sender_id, data.timestamp || new Date().toISOString(), data.message || ''));

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–æ—Å—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ
        if (!isTemp && renderedMessageIds.has(msgId)) return null;
        if (!isTemp) renderedMessageIds.add(msgId);

        const isOwn = Number(data.sender_id) === Number(CURRENT_USER_ID);
        const wrapper = document.createElement('div');
        wrapper.className = `message ${isOwn ? 'message-own' : 'message-other'} mb-4 message-new`;
        wrapper.setAttribute('data-message-id', msgId);
        if (isTemp) wrapper.setAttribute('data-temp-message', 'true');

        const header = document.createElement('div'); header.className = 'message-header mb-1';
        const small = document.createElement('small'); small.className = `fw-bold ${isOwn ? 'text-primary' : 'text-brown'}`;

        if (isOwn) {
            small.innerHTML = `üë§ You`;
            const badge = document.createElement('span'); badge.className = 'badge ms-1 ' + (IS_CURRENT_USER_MASTER ? 'bg-success' : 'bg-primary');
            badge.textContent = IS_CURRENT_USER_MASTER ? 'üé®' : 'üë§'; small.appendChild(badge);
        } else {
            small.innerHTML = `üé® ${escapeHtml(INTERLOCUTOR_EMAIL)}`;
            const badge = document.createElement('span'); badge.className = 'badge ms-1 ' + (IS_INTERLOCUTOR_MASTER ? 'bg-success' : 'bg-primary');
            badge.textContent = IS_INTERLOCUTOR_MASTER ? 'üé®' : 'üë§'; small.appendChild(badge);
        }

        header.appendChild(small); wrapper.appendChild(header);

        const row = document.createElement('div'); row.className = `d-flex ${isOwn ? 'justify-content-end' : 'justify-content-start'}`;
        const contentWrap = document.createElement('div'); contentWrap.className = 'message-content';
        const bubble = document.createElement('div'); bubble.className = isOwn ? 'bg-primary text-white p-3 rounded-3' : 'bg-light text-dark border p-3 rounded-3';
        bubble.style.maxWidth = '500px'; bubble.innerHTML = escapeHtml(data.message).replace(/\n/g, '<br>');

        const meta = document.createElement('div'); meta.className = `d-flex align-items-center mt-1 ${isOwn ? 'justify-content-end' : ''}`;
        const time = document.createElement('small'); time.className = 'text-muted me-2';
        time.textContent = data.timestamp ? formatTime(data.timestamp) : formatTime(new Date()); meta.appendChild(time);

        if (isOwn) {
            const status = document.createElement('small'); status.className = 'text-muted';
            status.textContent = isTemp ? 'üîÑ Sending...' : (data.is_read ? '‚úÖ Read' : 'üïí Sent');
            meta.appendChild(status);
        }

        contentWrap.appendChild(bubble); contentWrap.appendChild(meta);
        row.appendChild(contentWrap); wrapper.appendChild(row);

        return wrapper;
    }

    function addMessageToChat(data, isTemp = false) {
        const node = buildMessageNode(data, isTemp);
        if (!node) return null;
        const empty = chatMessages.querySelector('.empty-chat');
        if (empty) empty.remove();
        chatMessages.appendChild(node);
        scrollToBottom();
        if (!isTemp) updateMessagesCount(1);
        return node;
    }

    function updateTempMessage(tempId, serverData) {
        const tempElement = document.querySelector(`[data-message-id="${tempId}"]`);
        if (tempElement) {
            // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
            tempElement.remove();
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
            addMessageToChat(serverData, false);
            // –£–¥–∞–ª—è–µ–º –∏–∑ pendingMessages
            pendingMessages.delete(tempId);
        }
    }

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/chat/${DIALOGUE_ID}/`;
        try { chatSocket = new WebSocket(wsUrl); } catch (err) { console.error('WebSocket error', err); scheduleReconnect(); return; }

        chatSocket.onopen = function () {
            reconnectAttempts = 0;
            updateConnectionStatus('üü¢ Online', 'success');
            // –û—Ç–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
            markMessagesAsRead();
        };

        chatSocket.onmessage = function (e) {
            try {
                const data = JSON.parse(e.data);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const isOwnMessage = Number(data.sender_id) === Number(CURRENT_USER_ID);

                if (isOwnMessage) {
                    // –ò—â–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–∞–∫–∏–º –∂–µ —Ç–µ–∫—Å—Ç–æ–º
                    let foundTempId = null;
                    for (const [tempId, tempData] of pendingMessages.entries()) {
                        if (tempData.text === data.message) {
                            foundTempId = tempId;
                            break;
                        }
                    }

                    if (foundTempId) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ
                        updateTempMessage(foundTempId, data);
                    } else {
                        // –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ)
                        addMessageToChat(data, false);
                    }
                } else {
                    // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                    addMessageToChat(data, false);
                    markMessagesAsRead();
                }
            } catch (err) { console.error('WS message parse error', err, e.data); }
        };

        chatSocket.onclose = function (e) {
            console.warn('WebSocket closed', e.code, e.reason);
            updateConnectionStatus('üî¥ Offline', 'danger');
            scheduleReconnect();
        };

        chatSocket.onerror = function (err) {
            console.error('WebSocket error', err);
            updateConnectionStatus('‚ö†Ô∏è Connection error', 'warning');
        };
    }

    function scheduleReconnect() {
        reconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), MAX_RECONNECT_DELAY);
        setTimeout(() => {
            if (!document.hidden) connectWebSocket();
        }, delay);
    }

    function markMessagesAsRead() {
        fetch(`/chat/${DIALOGUE_ID}/mark-read/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrfToken(), 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        }).then(r => r.json()).then(data => {
            if (data.status === 'success' && data.updated_count) {
                console.log('Marked read:', data.updated_count);
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                document.querySelectorAll('.message-own [data-message-id]').forEach(el => {
                    if (!el.hasAttribute('data-temp-message')) {
                        const statusEl = el.querySelector('.message-content .text-muted:last-child');
                        if (statusEl && statusEl.textContent.includes('üïí')) {
                            statusEl.textContent = '‚úÖ Read';
                        }
                    }
                });
            }
        }).catch(err => console.error('Mark read failed', err));
    }

    function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;

        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            sendButton.disabled = true;
            sendButton.innerText = '‚è≥';

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const tempMessageData = {
                sender_id: CURRENT_USER_ID,
                message: text,
                timestamp: new Date().toISOString()
            };

            const tempNode = addMessageToChat(tempMessageData, true);
            if (tempNode) {
                const tempId = tempNode.getAttribute('data-message-id');
                pendingMessages.set(tempId, { text: text, timestamp: tempMessageData.timestamp });
            }

            const payload = {
                message: text,
                sender_id: CURRENT_USER_ID,
                dialogue_id: DIALOGUE_ID
            };

            try {
                chatSocket.send(JSON.stringify(payload));
            } catch (err) {
                console.error('Send failed', err);
                alert('Send failed');
                sendButton.disabled = false;
                sendButton.innerText = 'üì§ Send';
                return;
            }

            messageInput.value = '';
            messageInput.style.height = 'auto';

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            setTimeout(() => {
                sendButton.disabled = false;
                sendButton.innerText = 'üì§ Send';
            }, 300);
        } else {
            updateConnectionStatus('üî¥ Send failed', 'danger');
            alert('Connection error. Please refresh the page.');
        }
    }

    if (messageInput) {
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        messageInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    if (sendButton) sendButton.addEventListener('click', sendMessage);

    document.addEventListener('visibilitychange', function () {
        if (!document.hidden && (!chatSocket || chatSocket.readyState === WebSocket.CLOSED)) {
            connectWebSocket();
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        markMessagesAsRead();
        connectWebSocket();
        scrollToBottom();
        if (messageInput) messageInput.focus();
    });
</script>
{% endblock %}