{% extends "base.html" %}
{% load static %}

{% block title %}
{% if dialogue.product %}
–ß–∞—Ç –ø–æ —Ç–æ–≤–∞—Ä—É "{{ dialogue.product.title }}" | HandmadeMarket
{% else %}
–ß–∞—Ç | HandmadeMarket
{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ</h5>

                    {% if dialogue.product %}
                    {% if dialogue.product.images.all %}
                    <img src="{{ dialogue.product.images.first.image.url }}" class="card-img-top rounded mb-3"
                        alt="{{ dialogue.product.title }}" style="height: 200px; object-fit: cover;">
                    {% else %}
                    <div class="bg-light rounded d-flex align-items-center justify-content-center mb-3"
                        style="height: 200px;">
                        <span class="text-muted" style="font-size: 3rem;">üé®</span>
                    </div>
                    {% endif %}

                    <h6 class="fw-bold text-brown">{{ dialogue.product.title }}</h6>
                    <p class="text-muted small mb-2">{{ dialogue.product.description|truncatewords:15 }}</p>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="h5 fw-bold text-brown">{{ dialogue.product.price }} ‚ÇΩ</span>
                        {% if dialogue.product.category %}
                        <span class="badge bg-brown">{{ dialogue.product.category.name }}</span>
                        {% endif %}
                    </div>

                    <div class="d-grid gap-2">
                        <a href="{% url 'products:product_detail' dialogue.product.pk %}"
                            class="btn btn-outline-primary btn-sm">
                            üëÄ –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–æ–≤–∞—Ä—É
                        </a>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <div class="mb-3" style="font-size: 3rem;">‚ùå</div>
                        <h6 class="text-muted fw-bold">–¢–æ–≤–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h6>
                        <p class="text-muted small mb-0">
                            –≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–ª–∏ –±–æ–ª—å—à–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–µ -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–∏–∞–ª–æ–≥–∞</h6>

                    <!-- –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
                    <div class="d-flex align-items-center mb-3 p-2 bg-light rounded">
                        {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" class="rounded-circle me-2" alt="–í–∞—à –∞–≤–∞—Ç–∞—Ä"
                            style="width: 40px; height: 40px; object-fit: cover;">
                        {% else %}
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-2"
                            style="width: 40px; height: 40px;">
                            <span class="text-white small">üë§</span>
                        </div>
                        {% endif %}
                        <div>
                            <small class="fw-bold d-block">–í—ã</small>
                            <small class="text-muted">
                                {% if user == dialogue.master %}
                                <span class="badge bg-success">üé® –ü—Ä–æ–¥–∞–≤–µ—Ü</span>
                                {% else %}
                                <span class="badge bg-primary">üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å</span>
                                {% endif %}
                            </small>
                        </div>
                    </div>

                    <!-- –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ -->
                    <div class="d-flex align-items-center p-2 bg-light rounded">
                        {% if interlocutor.profile.avatar %}
                        <img src="{{ interlocutor.profile.avatar.url }}" class="rounded-circle me-2"
                            alt="–ê–≤–∞—Ç–∞—Ä {{ interlocutor.email }}" style="width: 40px; height: 40px; object-fit: cover;">
                        {% else %}
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-2"
                            style="width: 40px; height: 40px;">
                            <span class="text-white small">üë§</span>
                        </div>
                        {% endif %}
                        <div>
                            <small class="fw-bold d-block">{{ interlocutor.email }}</small>
                            <small class="text-muted">
                                {% if interlocutor == dialogue.master %}
                                <span class="badge bg-success">üé® –ü—Ä–æ–¥–∞–≤–µ—Ü</span>
                                {% else %}
                                <span class="badge bg-primary">üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å</span>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'chat:dialogue_list' %}" class="btn btn-outline-secondary me-3">
                                ‚Üê –ù–∞–∑–∞–¥ –∫ –¥–∏–∞–ª–æ–≥–∞–º
                            </a>
                            <div>
                                <h4 class="fw-bold mb-0">
                                    üí¨
                                    {% if dialogue.product %}
                                    –ß–∞—Ç –ø–æ —Ç–æ–≤–∞—Ä—É
                                    {% else %}
                                    –ß–∞—Ç
                                    {% endif %}
                                </h4>
                                <p class="text-muted mb-0">
                                    —Å {{ interlocutor.email }}
                                    {% if interlocutor.get_full_name %}
                                    <small class="text-muted">({{ interlocutor.get_full_name }})</small>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="d-none d-md-block">
                            <span class="badge bg-light text-dark">
                                üí¨ {{ dialogue.messages.count }} —Å–æ–æ–±—â–µ–Ω–∏–π
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
            <div class="card border-0 shadow-sm">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–∫–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π -->
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 fw-bold">üì® –°–æ–æ–±—â–µ–Ω–∏—è</h6>
                            <small class="text-muted">
                                {% if dialogue.product %}
                                –û–±—Å—É–∂–¥–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:
                                <a href="{% url 'products:product_detail' dialogue.product.pk %}"
                                    class="text-brown text-decoration-none">
                                    {{ dialogue.product.title }}
                                </a>
                                {% else %}
                                <span class="text-warning">–¢–æ–≤–∞—Ä –±–æ–ª—å—à–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>
                                {% endif %}
                            </small>
                        </div>
                        <small class="text-muted" id="connection-status">
                            <span class="badge bg-secondary">‚ö™ Connecting...</span>
                        </small>
                    </div>
                </div>

                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π -->
                <div id="chat-messages" class="card-body p-4"
                    style="height: 60vh; overflow-y: auto; background-color: #fafafa;">

                    <!-- –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ë–î -->
                    {% for message in dialogue.messages.all %}
                    <div
                        class="message {% if message.sender == user %}message-own{% else %}message-other{% endif %} mb-4">
                        <div class="message-header mb-1">
                            <small
                                class="fw-bold {% if message.sender == user %}text-primary{% else %}text-brown{% endif %}">
                                {% if message.sender == user %}
                                üë§ –í—ã
                                {% if user == dialogue.master %}
                                <span class="badge bg-success ms-1">üé®</span>
                                {% else %}
                                <span class="badge bg-primary ms-1">üë§</span>
                                {% endif %}
                                {% else %}
                                üé® {{ interlocutor.email }}
                                {% if interlocutor == dialogue.master %}
                                <span class="badge bg-success ms-1">üé®</span>
                                {% else %}
                                <span class="badge bg-primary ms-1">üë§</span>
                                {% endif %}
                                {% endif %}
                            </small>
                        </div>
                        <div
                            class="d-flex {% if message.sender == user %}justify-content-end{% else %}justify-content-start{% endif %}">
                            <div class="message-content">
                                <!-- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
                                <div class="{% if message.sender == user %}bg-primary text-white{% else %}bg-light text-dark border{% endif %} 
                                            p-3 rounded-3" style="max-width: 500px;">
                                    {{ message.text|linebreaksbr }}
                                </div>

                                <!-- –í—Ä–µ–º—è –∏ —Å—Ç–∞—Ç—É—Å -->
                                <div
                                    class="d-flex align-items-center mt-1 {% if message.sender == user %}justify-content-end{% endif %}">
                                    <small class="text-muted me-2">
                                        {{ message.created_at|date:"H:i" }}
                                    </small>
                                    {% if message.sender == user %}
                                    <small class="text-muted">
                                        {% if message.is_read %}‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ{% else %}üïí –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ{% endif %}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <!-- –ü—É—Å—Ç–æ–π —á–∞—Ç -->
                    <div class="text-center py-5">
                        <div class="mb-3" style="font-size: 4rem;">üí≠</div>
                        <h5 class="text-muted">–î–∏–∞–ª–æ–≥ –Ω–∞—á–∞—Ç</h5>
                        <p class="text-muted">
                            {% if dialogue.product %}
                            –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–≤–∞—Ä–µ "{{ dialogue.product.title }}"
                            {% else %}
                            –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                            {% endif %}
                        </p>
                    </div>
                    {% endfor %}
                </div>

                <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="card-footer bg-white border-top">
                    <form id="chat-form" class="d-flex gap-2 align-items-start">
                        {% csrf_token %}

                        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
                        <div class="flex-grow-1">
                            <textarea id="message-input" class="form-control"
                                placeholder="{% if dialogue.product %}–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–≤–∞—Ä–µ '{{ dialogue.product.title }}'...{% else %}–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...{% endif %}"
                                rows="1" maxlength="1000" style="resize: none;" required></textarea>
                            <small class="text-muted mt-1 d-block">
                                üí° Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
                            </small>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                        <button type="submit" id="send-button" class="btn btn-primary px-4 py-2"
                            style="min-width: 100px;">
                            üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .message-other .message-content {
        margin-right: auto;
    }

    .message-own .message-content {
        margin-left: auto;
    }

    .message-content {
        max-width: 70%;
    }

    #chat-messages {
        scroll-behavior: smooth;
        background-image:
            radial-gradient(circle at 1px 1px, rgba(0, 0, 0, 0.05) 1px, transparent 0);
        background-size: 20px 20px;
    }

    .text-brown {
        color: #8B4513;
    }

    .btn-primary {
        background-color: #8B4513;
        border-color: #8B4513;
    }

    .btn-primary:hover {
        background-color: #654321;
        border-color: #654321;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-new {
        animation: messageSlideIn 0.3s ease-out;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π */
    .message-header {
        padding: 0 10px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
    .bg-light {
        background-color: #f8f9fa !important;
        border-color: #e9ecef !important;
    }

    .bg-primary {
        background-color: #8B4513 !important;
        border-color: #8B4513 !important;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-width: 768px) {
        .message-content {
            max-width: 85%;
        }

        #chat-messages {
            height: 50vh;
        }
    }
</style>

<script>
    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

    // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
    function getCsrfToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '';
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // ========== –û–°–ù–û–í–ù–û–ô –ö–û–î ==========

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const dialogueId = {{ dialogue.id }};
    const currentUserId = {{ user.id }};
    const currentUserEmail = "{{ user.email }}";
    const interlocutorName = "{{ interlocutor.email }}";
    const productTitle = "{% if dialogue.product %}{{ dialogue.product.title }}{% else %}—Ç–æ–≤–∞—Ä–∞{% endif %}";

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const connectionStatus = document.getElementById('connection-status');

    // WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    let chatSocket = null;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–º–µ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
    function markMessagesAsRead() {
        fetch(`/chat/${dialogueId}/mark-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log(`–ü–æ–º–µ—á–µ–Ω–æ ${data.updated_count} —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ`);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    updateUnreadCounter();
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:', error);
            });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
    function updateUnreadCounter() {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –≤ —Å–ø–∏—Å–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤
        fetch('/chat/')
            .then(response => response.text())
            .then(html => {
                console.log('–°—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω');
            });
    }

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/chat/${dialogueId}/`;

        console.log('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket:', wsUrl);

        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function (e) {
            console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ');
            updateConnectionStatus('üü¢ Online', 'success');

            // –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–º–µ—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
            markMessagesAsRead();
        };

        chatSocket.onmessage = function (e) {
            console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket:', e.data);
            try {
                const data = JSON.parse(e.data);
                addMessageToChat(data);
                scrollToBottom();

                // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞, –ø–æ–º–µ—á–∞–µ–º –µ–≥–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
                if (data.sender_id != currentUserId) {
                    markMessagesAsRead();
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            }
        };

        chatSocket.onclose = function (e) {
            console.log('üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω. –ö–æ–¥:', e.code, '–ü—Ä–∏—á–∏–Ω–∞:', e.reason);
            updateConnectionStatus('üî¥ Offline', 'danger');

            // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (chatSocket.readyState === WebSocket.CLOSED) {
                    console.log('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
                    connectWebSocket();
                }
            }, 3000);
        };

        chatSocket.onerror = function (e) {
            console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', e);
            updateConnectionStatus('‚ö†Ô∏è Connection error', 'warning');
        };
    }

    function updateConnectionStatus(text, type) {
        connectionStatus.innerHTML = `
            <span class="badge bg-${type}">${text}</span>
        `;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    chatForm.onsubmit = function (e) {
        e.preventDefault();
        sendMessage();
    };

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
    messageInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter (–±–µ–∑ Shift)
    messageInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        const message = messageInput.value.trim();

        if (!message) {
            console.warn('‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
            return;
        }

        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
            sendButton.disabled = true;
            sendButton.innerHTML = '‚è≥';

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
            const messageData = {
                'message': message,
                'sender_id': currentUserId,
                'dialogue_id': dialogueId
            };

            console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket:', messageData);
            chatSocket.send(JSON.stringify(messageData));

            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            setTimeout(() => {
                sendButton.disabled = false;
                sendButton.innerHTML = 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            }, 1000);
        } else {
            console.error('‚ùå WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω. –°–æ—Å—Ç–æ—è–Ω–∏–µ:', chatSocket ? chatSocket.readyState : '–Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            updateConnectionStatus('üî¥ Send failed', 'danger');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        }
    }

    function addMessageToChat(data) {
        const isOwn = data.sender_id == currentUserId;
        const messageTime = data.timestamp ? formatTime(data.timestamp) : formatTime(new Date());
        const senderName = isOwn ? 'üë§ –í—ã' : `üé® ${interlocutorName}`;

        const messageElement = document.createElement('div');
        messageElement.className = `message ${isOwn ? 'message-own' : 'message-other'} mb-4 message-new`;
        messageElement.innerHTML = `
            <div class="message-header mb-1">
                <small class="fw-bold ${isOwn ? 'text-primary' : 'text-brown'}">
                    ${senderName}
                    ${isOwn ?
                '{% if user == dialogue.master %}<span class="badge bg-success ms-1">üé®</span>{% else %}<span class="badge bg-primary ms-1">üë§</span>{% endif %}' :
                '{% if interlocutor == dialogue.master %}<span class="badge bg-success ms-1">üé®</span>{% else %}<span class="badge bg-primary ms-1">üë§</span>{% endif %}'
            }
                </small>
            </div>
            <div class="d-flex ${isOwn ? 'justify-content-end' : 'justify-content-start'}">
                <div class="message-content">
                    <div class="${isOwn ? 'bg-primary text-white' : 'bg-light text-dark border'} 
                                p-3 rounded-3" 
                         style="max-width: 500px;">
                        ${escapeHtml(data.message).replace(/\n/g, '<br>')}
                    </div>
                    <div class="d-flex align-items-center mt-1 ${isOwn ? 'justify-content-end' : ''}">
                        <small class="text-muted me-2">${messageTime}</small>
                        ${isOwn ? '<small class="text-muted">üïí –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</small>' : ''}
                    </div>
                </div>
            </div>
        `;

        chatMessages.appendChild(messageElement);
        scrollToBottom();

        // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        const emptyState = chatMessages.querySelector('.text-center');
        if (emptyState) {
            emptyState.remove();
        }
    }

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —á–∞—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');

        // –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        markMessagesAsRead();

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
        connectWebSocket();
        scrollToBottom();

        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        messageInput.focus();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ)
    document.addEventListener('visibilitychange', function () {
        if (!document.hidden && chatSocket && chatSocket.readyState === WebSocket.CLOSED) {
            console.log('üîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–∞, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º WebSocket...');
            connectWebSocket();
        }

        // –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
        if (!document.hidden) {
            markMessagesAsRead();
        }
    });
</script>
{% endblock %}