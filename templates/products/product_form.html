{% extends "base.html" %}
{% load static i18n %}

{% block title %}
{% if object %}
{% trans "Edit product" %}
{% else %}
{% trans "Add product" %}
{% endif %} | HandmadeMarket
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="text-center mb-5">
                <h1 class="fw-bold mb-3">
                    {% if object %}
                    ‚úèÔ∏è {% trans "Edit product" %}
                    {% else %}
                    üé® {% trans "Add new product" %}
                    {% endif %}
                </h1>
                <p class="text-muted">{% trans "Fill in information about your handmade product" %}</p>
                <p class="text-danger small mt-2">* ‚Äî {% trans "required fields" %}</p>
            </div>

            <!-- –§–æ—Ä–º–∞ -->
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="product-form">
                        {% csrf_token %}

                        <!-- –í—ã–≤–æ–¥ –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã -->
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3 text-brown">üìã {% trans "Basic information" %}</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form.category.id_for_label }}" class="form-label">
                                        {% trans "Category" %} <span class="text-danger">*</span>
                                    </label>
                                    <div class="position-relative">
                                        {{ form.category }}
                                        <button type="button" class="btn-clear-field" style="display: none;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if form.category.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.category.errors %}
                                        <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.price.id_for_label }}" class="form-label">
                                        {% trans "Price (rub.)" %} <span class="text-danger">*</span>
                                    </label>
                                    <div class="price-input-container position-relative">
                                        {{ form.price }}
                                        <span class="price-suffix">‚ÇΩ</span>
                                        <button type="button" class="btn-clear-field" style="display: none;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if form.price.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.price.errors %}
                                        <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">{% trans "Integer from 1 to 5,000,000 rubles" %}</div>
                                </div>
                                <div class="col-12">
                                    <label for="{{ form.title.id_for_label }}" class="form-label">
                                        {% trans "Product name" %} <span class="text-danger">*</span>
                                    </label>
                                    <div class="position-relative">
                                        {{ form.title }}
                                        <button type="button" class="btn-clear-field" style="display: none;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if form.title.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.title.errors %}
                                        <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">{% trans "Max 60 characters, only letters, numbers and
                                        spaces" %}</div>
                                </div>
                                <div class="col-12">
                                    <label for="{{ form.description.id_for_label }}" class="form-label">
                                        {% trans "Description" %} <span class="text-danger">*</span>
                                    </label>
                                    <div class="position-relative">
                                        {{ form.description }}
                                        <button type="button" class="btn-clear-field" style="display: none;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if form.description.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.description.errors %}
                                        <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">{% trans "Max 300 characters, only letters, numbers and
                                        punctuation" %}</div>
                                </div>
                            </div>
                        </div>

                        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3 text-brown">
                                üñºÔ∏è {% trans "Product images" %} <span class="text-danger">*</span>
                            </h5>

                            <!-- –í–∞–∂–Ω–æ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
                            <div class="alert alert-info mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3" style="font-size: 1.5rem;">üí°</div>
                                    <div>
                                        <strong>{% trans "Important!" %}</strong>
                                        {% trans "The first uploaded image will automatically become main. You can
                                        change this later by selecting another image as main." %}
                                    </div>
                                </div>
                            </div>

                            <p class="text-muted mb-3">
                                {% trans "You can upload up to 4 photos." %}
                                <span class="text-danger">{% trans "At least one image must be uploaded." %}</span>
                            </p>

                            {{ formset.management_form }}
                            <div id="image-forms">
                                {% for image_form in formset %}
                                <div class="image-form mb-3 p-3 border rounded bg-light position-relative"
                                    data-prefix="{{ image_form.prefix }}">
                                    <!-- –ö—Ä–µ—Å—Ç–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ -->
                                    {% if not image_form.instance.image %}
                                    <button type="button" class="btn-remove-image" title="{% trans 'Delete file' %}"
                                        style="display: none;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                            <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </button>
                                    {% else %}
                                    <!-- –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
                                    <button type="button" class="btn-remove-existing-image"
                                        title="{% trans 'Delete file' %}">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                            <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </button>
                                    {% endif %}

                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            {% if image_form.instance.image %}
                                            <!-- –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
                                            <div class="existing-image">
                                                <label class="form-label">{% trans "Current image" %}</label>
                                                <div class="d-flex align-items-center gap-3 mb-2">
                                                    <img src="{{ image_form.instance.image.url }}" alt="Current image"
                                                        style="width: 80px; height: 80px; object-fit: cover;"
                                                        class="img-thumbnail">
                                                    <div>
                                                        <button type="button"
                                                            class="btn btn-outline-secondary btn-sm replace-image-btn">
                                                            üìÅ {% trans "Replace" %}
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="image-upload-field" style="display: none;">
                                                    {{ image_form.image }}
                                                    <div class="form-text mt-1">{% trans "Select a new image" %}</div>
                                                </div>
                                            </div>
                                            {% else %}
                                            <!-- –î–ª—è –Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
                                            <label class="form-label">{% trans "Image" %}</label>
                                            {{ image_form.image }}
                                            <div class="form-text">{% trans "Select an image file" %}</div>
                                            {% endif %}

                                            {% if image_form.image.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in image_form.image.errors %}
                                                <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check form-switch mt-3">
                                                {{ image_form.is_main }}
                                                <label class="form-check-label"
                                                    for="{{ image_form.is_main.id_for_label }}">
                                                    {% trans "Main" %}
                                                </label>
                                                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã–º -->
                                                <div class="no-file-message text-danger small mt-1"
                                                    style="display: none;">
                                                    ‚ùå {% trans "First upload an image" %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% if image_form.instance.pk %}
                                            <div class="form-check">
                                                {{ image_form.DELETE }}
                                                <label class="form-check-label text-danger"
                                                    for="{{ image_form.DELETE.id_for_label }}">
                                                    {% trans "Delete" %}
                                                </label>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% for hidden in image_form.hidden_fields %}
                                    {{ hidden }}
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <div class="d-flex gap-3 flex-wrap justify-content-center">
                            <button type="submit" class="btn btn-primary btn-lg px-4">
                                üíæ
                                {% if object %}
                                {% trans "Save changes" %}
                                {% else %}
                                {% trans "Add product" %}
                                {% endif %}
                            </button>
                            {% if object %}
                            <a href="{% url 'products:product_detail' object.pk %}"
                                class="btn btn-outline-secondary btn-lg px-4">
                                ‚ùå {% trans "Cancel" %}
                            </a>
                            {% else %}
                            <a href="{% url 'products:my_products' %}" class="btn btn-outline-secondary btn-lg px-4">
                                ‚ùå {% trans "Cancel" %}
                            </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ -->
            <div class="card border-info mt-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">‚ÑπÔ∏è {% trans "Information for craftsman" %}</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold">üé® {% trans "Your opportunities:" %}</h6>
                            <ul class="small text-muted mb-0">
                                <li>{% trans "Sell your handmade products" %}</li>
                                <li>{% trans "Buy products from other craftsmen" %}</li>
                                <li>{% trans "Add any products to favorites" %}</li>
                                <li>{% trans "Communicate with other craftsmen" %}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">üìä {% trans "Product management:" %}</h6>
                            <ul class="small text-muted mb-0">
                                <li>{% trans "All products are displayed in the catalog" %}</li>
                                <li>{% trans "You can edit and delete your products" %}</li>
                                <li>{% trans "Up to 4 photos per product" %}</li>
                                <li>{% trans "Manage orders in profile" %}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .text-brown {
        color: #8B4513;
    }

    .form-control,
    .form-select {
        border-radius: 10px;
        padding: 0.75rem 1rem;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        padding-right: 2.5rem;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #8B4513;
        box-shadow: 0 0 0 0.2rem rgba(139, 69, 19, 0.25);
    }

    .image-form {
        transition: all 0.3s ease;
        position: relative;
    }

    .image-form:hover {
        background-color: #f8f9fa !important;
        border-color: #8B4513 !important;
    }

    .btn-primary {
        background-color: #8B4513;
        border-color: #8B4513;
        border-radius: 10px;
        font-weight: 600;
    }

    .btn-primary:hover {
        background-color: #654321;
        border-color: #654321;
    }

    .card {
        border-radius: 15px;
        border: none;
    }

    .text-danger.small {
        font-size: 0.875em;
        margin-top: 0.25rem;
    }

    .price-input-container {
        position: relative;
    }

    .price-suffix {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-weight: 500;
        pointer-events: none;
    }

    .char-counter {
        font-size: 0.875em;
    }

    .is-invalid {
        border-color: #dc3545 !important;
    }

    .price-limit-info {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 2px;
    }

    .existing-image .img-thumbnail {
        border: 2px solid #8B4513;
    }

    .replace-image-btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.75rem;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ */
    .form-control::placeholder,
    .form-select::placeholder {
        color: #adb5bd !important;
        opacity: 1 !important;
    }

    /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π */
    input::placeholder,
    textarea::placeholder,
    select::placeholder {
        color: #adb5bd !important;
    }

    /* –î–ª—è –ø–æ–ª—è —Ü–µ–Ω—ã */
    .price-input-container input::placeholder {
        color: #adb5bd !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –∫—Ä–µ—Å—Ç–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */
    .btn-remove-image,
    .btn-remove-existing-image,
    .btn-clear-field {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #dc3545;
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        z-index: 10;
        padding: 0;
    }

    /* –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∫—Ä–µ—Å—Ç–∏–∫ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª—è */
    .position-relative .btn-clear-field {
        top: 50%;
        right: 12px;
        transform: translateY(-50%);
        background: #6c757d;
    }

    .price-input-container .btn-clear-field {
        right: 30px;
    }

    .btn-remove-image:hover,
    .btn-remove-existing-image:hover,
    .btn-clear-field:hover {
        background: #c82333;
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
    }

    .btn-clear-field:hover {
        background: #5a6268;
    }

    .btn-remove-image svg,
    .btn-remove-existing-image svg,
    .btn-clear-field svg {
        width: 16px;
        height: 16px;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ä–º—ã */
    .image-form.removing {
        opacity: 0;
        transform: translateX(-20px);
        transition: all 0.3s ease;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ */
    .form-check-input:disabled+.form-check-label {
        color: #6c757d;
        opacity: 0.6;
    }

    .no-file-message {
        font-size: 0.75rem;
    }
</style>

<script>
    // –û–±—ä–µ–∫—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è JavaScript
    const translations = {
        // –ö–Ω–æ–ø–∫–∏ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        replace: "{% trans 'Replace' %}",
        delete: "{% trans 'Delete' %}",
        cancel: "{% trans 'Cancel' %}",
        saveChanges: "{% trans 'Save changes' %}",
        addProduct: "{% trans 'Add product' %}",
        save: "{% trans 'Save' %}",

        // –°–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        deleteFile: "{% trans 'Delete file' %}",
        selectNewImage: "{% trans 'Select a new image' %}",
        selectImageFile: "{% trans 'Select an image file' %}",
        chooseCategory: "{% trans 'Choose category' %}",
        productNamePlaceholder: "{% trans 'For example: Handmade knitted scarf' %}",
        descriptionPlaceholder: "{% trans 'Describe your product: materials, sizes, manufacturing features...' %}",
        pricePlaceholder: "{% trans '1000' %}",
        firstUploadImage: "{% trans 'First upload an image' %}",

        // –û—à–∏–±–∫–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
        cannotSetMainWithoutFile: "{% trans 'Cannot set image as main without uploaded file!' %}",
        chooseCategoryError: "{% trans 'Select product category' %}",
        enterValidPrice: "{% trans 'Enter valid price' %}",
        priceMinError: "{% trans 'Price must be at least 1 ruble' %}",
        priceMaxError: "{% trans 'Price cannot exceed 5000000 rubles' %}",
        enterProductName: "{% trans 'Enter product name' %}",
        nameValidationError: "{% trans 'Name must contain only letters, numbers and spaces' %}",
        enterDescription: "{% trans 'Enter product description' %}",
        descriptionValidationError: "{% trans 'Description must contain only letters, numbers and punctuation' %}",
        atLeastOneImage: "{% trans 'At least one product image must be uploaded' %}",
        selectMainImage: "{% trans 'Main image must be selected' %}",
        maxImagesWarning: "{% trans 'Maximum number of images: 4' %}",

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        priceLimitReached: "{% trans 'Reached limit of 7 digits' %}",
        canEnterDigits: "{% trans 'You can enter up to 7 digits' %}",
        charactersCount: "{% trans 'characters (left: ' %}",
        charactersLeft: "{% trans 'characters left' %}"
    };

    document.addEventListener('DOMContentLoaded', function () {
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ü–µ–Ω—ã
        const MIN_PRICE = 1;
        const MAX_PRICE = 5000000;
        const MAX_DIGITS = 7;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á
        function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞
        function parseFormattedNumber(formattedNumber) {
            return parseInt(formattedNumber.replace(/\s/g, '')) || 0;
        }

        // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
        const titleField = document.getElementById('{{ form.title.id_for_label }}');
        const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
        const priceField = document.getElementById('{{ form.price.id_for_label }}');
        const categoryField = document.getElementById('{{ form.category.id_for_label }}');
        const productForm = document.getElementById('product-form');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let hasMainImage = false;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –µ—Å—Ç—å –ª–∏ —É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª
        function hasImageFile(imageForm) {
            const fileInput = imageForm.querySelector('input[type="file"]');
            const existingImage = imageForm.querySelector('.existing-image');
            const deleteCheckbox = imageForm.querySelector('input[type="checkbox"][name*="DELETE"]');

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –æ–Ω–æ –Ω–µ –ø–æ–º–µ—á–µ–Ω–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
            if (existingImage && (!deleteCheckbox || !deleteCheckbox.checked)) {
                return true;
            }

            // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            if (fileInput && fileInput.files.length > 0) {
                return true;
            }

            return false;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ "–æ—Å–Ω–æ–≤–Ω–æ–µ"
        function updateMainCheckboxes() {
            const imageForms = document.querySelectorAll('.image-form');
            let firstAvailableImage = null;

            imageForms.forEach(form => {
                if (form.style.display === 'none') return;

                const checkbox = form.querySelector('input[name$="-is_main"]');
                const hasFile = hasImageFile(form);
                const noFileMessage = form.querySelector('.no-file-message');

                // –ë–ª–æ–∫–∏—Ä—É–µ–º —á–µ–∫–±–æ–∫—Å –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞
                if (!hasFile) {
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    if (noFileMessage) noFileMessage.style.display = 'block';
                } else {
                    checkbox.disabled = false;
                    if (noFileMessage) noFileMessage.style.display = 'none';

                    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    if (!firstAvailableImage && !hasMainImage) {
                        firstAvailableImage = checkbox;
                    }
                }
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–µ
            if (firstAvailableImage && !hasMainImage) {
                firstAvailableImage.checked = true;
                hasMainImage = true;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞ "–æ—Å–Ω–æ–≤–Ω–æ–µ"
        function handleMainCheckboxChange(checkbox) {
            if (checkbox.checked) {
                // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
                document.querySelectorAll('input[name$="-is_main"]').forEach(otherCheckbox => {
                    if (otherCheckbox !== checkbox) {
                        otherCheckbox.checked = false;
                    }
                });
                hasMainImage = true;
            } else {
                // –ï—Å–ª–∏ —Å–Ω—è–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Å–Ω–æ–≤–Ω–æ–π —á–µ–∫–±–æ–∫—Å
                const anyChecked = Array.from(document.querySelectorAll('input[name$="-is_main"]')).some(cb => cb.checked);
                if (!anyChecked) {
                    hasMainImage = false;
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    updateMainCheckboxes();
                }
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ —Å–≤–µ—Ç–ª–æ-—Å–µ—Ä–æ–≥–æ —Ü–≤–µ—Ç–∞
        function setPlaceholders() {
            if (titleField) {
                titleField.placeholder = translations.productNamePlaceholder;
            }
            if (descriptionField) {
                descriptionField.placeholder = translations.descriptionPlaceholder;
            }
            if (priceField) {
                priceField.placeholder = translations.pricePlaceholder;
            }
            if (categoryField) {
                // –î–ª—è select –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é-–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
                const firstOption = categoryField.querySelector('option');
                if (firstOption && firstOption.value === '') {
                    firstOption.textContent = translations.chooseCategory;
                    firstOption.disabled = true;
                    firstOption.selected = true;
                }
            }
        }

        // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤
        setPlaceholders();

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–Ω–æ–ø–æ–∫ –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
        function setupClearFieldButtons() {
            // –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
            const textFields = [
                titleField,
                descriptionField,
                priceField,
                categoryField
            ];

            textFields.forEach(field => {
                if (!field) return;

                const clearBtn = field.parentNode.querySelector('.btn-clear-field');
                if (!clearBtn) return;

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
                function toggleClearButton() {
                    if (field.tagName === 'SELECT') {
                        clearBtn.style.display = field.value && field.value !== '' ? 'flex' : 'none';
                    } else {
                        clearBtn.style.display = field.value && field.value.trim() !== '' ? 'flex' : 'none';
                    }
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                field.addEventListener('input', toggleClearButton);
                field.addEventListener('change', toggleClearButton);

                clearBtn.addEventListener('click', function () {
                    if (field.tagName === 'SELECT') {
                        field.selectedIndex = 0;
                    } else {
                        field.value = '';
                    }
                    toggleClearButton();
                    field.focus();
                });

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏
                toggleClearButton();
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function setupImageRemoveButtons() {
            // –î–ª—è –Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–±–µ–∑ instance)
            document.querySelectorAll('.image-form:not(.has-existing) input[type="file"]').forEach(fileInput => {
                const removeBtn = fileInput.closest('.image-form').querySelector('.btn-remove-image');
                if (!removeBtn) return;

                fileInput.addEventListener('change', function () {
                    removeBtn.style.display = this.files.length > 0 ? 'flex' : 'none';
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
                    updateMainCheckboxes();
                });

                removeBtn.addEventListener('click', function () {
                    fileInput.value = '';
                    removeBtn.style.display = 'none';

                    // –¢–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º preview –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                    const preview = fileInput.closest('.image-form').querySelector('img');
                    if (preview && preview.src.startsWith('blob:')) {
                        preview.src = '';
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
                    updateMainCheckboxes();
                });
            });

            // –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            document.querySelectorAll('.btn-remove-existing-image').forEach(btn => {
                btn.addEventListener('click', function () {
                    const imageForm = this.closest('.image-form');
                    const fileInput = imageForm.querySelector('input[type="file"]');
                    const deleteCheckbox = imageForm.querySelector('input[type="checkbox"][name*="DELETE"]');

                    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ –∑–∞–º–µ–Ω—ã –∏ –æ–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
                    const replaceField = imageForm.querySelector('.image-upload-field');
                    if (replaceField && replaceField.style.display !== 'none') {
                        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –∑–∞–º–µ–Ω—ã –∏ —Å–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
                        if (fileInput) {
                            fileInput.value = '';
                        }
                        replaceField.style.display = 'none';
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        imageForm.querySelector('.existing-image .d-flex').style.display = 'flex';
                    } else if (deleteCheckbox) {
                        // –ü–æ–º–µ—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
                        deleteCheckbox.checked = true;
                        // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                        imageForm.classList.add('removing');
                        setTimeout(() => {
                            imageForm.style.display = 'none';
                        }, 300);
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
                    updateMainCheckboxes();
                });
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –æ—á–∏—Å—Ç–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏—è
        setupClearFieldButtons();
        setupImageRemoveButtons();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–º–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        document.querySelectorAll('.replace-image-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const imageForm = this.closest('.existing-image');
                const uploadField = imageForm.querySelector('.image-upload-field');
                const currentImage = imageForm.querySelector('.d-flex');

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏, —Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –∫–Ω–æ–ø–∫—É
                uploadField.style.display = 'block';
                currentImage.style.display = 'none';

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
                const removeBtn = imageForm.closest('.image-form').querySelector('.btn-remove-existing-image');
                if (removeBtn) {
                    removeBtn.style.display = 'flex';
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤
        function updateCounter(field, maxLength) {
            let counter = field.parentNode.querySelector('.char-counter');
            if (!counter) {
                counter = document.createElement('div');
                counter.className = 'form-text char-counter';
                field.parentNode.appendChild(counter);
            }

            const currentLength = field.value.length;
            const remaining = maxLength - currentLength;
            counter.textContent = currentLength + "/" + maxLength + " " + translations.charactersCount + remaining + ")";
            counter.style.color = remaining < 0 ? 'red' : (remaining < 10 ? 'orange' : '#6c757d');

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–æ–ª–µ –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç
            if (remaining < 0) {
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –¥–ª—è –≤—Å–µ—Ö —è–∑—ã–∫–æ–≤)
        function validateText(field, fieldType) {
            const value = field.value;
            let regex;

            if (fieldType === 'title') {
                regex = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9\s\-!\.\(\)]*$/;
            } else {
                regex = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9\s\-!\.\(\)\,\:\;\?]*$/;
            }

            if (!regex.test(value)) {
                field.classList.add('is-invalid');
                return false;
            } else {
                field.classList.remove('is-invalid');
                return true;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function validateImages() {
            const imageForms = document.querySelectorAll('.image-form');
            let hasImage = false;

            imageForms.forEach(form => {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ —Ñ–æ—Ä–º—ã (—É–¥–∞–ª–µ–Ω–Ω—ã–µ)
                if (form.style.display === 'none') {
                    return;
                }

                if (hasImageFile(form)) {
                    hasImage = true;
                }
            });

            return hasImage;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function validateMainImage() {
            const mainCheckboxes = document.querySelectorAll('input[name$="-is_main"]');
            let hasMain = false;

            mainCheckboxes.forEach(checkbox => {
                if (checkbox.checked && hasImageFile(checkbox.closest('.image-form'))) {
                    hasMain = true;
                }
            });

            return hasMain;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        if (titleField) {
            titleField.addEventListener('input', function () {
                updateCounter(this, 60);
                validateText(this, 'title');
            });
            updateCounter(titleField, 60);
            validateText(titleField, 'title');
        }

        if (descriptionField) {
            descriptionField.addEventListener('input', function () {
                updateCounter(this, 300);
                validateText(this, 'description');
            });
            updateCounter(descriptionField, 300);
            validateText(descriptionField, 'description');
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ "–æ—Å–Ω–æ–≤–Ω–æ–µ"
        document.querySelectorAll('input[name$="-is_main"]').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const imageForm = this.closest('.image-form');

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª
                if (this.checked && !hasImageFile(imageForm)) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞, –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ–∫–±–æ–∫—Å
                    this.checked = false;
                    alert(translations.cannotSetMainWithoutFile);
                    return;
                }

                handleMainCheckboxChange(this);
            });
        });

        // –í–ê–õ–ò–î–ê–¶–ò–Ø –¶–ï–ù–´
        if (priceField) {
            // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –£–ë–ò–†–ê–ï–ú –í–°–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ë–†–ê–£–ó–ï–†–ê
            priceField.removeAttribute('maxlength');
            priceField.removeAttribute('max');
            priceField.removeAttribute('min');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø text —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è number input
            priceField.setAttribute('type', 'text');
            priceField.setAttribute('inputmode', 'numeric');

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ª–∏–º–∏—Ç–µ
            const limitInfo = document.createElement('div');
            limitInfo.className = 'price-limit-info';
            limitInfo.textContent = translations.canEnterDigits;
            priceField.parentNode.parentNode.appendChild(limitInfo);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á
            priceField.addEventListener('input', function () {
                let value = this.value.replace(/\s/g, ''); // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã

                // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
                value = value.replace(/\D/g, '');

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ñ—Ä –¥–æ 7 (–¥–ª—è 5 000 000)
                if (value.length > MAX_DIGITS) {
                    value = value.substring(0, MAX_DIGITS);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
                    showPriceInfo(translations.priceLimitReached);
                }

                let numericValue = parseInt(value);

                if (isNaN(numericValue)) {
                    this.value = '';
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
                if (numericValue < MIN_PRICE) {
                    numericValue = MIN_PRICE;
                } else if (numericValue > MAX_PRICE) {
                    numericValue = MAX_PRICE;
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á
                this.value = formatNumber(numericValue);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞ - —É–±–∏—Ä–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            priceField.addEventListener('blur', function () {
                const numericValue = parseFormattedNumber(this.value);
                if (!isNaN(numericValue) && numericValue > 0) {
                    this.value = numericValue;
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ–∫—É—Å–∞ - –¥–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –¥–ª—è —á—Ç–µ–Ω–∏—è
            priceField.addEventListener('focus', function () {
                const numericValue = parseFormattedNumber(this.value);
                if (!isNaN(numericValue) && numericValue > 0) {
                    this.value = formatNumber(numericValue);
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–ª–∞–≤–∏—à - —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤–≤–æ–¥ –ª—é–±—ã—Ö —Ü–∏—Ñ—Ä
            priceField.addEventListener('keydown', function (e) {
                // –†–∞–∑—Ä–µ—à–∞–µ–º: —Ü–∏—Ñ—Ä—ã, Backspace, Delete, Tab, —Å—Ç—Ä–µ–ª–∫–∏, –ø—Ä–æ–±–µ–ª—ã
                if (
                    (e.key >= '0' && e.key <= '9') ||
                    e.key === 'Backspace' ||
                    e.key === 'Delete' ||
                    e.key === 'Tab' ||
                    e.key === 'ArrowLeft' ||
                    e.key === 'ArrowRight' ||
                    e.key === 'Home' ||
                    e.key === 'End' ||
                    e.key === ' '
                ) {
                    return;
                }

                // –ó–∞–ø—Ä–µ—â–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏
                e.preventDefault();
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∫–∞ —Ü–µ–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
            if (priceField.value) {
                const numericValue = parseFormattedNumber(priceField.value);
                if (!isNaN(numericValue) && numericValue > 0) {
                    priceField.value = formatNumber(numericValue);
                }
            }
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
        productForm.addEventListener('submit', function (e) {
            let hasErrors = false;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (categoryField && (!categoryField.value || categoryField.value === '')) {
                showFieldError(categoryField, translations.chooseCategoryError);
                if (!hasErrors) {
                    categoryField.focus();
                    hasErrors = true;
                }
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω—ã
            const numericValue = parseFormattedNumber(priceField.value);
            if (isNaN(numericValue) || numericValue === 0) {
                showPriceError(translations.enterValidPrice);
                priceField.focus();
                hasErrors = true;
            } else if (numericValue < MIN_PRICE) {
                showPriceError(translations.priceMinError);
                priceField.focus();
                hasErrors = true;
            } else if (numericValue > MAX_PRICE) {
                showPriceError(translations.priceMaxError);
                priceField.focus();
                hasErrors = true;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è
            if (titleField && (!titleField.value || titleField.value.trim() === '')) {
                showFieldError(titleField, translations.enterProductName);
                if (!hasErrors) {
                    titleField.focus();
                    hasErrors = true;
                }
            } else if (titleField && !validateText(titleField, 'title')) {
                showFieldError(titleField, translations.nameValidationError);
                if (!hasErrors) {
                    titleField.focus();
                    hasErrors = true;
                }
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏—è
            if (descriptionField && (!descriptionField.value || descriptionField.value.trim() === '')) {
                showFieldError(descriptionField, translations.enterDescription);
                if (!hasErrors) {
                    descriptionField.focus();
                    hasErrors = true;
                }
            } else if (descriptionField && !validateText(descriptionField, 'description')) {
                showFieldError(descriptionField, translations.descriptionValidationError);
                if (!hasErrors) {
                    descriptionField.focus();
                    hasErrors = true;
                }
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            if (!validateImages()) {
                showImagesError(translations.atLeastOneImage);
                hasErrors = true;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if (!validateMainImage()) {
                showImagesError(translations.selectMainImage);
                hasErrors = true;
            }

            if (hasErrors) {
                e.preventDefault();
                return;
            }

            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            if (priceField) {
                priceField.value = numericValue;
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏ —Ü–µ–Ω—ã
        function showPriceError(message) {
            const existingError = document.querySelector('.price-error');
            if (existingError) {
                existingError.remove();
            }

            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-danger small price-error mt-1';
            errorDiv.textContent = message;
            priceField.parentNode.parentNode.appendChild(errorDiv);

            priceField.classList.add('is-invalid');

            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                    priceField.classList.remove('is-invalid');
                }
            }, 5000);
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function showPriceInfo(message) {
            const existingInfo = document.querySelector('.price-info');
            if (existingInfo) {
                existingInfo.remove();
            }

            const infoDiv = document.createElement('div');
            infoDiv.className = 'text-info small price-info mt-1';
            infoDiv.textContent = message;
            priceField.parentNode.parentNode.appendChild(infoDiv);

            setTimeout(() => {
                if (infoDiv.parentNode) {
                    infoDiv.remove();
                }
            }, 2000);
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏ –¥–ª—è –ø–æ–ª–µ–π
        function showFieldError(field, message) {
            const existingError = field.parentNode.querySelector('.field-error');
            if (existingError) {
                existingError.remove();
            }

            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-danger small field-error mt-1';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);

            field.classList.add('is-invalid');

            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                    field.classList.remove('is-invalid');
                }
            }, 5000);
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function showImagesError(message) {
            const existingError = document.querySelector('.images-error');
            if (existingError) {
                existingError.remove();
            }

            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-danger small images-error mt-1';
            errorDiv.textContent = message;

            // –í—Å—Ç–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É –≤ —Ä–∞–∑–¥–µ–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            const imagesSection = document.querySelector('h5.text-brown').closest('.mb-4');
            imagesSection.appendChild(errorDiv);

            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateMainCheckboxes();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.querySelectorAll('input[name$="-is_main"]').forEach(checkbox => {
            if (checkbox.checked && hasImageFile(checkbox.closest('.image-form'))) {
                hasMainImage = true;
            }
        });
    });
</script>
{% endblock %}