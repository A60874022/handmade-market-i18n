{% extends "base.html" %}
{% load static %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä | HandmadeMarket{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="text-center mb-5">
                <h1 class="fw-bold mb-3">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h1>
                <p class="text-muted">–û–±–Ω–æ–≤–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–º handmade-—Ç–æ–≤–∞—Ä–µ</p>
                <p class="text-danger small mt-2">* ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</p>
            </div>

            <!-- –§–æ—Ä–º–∞ -->
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="product-form">
                        {% csrf_token %}

                        <!-- –í—ã–≤–æ–¥ –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã -->
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3 text-brown">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form.category.id_for_label }}" class="form-label">
                                        –ö–∞—Ç–µ–≥–æ—Ä–∏—è <span class="text-danger">*</span>
                                    </label>
                                    <div class="position-relative">
                                        {{ form.category }}
                                        <button type="button" class="btn-clear-field" style="display: none;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if form.category.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.category.errors %}
                                        <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.price.id_for_label }}" class="form-label">
                                        –¶–µ–Ω–∞ (—Ä—É–±.) <span class="text-danger">*</span>
                                    </label>
                                    <div class="price-input-container position-relative">
                                        {{ form.price }}
                                        <span class="price-suffix">‚ÇΩ</span>
                                        <button type="button" class="btn-clear-field" style="display: none;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if form.price.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.price.errors %}
                                        <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">–¶–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 5 000 000 —Ä—É–±–ª–µ–π</div>
                                </div>
                                <div class="col-12">
                                    <label for="{{ form.title.id_for_label }}" class="form-label">
                                        –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ <span class="text-danger">*</span>
                                    </label>
                                    <div class="position-relative">
                                        {{ form.title }}
                                        <button type="button" class="btn-clear-field" style="display: none;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if form.title.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.title.errors %}
                                        <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">–ú–∞–∫—Å–∏–º—É–º 60 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–æ–ª—å–∫–æ –∫–∏—Ä–∏–ª–ª–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ –ø—Ä–æ–±–µ–ª—ã</div>
                                </div>
                                <div class="col-12">
                                    <label for="{{ form.description.id_for_label }}" class="form-label">
                                        –û–ø–∏—Å–∞–Ω–∏–µ <span class="text-danger">*</span>
                                    </label>
                                    <div class="position-relative">
                                        {{ form.description }}
                                        <button type="button" class="btn-clear-field" style="display: none;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if form.description.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.description.errors %}
                                        <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">–ú–∞–∫—Å–∏–º—É–º 300 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–æ–ª—å–∫–æ –∫–∏—Ä–∏–ª–ª–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ –∑–Ω–∞–∫–∏
                                        –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è</div>
                                </div>
                            </div>
                        </div>

                        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3 text-brown">
                                üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ <span class="text-danger">*</span>
                            </h5>

                            <!-- –í–∞–∂–Ω–æ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
                            <div class="alert alert-info mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3" style="font-size: 1.5rem;">üí°</div>
                                    <div>
                                        <strong>–í–∞–∂–Ω–æ!</strong> –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –ª—é–±–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫
                                        –æ—Å–Ω–æ–≤–Ω–æ–µ.
                                        –î–ª—è –Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - –ø–µ—Ä–≤–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–Ω–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–º.
                                    </div>
                                </div>
                            </div>

                            <p class="text-muted mb-3">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ 4 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ.
                                <span class="text-danger">–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.</span>
                            </p>

                            {{ formset.management_form }}
                            <div id="image-forms">
                                <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                                {% for image_form in formset %}
                                {% if image_form.instance.image %}
                                <div class="image-form mb-3 p-3 border rounded bg-light position-relative existing-image-form"
                                    data-form-id="{{ image_form.prefix }}">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <div class="existing-image">
                                                <label class="form-label">–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                                                <div class="d-flex align-items-center gap-3 mb-2">
                                                    <img src="{{ image_form.instance.image.url }}" alt="Current image"
                                                        style="width: 80px; height: 80px; object-fit: cover;"
                                                        class="img-thumbnail">
                                                    <div class="d-flex flex-column gap-1">
                                                        <button type="button"
                                                            class="btn btn-outline-secondary btn-sm replace-image-btn">
                                                            üìÅ –ó–∞–º–µ–Ω–∏—Ç—å
                                                        </button>
                                                        <button type="button"
                                                            class="btn btn-outline-danger btn-sm delete-image-btn">
                                                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="image-upload-field" style="display: none;">
                                                    <div class="position-relative">
                                                        {{ image_form.image }}
                                                    </div>
                                                    <div class="image-preview-container mt-2" style="display: none;">
                                                        <img class="image-preview"
                                                            style="max-width: 100px; max-height: 100px; display: none;">
                                                    </div>
                                                    <div class="form-text mt-1">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞–º–µ–Ω—ã
                                                    </div>
                                                    <div class="mt-2">
                                                        <button type="button"
                                                            class="btn btn-outline-secondary btn-sm cancel-replace-btn">
                                                            ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–º–µ–Ω—É
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            {% if image_form.image.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in image_form.image.errors %}
                                                <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check form-switch mt-3">
                                                {{ image_form.is_main }}
                                                <label class="form-check-label"
                                                    for="{{ image_form.is_main.id_for_label }}">
                                                    –û—Å–Ω–æ–≤–Ω–æ–µ
                                                </label>
                                                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã–º -->
                                                <div class="no-file-message text-danger small mt-1"
                                                    style="display: none;">
                                                    ‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è -->
                                    {{ image_form.DELETE }}
                                    {% for hidden in image_form.hidden_fields %}
                                    {{ hidden }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% endfor %}

                                <!-- –ù–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                                {% for image_form in formset %}
                                {% if not image_form.instance.image %}
                                <div class="image-form mb-3 p-3 border rounded bg-light position-relative new-image-form"
                                    data-form-id="{{ image_form.prefix }}">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <label class="form-label">–ù–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                                            <div class="position-relative">
                                                {{ image_form.image }}
                                            </div>
                                            <div class="image-preview-container mt-2" style="display: none;">
                                                <img class="image-preview"
                                                    style="max-width: 100px; max-height: 100px; display: none;">
                                            </div>
                                            <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>

                                            {% if image_form.image.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in image_form.image.errors %}
                                                <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check form-switch mt-3">
                                                {{ image_form.is_main }}
                                                <label class="form-check-label"
                                                    for="{{ image_form.is_main.id_for_label }}">
                                                    –û—Å–Ω–æ–≤–Ω–æ–µ
                                                </label>
                                                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã–º -->
                                                <div class="no-file-message text-danger small mt-1"
                                                    style="display: none;">
                                                    ‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button"
                                                class="btn btn-outline-danger btn-sm remove-new-image-btn">
                                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                            </button>
                                        </div>
                                    </div>
                                    {% for hidden in image_form.hidden_fields %}
                                    {{ hidden }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                            <div class="text-center mt-3">
                                <button type="button" id="add-more-images" class="btn btn-outline-primary btn-sm">
                                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                </button>
                                <div class="form-text">–ú–∞–∫—Å–∏–º—É–º 4 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <div class="d-flex gap-3 flex-wrap justify-content-center">
                            <button type="submit" class="btn btn-primary btn-lg px-4">
                                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            </button>
                            <a href="{% url 'products:product_detail' object.pk %}"
                                class="btn btn-outline-secondary btn-lg px-4">
                                ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .text-brown {
        color: #8B4513;
    }

    .form-control,
    .form-select {
        border-radius: 10px;
        padding: 0.75rem 1rem;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #8B4513;
        box-shadow: 0 0 0 0.2rem rgba(139, 69, 19, 0.25);
    }

    .image-form {
        transition: all 0.3s ease;
        position: relative;
    }

    .image-form:hover {
        background-color: #f8f9fa !important;
        border-color: #8B4513 !important;
    }

    .btn-primary {
        background-color: #8B4513;
        border-color: #8B4513;
        border-radius: 10px;
        font-weight: 600;
    }

    .btn-primary:hover {
        background-color: #654321;
        border-color: #654321;
    }

    .card {
        border-radius: 15px;
        border: none;
    }

    .text-danger.small {
        font-size: 0.875em;
        margin-top: 0.25rem;
    }

    .price-input-container {
        position: relative;
    }

    .price-suffix {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-weight: 500;
        pointer-events: none;
    }

    .char-counter {
        font-size: 0.875em;
    }

    .is-invalid {
        border-color: #dc3545 !important;
    }

    .price-limit-info {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 2px;
    }

    .existing-image .img-thumbnail {
        border: 2px solid #8B4513;
    }

    .replace-image-btn,
    .delete-image-btn,
    .cancel-replace-btn,
    .remove-new-image-btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.75rem;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤—ã—Ö –∏–Ω–ø—É—Ç–æ–≤ */
    input[type="file"] {
        padding-right: 2.5rem !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    .image-preview-container {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 10px;
        text-align: center;
        background: #f8f9fa;
    }

    .image-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .existing-image-form {
        border-left: 4px solid #28a745 !important;
    }

    .new-image-form {
        border-left: 4px solid #17a2b8 !important;
    }

    .image-deleted {
        opacity: 0.5;
        background-color: #f8d7da !important;
        border-color: #dc3545 !important;
    }

    .image-form.deleted {
        display: none !important;
    }

    .image-marked-for-delete .existing-image .d-flex {
        opacity: 0.5;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ */
    .form-check-input:disabled+.form-check-label {
        color: #6c757d;
        opacity: 0.6;
    }

    .no-file-message {
        font-size: 0.75rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const MIN_PRICE = 1;
        const MAX_PRICE = 5000000;
        const MAX_DIGITS = 7;
        const MAX_IMAGES = 4;

        // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
        const titleField = document.getElementById('{{ form.title.id_for_label }}');
        const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
        const priceField = document.getElementById('{{ form.price.id_for_label }}');
        const categoryField = document.getElementById('{{ form.category.id_for_label }}');
        const productForm = document.getElementById('product-form');
        const managementForm = document.getElementById('id_product_images-TOTAL_FORMS');
        const addMoreBtn = document.getElementById('add-more-images');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let hasMainImage = false;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –µ—Å—Ç—å –ª–∏ —É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª
        function hasImageFile(imageForm) {
            const fileInput = imageForm.querySelector('input[type="file"]');
            const existingImage = imageForm.querySelector('.existing-image');
            const deleteCheckbox = imageForm.querySelector('input[type="checkbox"][name*="DELETE"]');

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –æ–Ω–æ –Ω–µ –ø–æ–º–µ—á–µ–Ω–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
            if (existingImage && (!deleteCheckbox || !deleteCheckbox.checked)) {
                return true;
            }

            // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            if (fileInput && fileInput.files.length > 0) {
                return true;
            }

            return false;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ "–æ—Å–Ω–æ–≤–Ω–æ–µ"
        function updateMainCheckboxes() {
            const imageForms = document.querySelectorAll('.image-form');
            let firstAvailableNewImage = null;

            imageForms.forEach(form => {
                if (form.style.display === 'none') return;
                if (form.classList.contains('image-deleted')) return;

                const checkbox = form.querySelector('input[name$="-is_main"]');
                const hasFile = hasImageFile(form);
                const noFileMessage = form.querySelector('.no-file-message');

                // –ë–ª–æ–∫–∏—Ä—É–µ–º —á–µ–∫–±–æ–∫—Å –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞
                if (!hasFile) {
                    checkbox.disabled = true;
                    if (checkbox.checked) {
                        checkbox.checked = false;
                    }
                    if (noFileMessage) noFileMessage.style.display = 'block';
                } else {
                    checkbox.disabled = false;
                    if (noFileMessage) noFileMessage.style.display = 'none';

                    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    if (!firstAvailableNewImage && form.classList.contains('new-image-form') && !hasMainImage) {
                        firstAvailableNewImage = checkbox;
                    }
                }
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–µ
            if (firstAvailableNewImage && !hasMainImage) {
                firstAvailableNewImage.checked = true;
                hasMainImage = true;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞ "–æ—Å–Ω–æ–≤–Ω–æ–µ"
        function handleMainCheckboxChange(checkbox) {
            const imageForm = checkbox.closest('.image-form');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª
            if (checkbox.checked && !hasImageFile(imageForm)) {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞, –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ–∫–±–æ–∫—Å
                checkbox.checked = false;
                alert('‚ùå –ù–µ–ª—å–∑—è —Å–¥–µ–ª–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–º –±–µ–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞!');
                return;
            }

            if (checkbox.checked) {
                // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
                document.querySelectorAll('input[name$="-is_main"]').forEach(otherCheckbox => {
                    if (otherCheckbox !== checkbox) {
                        otherCheckbox.checked = false;
                    }
                });
                hasMainImage = true;
            } else {
                // –ï—Å–ª–∏ —Å–Ω—è–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Å–Ω–æ–≤–Ω–æ–π —á–µ–∫–±–æ–∫—Å
                const anyChecked = Array.from(document.querySelectorAll('input[name$="-is_main"]')).some(cb => cb.checked);
                if (!anyChecked) {
                    hasMainImage = false;
                }
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤
        function setPlaceholders() {
            if (titleField) titleField.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: –í—è–∑–∞–Ω—ã–π —à–∞—Ä—Ñ —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã';
            if (descriptionField) descriptionField.placeholder = '–û–ø–∏—à–∏—Ç–µ –≤–∞—à —Ç–æ–≤–∞—Ä: –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —Ä–∞–∑–º–µ—Ä—ã, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è...';
            if (priceField) priceField.placeholder = '1000';
            if (categoryField) {
                const firstOption = categoryField.querySelector('option');
                if (firstOption && firstOption.value === '') {
                    firstOption.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
                    firstOption.disabled = true;
                }
            }
        }

        setPlaceholders();

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function setupImagePreviews() {
            document.querySelectorAll('input[type="file"]').forEach(fileInput => {
                fileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    let previewContainer;

                    // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–µ–≤—å—é
                    if (this.closest('.image-upload-field')) {
                        previewContainer = this.closest('.image-upload-field').querySelector('.image-preview-container');
                    } else {
                        previewContainer = this.closest('.position-relative').nextElementSibling;
                    }

                    if (!previewContainer || !previewContainer.classList.contains('image-preview-container')) return;

                    const previewImg = previewContainer.querySelector('.image-preview');

                    if (file && previewImg) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            previewImg.src = e.target.result;
                            previewImg.style.display = 'block';
                            previewContainer.style.display = 'block';
                        };
                        reader.readAsDataURL(file);

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
                        setTimeout(() => {
                            updateMainCheckboxes();
                        }, 100);
                    } else if (previewImg) {
                        previewImg.style.display = 'none';
                        previewContainer.style.display = 'none';
                    }
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–Ω–æ–ø–æ–∫ —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        function setupImageButtons() {
            // –ö–Ω–æ–ø–∫–∞ "–ó–∞–º–µ–Ω–∏—Ç—å" –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            document.querySelectorAll('.replace-image-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const imageForm = this.closest('.existing-image');
                    const uploadField = imageForm.querySelector('.image-upload-field');
                    const currentImage = imageForm.querySelector('.d-flex');

                    uploadField.style.display = 'block';
                    currentImage.style.display = 'none';
                });
            });

            // –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–º–µ–Ω—É"
            document.querySelectorAll('.cancel-replace-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const imageForm = this.closest('.existing-image');
                    const uploadField = imageForm.querySelector('.image-upload-field');
                    const currentImage = imageForm.querySelector('.d-flex');
                    const fileInput = uploadField.querySelector('input[type="file"]');

                    uploadField.style.display = 'none';
                    currentImage.style.display = 'flex';

                    // –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª–æ–≤–æ–µ –ø–æ–ª–µ
                    if (fileInput) {
                        fileInput.value = '';
                        if (fileInput.files) {
                            const dt = new DataTransfer();
                            fileInput.files = dt.files;
                        }

                        // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                        const previewContainer = uploadField.querySelector('.image-preview-container');
                        if (previewContainer) {
                            const previewImg = previewContainer.querySelector('.image-preview');
                            if (previewImg) {
                                previewImg.style.display = 'none';
                                previewContainer.style.display = 'none';
                            }
                        }
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
                    updateMainCheckboxes();
                });
            });

            // –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å" –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            document.querySelectorAll('.delete-image-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const imageForm = this.closest('.existing-image-form');
                    const deleteCheckbox = imageForm.querySelector('input[type="checkbox"][name*="DELETE"]');
                    const uploadField = imageForm.querySelector('.image-upload-field');
                    const currentImage = imageForm.querySelector('.existing-image .d-flex');

                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                        imageForm.classList.add('image-deleted', 'image-marked-for-delete');

                        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –∑–∞–º–µ–Ω—ã –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ
                        if (uploadField) {
                            uploadField.style.display = 'none';
                        }

                        // –ü–æ–º–µ—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω–æ–µ
                        if (currentImage) {
                            currentImage.style.opacity = '0.5';
                        }

                        // –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏
                        btn.disabled = true;
                        const replaceBtn = imageForm.querySelector('.replace-image-btn');
                        if (replaceBtn) {
                            replaceBtn.disabled = true;
                        }

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
                        updateMainCheckboxes();
                    }
                });
            });

            // –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å" –¥–ª—è –Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            document.querySelectorAll('.remove-new-image-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const imageForm = this.closest('.new-image-form');
                    imageForm.remove();

                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                    updateAddMoreButtonVisibility();

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
                    updateMainCheckboxes();
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function setupAddMoreButton() {
            if (!addMoreBtn) return;

            addMoreBtn.addEventListener('click', function () {
                const totalForms = parseInt(managementForm.value);
                const imageForms = document.querySelectorAll('.image-form');

                if (imageForms.length >= MAX_IMAGES) {
                    alert(`–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ${MAX_IMAGES}`);
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ñ–æ—Ä–º—É
                const newFormIndex = totalForms;
                const newFormHtml = `
                    <div class="image-form mb-3 p-3 border rounded bg-light position-relative new-image-form" data-form-id="product_images-${newFormIndex}">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <label class="form-label">–ù–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                                <div class="position-relative">
                                    <input type="file" name="product_images-${newFormIndex}-image" accept="image/*" class="form-control">
                                </div>
                                <div class="image-preview-container mt-2" style="display: none;">
                                    <img class="image-preview" style="max-width: 100px; max-height: 100px; display: none;">
                                </div>
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mt-3">
                                    <input type="checkbox" name="product_images-${newFormIndex}-is_main" class="form-check-input" id="id_product_images-${newFormIndex}-is_main">
                                    <label class="form-check-label" for="id_product_images-${newFormIndex}-is_main">–û—Å–Ω–æ–≤–Ω–æ–µ</label>
                                    <div class="no-file-message text-danger small mt-1" style="display: none;">
                                        ‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-danger btn-sm remove-new-image-btn">
                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                        <input type="hidden" name="product_images-${newFormIndex}-id" id="id_product_images-${newFormIndex}-id">
                    </div>
                `;

                document.getElementById('image-forms').insertAdjacentHTML('beforeend', newFormHtml);
                managementForm.value = newFormIndex + 1;

                // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤–æ–π —Ñ–æ—Ä–º—ã
                setupImageButtons();
                setupImagePreviews();
                setupMainImageToggle();

                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                updateAddMoreButtonVisibility();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
                updateMainCheckboxes();
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –µ—â–µ"
        function updateAddMoreButtonVisibility() {
            if (!addMoreBtn) return;
            const imageForms = document.querySelectorAll('.image-form');
            addMoreBtn.style.display = imageForms.length >= MAX_IMAGES ? 'none' : 'block';
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ "–æ—Å–Ω–æ–≤–Ω–æ–µ"
        function setupMainImageToggle() {
            document.querySelectorAll('input[name$="-is_main"]').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    handleMainCheckboxChange(this);
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤
        function updateCounter(field, maxLength) {
            let counter = field.parentNode.querySelector('.char-counter');
            if (!counter) {
                counter = document.createElement('div');
                counter.className = 'form-text char-counter';
                field.parentNode.appendChild(counter);
            }

            const currentLength = field.value.length;
            const remaining = maxLength - currentLength;
            counter.textContent = `${currentLength}/${maxLength} —Å–∏–º–≤–æ–ª–æ–≤ (–æ—Å—Ç–∞–ª–æ—Å—å: ${remaining})`;
            counter.style.color = remaining < 0 ? 'red' : (remaining < 10 ? 'orange' : '#6c757d');

            if (remaining < 0) {
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
        function validateCyrillic(field, fieldType) {
            const value = field.value;
            let regex;

            if (fieldType === 'title') {
                regex = /^[–∞-—è–ê-–Ø—ë–Å0-9\s\-\!\.\(\)]*$/;
            } else {
                regex = /^[–∞-—è–ê-–Ø—ë–Å0-9\s\-\!\.\(\)\,\:\;]*$/;
            }

            if (!regex.test(value)) {
                field.classList.add('is-invalid');
                return false;
            } else {
                field.classList.remove('is-invalid');
                return true;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function validateImages() {
            const imageForms = document.querySelectorAll('.image-form');
            let hasImage = false;

            imageForms.forEach(form => {
                if (form.classList.contains('image-deleted')) {
                    return;
                }

                if (hasImageFile(form)) {
                    hasImage = true;
                }
            });

            return hasImage;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function validateMainImage() {
            const mainCheckboxes = document.querySelectorAll('input[name$="-is_main"]');
            let hasMain = false;

            mainCheckboxes.forEach(checkbox => {
                if (checkbox.checked && hasImageFile(checkbox.closest('.image-form'))) {
                    hasMain = true;
                }
            });

            return hasMain;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        function initializeAllHandlers() {
            setupImagePreviews();
            setupImageButtons();
            setupMainImageToggle();
            setupAddMoreButton();
            updateAddMoreButtonVisibility();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤
            if (titleField) {
                titleField.addEventListener('input', function () {
                    updateCounter(this, 60);
                    validateCyrillic(this, 'title');
                });
                updateCounter(titleField, 60);
            }

            if (descriptionField) {
                descriptionField.addEventListener('input', function () {
                    updateCounter(this, 300);
                    validateCyrillic(this, 'description');
                });
                updateCounter(descriptionField, 300);
            }
        }

        // –í–ê–õ–ò–î–ê–¶–ò–Ø –¶–ï–ù–´
        if (priceField) {
            priceField.removeAttribute('maxlength');
            priceField.removeAttribute('max');
            priceField.removeAttribute('min');
            priceField.setAttribute('type', 'text');
            priceField.setAttribute('inputmode', 'numeric');

            const limitInfo = document.createElement('div');
            limitInfo.className = 'price-limit-info';
            limitInfo.textContent = `–ú–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –¥–æ ${MAX_DIGITS} —Ü–∏—Ñ—Ä`;
            priceField.parentNode.parentNode.appendChild(limitInfo);

            priceField.addEventListener('input', function () {
                let value = this.value.replace(/\s/g, '');
                value = value.replace(/\D/g, '');

                if (value.length > MAX_DIGITS) {
                    value = value.substring(0, MAX_DIGITS);
                }

                let numericValue = parseInt(value);
                if (isNaN(numericValue)) {
                    this.value = '';
                    return;
                }

                if (numericValue < MIN_PRICE) numericValue = MIN_PRICE;
                if (numericValue > MAX_PRICE) numericValue = MAX_PRICE;

                this.value = formatNumber(numericValue);
            });

            priceField.addEventListener('blur', function () {
                const numericValue = parseFormattedNumber(this.value);
                if (!isNaN(numericValue) && numericValue > 0) {
                    this.value = numericValue;
                }
            });

            priceField.addEventListener('focus', function () {
                const numericValue = parseFormattedNumber(this.value);
                if (!isNaN(numericValue) && numericValue > 0) {
                    this.value = formatNumber(numericValue);
                }
            });

            priceField.addEventListener('keydown', function (e) {
                if (
                    (e.key >= '0' && e.key <= '9') ||
                    e.key === 'Backspace' ||
                    e.key === 'Delete' ||
                    e.key === 'Tab' ||
                    e.key === 'ArrowLeft' ||
                    e.key === 'ArrowRight' ||
                    e.key === 'Home' ||
                    e.key === 'End' ||
                    e.key === ' '
                ) {
                    return;
                }
                e.preventDefault();
            });

            if (priceField.value) {
                const numericValue = parseFormattedNumber(priceField.value);
                if (!isNaN(numericValue) && numericValue > 0) {
                    priceField.value = formatNumber(numericValue);
                }
            }
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
        productForm.addEventListener('submit', function (e) {
            let hasErrors = false;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (categoryField && (!categoryField.value || categoryField.value === '')) {
                showFieldError(categoryField, '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞');
                if (!hasErrors) {
                    categoryField.focus();
                    hasErrors = true;
                }
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω—ã
            if (priceField) {
                const numericValue = parseFormattedNumber(priceField.value);
                if (isNaN(numericValue) || numericValue === 0) {
                    showPriceError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É');
                    if (!hasErrors) {
                        priceField.focus();
                        hasErrors = true;
                    }
                } else if (numericValue < MIN_PRICE) {
                    showPriceError('–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 1 —Ä—É–±–ª—è');
                    if (!hasErrors) {
                        priceField.focus();
                        hasErrors = true;
                    }
                } else if (numericValue > MAX_PRICE) {
                    showPriceError(`–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å ${formatNumber(MAX_PRICE)} —Ä—É–±–ª–µ–π`);
                    if (!hasErrors) {
                        priceField.focus();
                        hasErrors = true;
                    }
                }
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è
            if (titleField && (!titleField.value || titleField.value.trim() === '')) {
                showFieldError(titleField, '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞');
                if (!hasErrors) {
                    titleField.focus();
                    hasErrors = true;
                }
            } else if (titleField && !validateCyrillic(titleField, 'title')) {
                showFieldError(titleField, '–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø—Ä–æ–±–µ–ª—ã');
                if (!hasErrors) {
                    titleField.focus();
                    hasErrors = true;
                }
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏—è
            if (descriptionField && (!descriptionField.value || descriptionField.value.trim() === '')) {
                showFieldError(descriptionField, '–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞');
                if (!hasErrors) {
                    descriptionField.focus();
                    hasErrors = true;
                }
            } else if (descriptionField && !validateCyrillic(descriptionField, 'description')) {
                showFieldError(descriptionField, '–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã, —Ü–∏—Ñ—Ä—ã –∏ –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è');
                if (!hasErrors) {
                    descriptionField.focus();
                    hasErrors = true;
                }
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            if (!validateImages()) {
                showImagesError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞');
                hasErrors = true;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if (!validateMainImage()) {
                showImagesError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                hasErrors = true;
            }

            if (hasErrors) {
                e.preventDefault();
                return;
            }

            if (priceField) {
                const numericValue = parseFormattedNumber(priceField.value);
                priceField.value = numericValue;
            }
        });

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        function parseFormattedNumber(formattedNumber) {
            return parseInt(formattedNumber.replace(/\s/g, '')) || 0;
        }

        function showPriceError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-danger small price-error mt-1';
            errorDiv.textContent = message;
            priceField.parentNode.parentNode.appendChild(errorDiv);
            priceField.classList.add('is-invalid');
            setTimeout(() => {
                errorDiv.remove();
                priceField.classList.remove('is-invalid');
            }, 5000);
        }

        function showFieldError(field, message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-danger small field-error mt-1';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
            field.classList.add('is-invalid');
            setTimeout(() => {
                errorDiv.remove();
                field.classList.remove('is-invalid');
            }, 5000);
        }

        function showImagesError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger images-error mt-3';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
            document.querySelector('#image-forms').parentNode.insertBefore(errorDiv, document.querySelector('#image-forms'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        initializeAllHandlers();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateMainCheckboxes();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.querySelectorAll('input[name$="-is_main"]').forEach(checkbox => {
            if (checkbox.checked && hasImageFile(checkbox.closest('.image-form'))) {
                hasMainImage = true;
            }
        });
    });
</script>
{% endblock %}