{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Edit product" %} | HandmadeMarket{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="text-center mb-5">
                <h1 class="fw-bold mb-3">‚úèÔ∏è {% trans "Edit product" %}</h1>
                <p class="text-muted">
                    {% trans "Update information about your handmade product" %}
                </p>
                <p class="text-danger small mt-2">* ‚Äî {% trans "required fields" %}</p>
            </div>

            <!-- –§–æ—Ä–º–∞ -->
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="product-form">
                        {% csrf_token %}

                        <!-- –í—ã–≤–æ–¥ –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã -->
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3 text-brown">üìã {% trans "Basic information" %}</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form.category.id_for_label }}" class="form-label">
                                        {% trans "Category" %} <span class="text-danger">*</span>
                                    </label>
                                    <div class="position-relative">
                                        {{ form.category }}
                                        <button type="button" class="btn-clear-field" style="display: none;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if form.category.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.category.errors %}
                                        <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.price.id_for_label }}" class="form-label">
                                        {% trans "Price (euros)" %} <span class="text-danger">*</span>
                                    </label>
                                    <div class="price-input-container position-relative">
                                        {{ form.price }}
                                        <span class="price-suffix">‚Ç¨</span>
                                        <button type="button" class="btn-clear-field" style="display: none;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if form.price.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.price.errors %}
                                        <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">
                                        {% trans "Integer from 1 to 5,000,000 euros" %}
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="{{ form.title.id_for_label }}" class="form-label">
                                        {% trans "Product name" %} <span class="text-danger">*</span>
                                    </label>
                                    <div class="position-relative">
                                        {{ form.title }}
                                        <button type="button" class="btn-clear-field" style="display: none;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if form.title.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.title.errors %}
                                        <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-12">
                                    <label for="{{ form.description.id_for_label }}" class="form-label">
                                        {% trans "Description" %} <span class="text-danger">*</span>
                                    </label>
                                    <div class="position-relative">
                                        {{ form.description }}
                                        <button type="button" class="btn-clear-field" style="display: none;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% if form.description.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.description.errors %}
                                        <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3 text-brown">
                                üñºÔ∏è {% trans "Product images" %} <span class="text-danger">*</span>
                            </h5>

                            <!-- –í–∞–∂–Ω–æ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
                            <div class="alert alert-info mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3" style="font-size: 1.5rem;">üí°</div>
                                    <div>
                                        <strong>{% trans "Important!" %}</strong>
                                        {% blocktrans trimmed %}
                                        You can choose any uploaded photo as the main one. For new images, the first
                                        uploaded will automatically become the main one.
                                        {% endblocktrans %}
                                    </div>
                                </div>
                            </div>

                            <p class="text-muted mb-3">
                                {% blocktrans trimmed %}
                                You can upload up to 4 photos.
                                <span class="text-danger">
                                    You need to upload at least one image.
                                </span>
                                {% endblocktrans %}
                            </p>

                            {{ formset.management_form }}
                            <div id="image-forms">
                                <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                                {% for image_form in formset %}
                                {% if image_form.instance.image %}
                                <div class="image-form mb-3 p-3 border rounded bg-light position-relative existing-image-form"
                                    data-form-id="{{ image_form.prefix }}">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <div class="existing-image">
                                                <label class="form-label">{% trans "Current image" %}</label>
                                                <div class="d-flex align-items-center gap-3 mb-2">
                                                    <img src="{{ image_form.instance.image.url }}" alt="Current image"
                                                        style="width: 80px; height: 80px; object-fit: cover;"
                                                        class="img-thumbnail">
                                                    <div class="d-flex flex-column gap-1">
                                                        <button type="button"
                                                            class="btn btn-outline-secondary btn-sm replace-image-btn">
                                                            üìÅ {% trans "Replace" %}
                                                        </button>
                                                        <button type="button"
                                                            class="btn btn-outline-danger btn-sm delete-image-btn">
                                                            üóëÔ∏è {% trans "Delete" %}
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="image-upload-field" style="display: none;">
                                                    <div class="position-relative">
                                                        <!-- –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ -->
                                                        <div class="custom-file-input-wrapper mb-3">
                                                            <button type="button"
                                                                class="btn btn-outline-primary btn-sm custom-file-button">
                                                                üìÅ {% trans "Choose File" %}
                                                            </button>
                                                            <span class="file-name-display ms-2 text-muted small">
                                                                {% trans "No file chosen" %}
                                                            </span>
                                                            <!-- –°–∫—Ä—ã—Ç—ã–π input file -->
                                                            {{ image_form.image }}
                                                        </div>
                                                    </div>
                                                    <div class="image-preview-container mt-2" style="display: none;">
                                                        <img class="image-preview"
                                                            style="max-width: 100px; max-height: 100px; display: none;">
                                                    </div>
                                                    <div class="form-text mt-1">
                                                        {% trans "Select a new image to replace" %}
                                                    </div>
                                                    <div class="mt-2">
                                                        <button type="button"
                                                            class="btn btn-outline-secondary btn-sm cancel-replace-btn">
                                                            ‚ùå {% trans "Cancel replacement" %}
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            {% if image_form.image.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in image_form.image.errors %}
                                                <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check form-switch mt-3">
                                                {{ image_form.is_main }}
                                                <label class="form-check-label"
                                                    for="{{ image_form.is_main.id_for_label }}">
                                                    {% trans "Main" %}
                                                </label>
                                                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã–º -->
                                                <div class="no-file-message text-danger small mt-1"
                                                    style="display: none;">
                                                    ‚ùå {% trans "Upload image first" %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è -->
                                    {{ image_form.DELETE }}
                                    {% for hidden in image_form.hidden_fields %}
                                    {{ hidden }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% endfor %}

                                <!-- –ù–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                                {% for image_form in formset %}
                                {% if not image_form.instance.image %}
                                <div class="image-form mb-3 p-3 border rounded bg-light position-relative new-image-form"
                                    data-form-id="{{ image_form.prefix }}">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <label class="form-label">{% trans "New image" %}</label>
                                            <div class="position-relative">
                                                <!-- –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ -->
                                                <div class="custom-file-input-wrapper mb-3">
                                                    <button type="button"
                                                        class="btn btn-outline-primary btn-sm custom-file-button">
                                                        üìÅ {% trans "Choose File" %}
                                                    </button>
                                                    <span class="file-name-display ms-2 text-muted small">
                                                        {% trans "No file chosen" %}
                                                    </span>
                                                    <!-- –°–∫—Ä—ã—Ç—ã–π input file -->
                                                    {{ image_form.image }}
                                                </div>
                                            </div>
                                            <div class="image-preview-container mt-2" style="display: none;">
                                                <img class="image-preview"
                                                    style="max-width: 100px; max-height: 100px; display: none;">
                                            </div>
                                            <div class="form-text">
                                                {% trans "Select image file" %}
                                            </div>

                                            {% if image_form.image.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in image_form.image.errors %}
                                                <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check form-switch mt-3">
                                                {{ image_form.is_main }}
                                                <label class="form-check-label"
                                                    for="{{ image_form.is_main.id_for_label }}">
                                                    {% trans "Main" %}
                                                </label>
                                                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã–º -->
                                                <div class="no-file-message text-danger small mt-1"
                                                    style="display: none;">
                                                    ‚ùå {% trans "Upload image first" %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button"
                                                class="btn btn-outline-danger btn-sm remove-new-image-btn">
                                                üóëÔ∏è {% trans "Delete" %}
                                            </button>
                                        </div>
                                    </div>
                                    {% for hidden in image_form.hidden_fields %}
                                    {{ hidden }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                            <div class="text-center mt-3">
                                <button type="button" id="add-more-images" class="btn btn-outline-primary btn-sm">
                                    ‚ûï {% trans "Add another image" %}
                                </button>
                                <div class="form-text">
                                    {% trans "Maximum 4 images" %}
                                </div>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <div class="d-flex gap-3 flex-wrap justify-content-center">
                            <button type="submit" class="btn btn-primary btn-lg px-4">
                                üíæ {% trans "Save changes" %}
                            </button>
                            <a href="{% url 'products:product_detail' object.pk %}"
                                class="btn btn-outline-secondary btn-lg px-4">
                                ‚ùå {% trans "Cancel" %}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .text-brown {
        color: #8B4513;
    }

    .form-control,
    .form-select {
        border-radius: 10px;
        padding: 0.75rem 1rem;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #8B4513;
        box-shadow: 0 0 0 0.2rem rgba(139, 69, 19, 0.25);
    }

    .image-form {
        transition: all 0.3s ease;
        position: relative;
    }

    .image-form:hover {
        background-color: #f8f9fa !important;
        border-color: #8B4513 !important;
    }

    .btn-primary {
        background-color: #8B4513;
        border-color: #8B4513;
        border-radius: 10px;
        font-weight: 600;
    }

    .btn-primary:hover {
        background-color: #654321;
        border-color: #654321;
    }

    .card {
        border-radius: 15px;
        border: none;
    }

    .text-danger.small {
        font-size: 0.875em;
        margin-top: 0.25rem;
    }

    .price-input-container {
        position: relative;
    }

    .price-suffix {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-weight: 500;
        pointer-events: none;
    }

    .char-counter {
        font-size: 0.875em;
    }

    .is-invalid {
        border-color: #dc3545 !important;
    }

    .price-limit-info {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 2px;
    }

    .existing-image .img-thumbnail {
        border: 2px solid #8B4513;
    }

    .replace-image-btn,
    .delete-image-btn,
    .cancel-replace-btn,
    .remove-new-image-btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.75rem;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤—ã—Ö –∏–Ω–ø—É—Ç–æ–≤ */
    .custom-file-input-wrapper {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .custom-file-input-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 0;
        height: 0;
        pointer-events: none;
    }

    .custom-file-button {
        z-index: 1;
        font-size: 0.8rem;
        padding: 0.25rem 0.75rem;
        white-space: nowrap;
    }

    .file-name-display {
        font-size: 0.8rem;
        color: #6c757d;
        margin-left: 0.5rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 200px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    .image-preview-container {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 10px;
        text-align: center;
        background: #f8f9fa;
    }

    .image-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .existing-image-form {
        border-left: 4px solid #28a745 !important;
    }

    .new-image-form {
        border-left: 4px solid #17a2b8 !important;
    }

    .image-deleted {
        opacity: 0.5;
        background-color: #f8d7da !important;
        border-color: #dc3545 !important;
    }

    .image-form.deleted {
        display: none !important;
    }

    .image-marked-for-delete .existing-image .d-flex {
        opacity: 0.5;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ */
    .form-check-input:disabled+.form-check-label {
        color: #6c757d;
        opacity: 0.6;
    }

    .no-file-message {
        font-size: 0.75rem;
    }
</style>

<script>
    // –û–±—ä–µ–∫—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è JavaScript
    const translations = {
        // –ö–Ω–æ–ø–∫–∏
        replace: "{% trans 'Replace' %}",
        delete: "{% trans 'Delete' %}",
        cancel: "{% trans 'Cancel' %}",
        save: "{% trans 'Save' %}",
        chooseFile: "{% trans 'Choose File' %}",
        noFileChosen: "{% trans 'No file chosen' %}",
        fileSelected: "{% trans 'File selected:' %}",

        // –°–æ–æ–±—â–µ–Ω–∏—è
        selectCategory: "{% trans 'Select category' %}",
        productNamePlaceholder: "{% trans 'For example: Handmade knitted scarf' %}",
        descriptionPlaceholder: "{% trans 'Describe your product: materials, sizes, manufacturing features...' %}",
        pricePlaceholder: "{% trans '1000' %}",
        chooseCategory: "{% trans 'Choose category' %}",
        selectNewImage: "{% trans 'Select a new image to replace' %}",
        selectImageFile: "{% trans 'Select image file' %}",
        cancelReplacement: "{% trans 'Cancel replacement' %}",
        addAnotherImage: "{% trans 'Add another image' %}",
        saveChanges: "{% trans 'Save changes' %}",

        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏
        maxImagesWarning: "{% trans 'Maximum number of images: {{ count }}' %}",
        cannotSetMainWithoutFile: "{% trans 'Cannot set image as main without uploaded file!' %}",
        chooseCategoryError: "{% trans 'Choose product category' %}",
        enterValidPrice: "{% trans 'Enter valid price' %}",
        priceMinError: "{% trans 'Price should be at least 1 euro' %}",
        priceMaxError: "{% trans 'Price cannot exceed {{ max_price }} euros' %}",
        enterProductName: "{% trans 'Enter product name' %}",
        nameValidationError: "{% trans 'Name should contain only letters, numbers and spaces' %}",
        enterDescription: "{% trans 'Enter product description' %}",
        descriptionValidationError: "{% trans 'Description should contain only letters, numbers and punctuation' %}",
        atLeastOneImage: "{% trans 'You need to upload at least one product image' %}",
        selectMainImage: "{% trans 'You need to select main image' %}",

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        important: "{% trans 'Important!' %}",
        firstImageMain: "{% trans 'You can choose any uploaded photo as the main one. For new images - the first uploaded will automatically become the main one.' %}",
        maxImagesText: "{% trans 'Maximum 4 images' %}",
        upTo4Photos: "{% trans 'You can upload up to 4 photos.' %}",
        atLeastOneRequired: "{% trans 'You need to upload at least one image.' %}",
        integerFromTo: "{% trans 'Integer from 1 to 5,000,000 euros' %}",
        max60Chars: "{% trans 'Max. 60 characters, only letters, numbers and spaces' %}",
        max300Chars: "{% trans 'Max. 300 characters, only letters, numbers and punctuation' %}",
        charsLeft: "{% trans 'characters left' %}",

        // –°—Ç–∞—Ç—É—Å—ã
        currentImage: "{% trans 'Current image' %}",
        newImage: "{% trans 'New image' %}",
        main: "{% trans 'Main' %}",
        firstUploadImage: "{% trans 'Upload image first' %}",
        canEnterDigits: "{% trans 'You can enter up to {{ digits }} digits' %}"
    };

    document.addEventListener('DOMContentLoaded', function () {
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const MIN_PRICE = 1;
        const MAX_PRICE = 5000000;
        const MAX_DIGITS = 7;
        const MAX_IMAGES = 4;

        // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
        const titleField = document.getElementById('{{ form.title.id_for_label }}');
        const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
        const priceField = document.getElementById('{{ form.price.id_for_label }}');
        const categoryField = document.getElementById('{{ form.category.id_for_label }}');
        const productForm = document.getElementById('product-form');
        const managementForm = document.getElementById('id_product_images-TOTAL_FORMS');
        const addMoreBtn = document.getElementById('add-more-images');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let hasMainImage = false;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
        function setupCustomFileButtons() {
            document.querySelectorAll('.custom-file-input-wrapper').forEach(wrapper => {
                const fileInput = wrapper.querySelector('input[type="file"]');
                const customButton = wrapper.querySelector('.custom-file-button');
                const fileNameDisplay = wrapper.querySelector('.file-name-display');

                if (fileInput && customButton) {
                    // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π input
                    fileInput.style.display = 'none';

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–Ω–æ–ø–∫–∏
                    customButton.addEventListener('click', function () {
                        fileInput.click();
                    });

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
                    fileInput.addEventListener('change', function (e) {
                        const file = e.target.files[0];
                        if (file && fileNameDisplay) {
                            fileNameDisplay.textContent = translations.fileSelected + ' ' + file.name;
                        } else if (fileNameDisplay) {
                            fileNameDisplay.textContent = translations.noFileChosen;
                        }
                    });
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –µ—Å—Ç—å –ª–∏ —É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª
        function hasImageFile(imageForm) {
            const fileInput = imageForm.querySelector('input[type="file"]');
            const existingImage = imageForm.querySelector('.existing-image');
            const deleteCheckbox = imageForm.querySelector('input[type="checkbox"][name*="DELETE"]');

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –æ–Ω–æ –Ω–µ –ø–æ–º–µ—á–µ–Ω–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
            if (existingImage && (!deleteCheckbox || !deleteCheckbox.checked)) {
                return true;
            }

            // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            if (fileInput && fileInput.files.length > 0) {
                return true;
            }

            return false;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ "–æ—Å–Ω–æ–≤–Ω–æ–µ"
        function updateMainCheckboxes() {
            const imageForms = document.querySelectorAll('.image-form');
            let firstAvailableNewImage = null;

            imageForms.forEach(form => {
                if (form.style.display === 'none') return;
                if (form.classList.contains('image-deleted')) return;

                const checkbox = form.querySelector('input[name$="-is_main"]');
                const hasFile = hasImageFile(form);
                const noFileMessage = form.querySelector('.no-file-message');

                // –ë–ª–æ–∫–∏—Ä—É–µ–º —á–µ–∫–±–æ–∫—Å –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞
                if (!hasFile) {
                    checkbox.disabled = true;
                    if (checkbox.checked) {
                        checkbox.checked = false;
                    }
                    if (noFileMessage) noFileMessage.style.display = 'block';
                } else {
                    checkbox.disabled = false;
                    if (noFileMessage) noFileMessage.style.display = 'none';

                    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    if (!firstAvailableNewImage && form.classList.contains('new-image-form') && !hasMainImage) {
                        firstAvailableNewImage = checkbox;
                    }
                }
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–µ
            if (firstAvailableNewImage && !hasMainImage) {
                firstAvailableNewImage.checked = true;
                hasMainImage = true;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞ "–æ—Å–Ω–æ–≤–Ω–æ–µ"
        function handleMainCheckboxChange(checkbox) {
            const imageForm = checkbox.closest('.image-form');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª
            if (checkbox.checked && !hasImageFile(imageForm)) {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞, –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ–∫–±–æ–∫—Å
                checkbox.checked = false;
                alert(translations.cannotSetMainWithoutFile);
                return;
            }

            if (checkbox.checked) {
                // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
                document.querySelectorAll('input[name$="-is_main"]').forEach(otherCheckbox => {
                    if (otherCheckbox !== checkbox) {
                        otherCheckbox.checked = false;
                    }
                });
                hasMainImage = true;
            } else {
                // –ï—Å–ª–∏ —Å–Ω—è–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Å–Ω–æ–≤–Ω–æ–π —á–µ–∫–±–æ–∫—Å
                const anyChecked = Array.from(document.querySelectorAll('input[name$="-is_main"]')).some(cb => cb.checked);
                if (!anyChecked) {
                    hasMainImage = false;
                }
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤
        function setPlaceholders() {
            if (titleField) titleField.placeholder = translations.productNamePlaceholder;
            if (descriptionField) descriptionField.placeholder = translations.descriptionPlaceholder;
            if (priceField) priceField.placeholder = translations.pricePlaceholder;
            if (categoryField) {
                const firstOption = categoryField.querySelector('option');
                if (firstOption && firstOption.value === '') {
                    firstOption.textContent = translations.chooseCategory;
                    firstOption.disabled = true;
                }
            }
        }

        setPlaceholders();

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function setupImagePreviews() {
            document.querySelectorAll('input[type="file"]').forEach(fileInput => {
                fileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    let previewContainer;

                    // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–µ–≤—å—é
                    if (this.closest('.image-upload-field')) {
                        previewContainer = this.closest('.image-upload-field').querySelector('.image-preview-container');
                    } else {
                        previewContainer = this.closest('.position-relative').nextElementSibling;
                    }

                    if (!previewContainer || !previewContainer.classList.contains('image-preview-container')) return;

                    const previewImg = previewContainer.querySelector('.image-preview');

                    if (file && previewImg) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            previewImg.src = e.target.result;
                            previewImg.style.display = 'block';
                            previewContainer.style.display = 'block';
                        };
                        reader.readAsDataURL(file);

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
                        setTimeout(() => {
                            updateMainCheckboxes();
                        }, 100);
                    } else if (previewImg) {
                        previewImg.style.display = 'none';
                        previewContainer.style.display = 'none';
                    }
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–Ω–æ–ø–æ–∫ —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        function setupImageButtons() {
            // –ö–Ω–æ–ø–∫–∞ "–ó–∞–º–µ–Ω–∏—Ç—å" –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            document.querySelectorAll('.replace-image-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const imageForm = this.closest('.existing-image');
                    const uploadField = imageForm.querySelector('.image-upload-field');
                    const currentImage = imageForm.querySelector('.d-flex');

                    uploadField.style.display = 'block';
                    currentImage.style.display = 'none';
                });
            });

            // –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–º–µ–Ω—É"
            document.querySelectorAll('.cancel-replace-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const imageForm = this.closest('.existing-image');
                    const uploadField = imageForm.querySelector('.image-upload-field');
                    const currentImage = imageForm.querySelector('.d-flex');
                    const fileInput = uploadField.querySelector('input[type="file"]');
                    const fileNameDisplay = uploadField.querySelector('.file-name-display');

                    uploadField.style.display = 'none';
                    currentImage.style.display = 'flex';

                    // –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª–æ–≤–æ–µ –ø–æ–ª–µ
                    if (fileInput) {
                        fileInput.value = '';
                        if (fileInput.files) {
                            const dt = new DataTransfer();
                            fileInput.files = dt.files;
                        }

                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
                        if (fileNameDisplay) {
                            fileNameDisplay.textContent = translations.noFileChosen;
                        }

                        // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                        const previewContainer = uploadField.querySelector('.image-preview-container');
                        if (previewContainer) {
                            const previewImg = previewContainer.querySelector('.image-preview');
                            if (previewImg) {
                                previewImg.style.display = 'none';
                                previewContainer.style.display = 'none';
                            }
                        }
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
                    updateMainCheckboxes();
                });
            });

            // –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å" –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            document.querySelectorAll('.delete-image-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const imageForm = this.closest('.existing-image-form');
                    const deleteCheckbox = imageForm.querySelector('input[type="checkbox"][name*="DELETE"]');
                    const uploadField = imageForm.querySelector('.image-upload-field');
                    const currentImage = imageForm.querySelector('.existing-image .d-flex');

                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                        imageForm.classList.add('image-deleted', 'image-marked-for-delete');

                        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –∑–∞–º–µ–Ω—ã –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ
                        if (uploadField) {
                            uploadField.style.display = 'none';
                        }

                        // –ü–æ–º–µ—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω–æ–µ
                        if (currentImage) {
                            currentImage.style.opacity = '0.5';
                        }

                        // –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏
                        btn.disabled = true;
                        const replaceBtn = imageForm.querySelector('.replace-image-btn');
                        if (replaceBtn) {
                            replaceBtn.disabled = true;
                        }

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
                        updateMainCheckboxes();
                    }
                });
            });

            // –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å" –¥–ª—è –Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            document.querySelectorAll('.remove-new-image-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const imageForm = this.closest('.new-image-form');
                    imageForm.remove();

                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                    updateAddMoreButtonVisibility();

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
                    updateMainCheckboxes();
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function setupAddMoreButton() {
            if (!addMoreBtn) return;

            addMoreBtn.addEventListener('click', function () {
                const totalForms = parseInt(managementForm.value);
                const imageForms = document.querySelectorAll('.image-form');

                if (imageForms.length >= MAX_IMAGES) {
                    alert(translations.maxImagesWarning.replace('{{ count }}', MAX_IMAGES));
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ñ–æ—Ä–º—É
                const newFormIndex = totalForms;
                const newFormHtml = `
                    <div class="image-form mb-3 p-3 border rounded bg-light position-relative new-image-form" data-form-id="product_images-${newFormIndex}">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <label class="form-label">${translations.newImage}</label>
                                <div class="position-relative">
                                    <div class="custom-file-input-wrapper mb-3">
                                        <button type="button" class="btn btn-outline-primary btn-sm custom-file-button">
                                            üìÅ ${translations.chooseFile}
                                        </button>
                                        <span class="file-name-display ms-2 text-muted small">${translations.noFileChosen}</span>
                                        <input type="file" name="product_images-${newFormIndex}-image" accept="image/*" class="form-control">
                                    </div>
                                </div>
                                <div class="image-preview-container mt-2" style="display: none;">
                                    <img class="image-preview" style="max-width: 100px; max-height: 100px; display: none;">
                                </div>
                                <div class="form-text">${translations.selectImageFile}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mt-3">
                                    <input type="checkbox" name="product_images-${newFormIndex}-is_main" class="form-check-input" id="id_product_images-${newFormIndex}-is_main">
                                    <label class="form-check-label" for="id_product_images-${newFormIndex}-is_main">${translations.main}</label>
                                    <div class="no-file-message text-danger small mt-1" style="display: none;">
                                        ‚ùå ${translations.firstUploadImage}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-danger btn-sm remove-new-image-btn">
                                    üóëÔ∏è ${translations.delete}
                                </button>
                            </div>
                        </div>
                        <input type="hidden" name="product_images-${newFormIndex}-id" id="id_product_images-${newFormIndex}-id">
                    </div>
                `;

                document.getElementById('image-forms').insertAdjacentHTML('beforeend', newFormHtml);
                managementForm.value = newFormIndex + 1;

                // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤–æ–π —Ñ–æ—Ä–º—ã
                setupCustomFileButtons();
                setupImageButtons();
                setupImagePreviews();
                setupMainImageToggle();

                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                updateAddMoreButtonVisibility();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
                updateMainCheckboxes();
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –µ—â–µ"
        function updateAddMoreButtonVisibility() {
            if (!addMoreBtn) return;
            const imageForms = document.querySelectorAll('.image-form');
            addMoreBtn.style.display = imageForms.length >= MAX_IMAGES ? 'none' : 'block';
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ "–æ—Å–Ω–æ–≤–Ω–æ–µ"
        function setupMainImageToggle() {
            document.querySelectorAll('input[name$="-is_main"]').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    handleMainCheckboxChange(this);
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤
        function updateCounter(field, maxLength) {
            let counter = field.parentNode.querySelector('.char-counter');
            if (!counter) {
                counter = document.createElement('div');
                counter.className = 'form-text char-counter';
                field.parentNode.appendChild(counter);
            }

            const currentLength = field.value.length;
            const remaining = maxLength - currentLength;
            counter.textContent = `${currentLength}/${maxLength} ${translations.charsLeft}: ${remaining}`;
            counter.style.color = remaining < 0 ? 'red' : (remaining < 10 ? 'orange' : '#6c757d');

            if (remaining < 0) {
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –¥–ª—è –≤—Å–µ—Ö —è–∑—ã–∫–æ–≤)
        function validateText(field, fieldType) {
            const value = field.value;
            let regex;

            if (fieldType === 'title') {
                // –†–∞–∑—Ä–µ—à–∞–µ–º –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —è–∑—ã–∫–æ–≤
                regex = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9\s\-!\.\(\)]*$/;
            } else {
                // –î–ª—è –æ–ø–∏—Å–∞–Ω–∏—è —Ä–∞–∑—Ä–µ—à–∞–µ–º –±–æ–ª—å—à–µ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
                regex = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9\s\-!\.\(\)\,\:\;\?]*$/;
            }

            if (!regex.test(value)) {
                field.classList.add('is-invalid');
                return false;
            } else {
                field.classList.remove('is-invalid');
                return true;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function validateImages() {
            const imageForms = document.querySelectorAll('.image-form');
            let hasImage = false;

            imageForms.forEach(form => {
                if (form.classList.contains('image-deleted')) {
                    return;
                }

                if (hasImageFile(form)) {
                    hasImage = true;
                }
            });

            return hasImage;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function validateMainImage() {
            const mainCheckboxes = document.querySelectorAll('input[name$="-is_main"]');
            let hasMain = false;

            mainCheckboxes.forEach(checkbox => {
                if (checkbox.checked && hasImageFile(checkbox.closest('.image-form'))) {
                    hasMain = true;
                }
            });

            return hasMain;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        function initializeAllHandlers() {
            setupCustomFileButtons();
            setupImagePreviews();
            setupImageButtons();
            setupMainImageToggle();
            setupAddMoreButton();
            updateAddMoreButtonVisibility();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤
            if (titleField) {
                titleField.addEventListener('input', function () {
                    updateCounter(this, 60);
                    validateText(this, 'title');
                });
                updateCounter(titleField, 60);
            }

            if (descriptionField) {
                descriptionField.addEventListener('input', function () {
                    updateCounter(this, 300);
                    validateText(this, 'description');
                });
                updateCounter(descriptionField, 300);
            }
        }

        // –í–ê–õ–ò–î–ê–¶–ò–Ø –¶–ï–ù–´
        if (priceField) {
            priceField.removeAttribute('maxlength');
            priceField.removeAttribute('max');
            priceField.removeAttribute('min');
            priceField.setAttribute('type', 'text');
            priceField.setAttribute('inputmode', 'numeric');

            const limitInfo = document.createElement('div');
            limitInfo.className = 'price-limit-info';
            limitInfo.textContent = translations.canEnterDigits.replace('{{ digits }}', MAX_DIGITS);
            priceField.parentNode.parentNode.appendChild(limitInfo);

            priceField.addEventListener('input', function () {
                let value = this.value.replace(/\s/g, '');
                value = value.replace(/\D/g, '');

                if (value.length > MAX_DIGITS) {
                    value = value.substring(0, MAX_DIGITS);
                }

                let numericValue = parseInt(value);
                if (isNaN(numericValue)) {
                    this.value = '';
                    return;
                }

                if (numericValue < MIN_PRICE) numericValue = MIN_PRICE;
                if (numericValue > MAX_PRICE) numericValue = MAX_PRICE;

                this.value = formatNumber(numericValue);
            });

            priceField.addEventListener('blur', function () {
                const numericValue = parseFormattedNumber(this.value);
                if (!isNaN(numericValue) && numericValue > 0) {
                    this.value = numericValue;
                }
            });

            priceField.addEventListener('focus', function () {
                const numericValue = parseFormattedNumber(this.value);
                if (!isNaN(numericValue) && numericValue > 0) {
                    this.value = formatNumber(numericValue);
                }
            });

            priceField.addEventListener('keydown', function (e) {
                if (
                    (e.key >= '0' && e.key <= '9') ||
                    e.key === 'Backspace' ||
                    e.key === 'Delete' ||
                    e.key === 'Tab' ||
                    e.key === 'ArrowLeft' ||
                    e.key === 'ArrowRight' ||
                    e.key === 'Home' ||
                    e.key === 'End' ||
                    e.key === ' '
                ) {
                    return;
                }
                e.preventDefault();
            });

            if (priceField.value) {
                const numericValue = parseFormattedNumber(priceField.value);
                if (!isNaN(numericValue) && numericValue > 0) {
                    priceField.value = formatNumber(numericValue);
                }
            }
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
        productForm.addEventListener('submit', function (e) {
            let hasErrors = false;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (categoryField && (!categoryField.value || categoryField.value === '')) {
                showFieldError(categoryField, translations.chooseCategoryError);
                if (!hasErrors) {
                    categoryField.focus();
                    hasErrors = true;
                }
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω—ã
            if (priceField) {
                const numericValue = parseFormattedNumber(priceField.value);
                if (isNaN(numericValue) || numericValue === 0) {
                    showPriceError(translations.enterValidPrice);
                    if (!hasErrors) {
                        priceField.focus();
                        hasErrors = true;
                    }
                } else if (numericValue < MIN_PRICE) {
                    showPriceError(translations.priceMinError);
                    if (!hasErrors) {
                        priceField.focus();
                        hasErrors = true;
                    }
                } else if (numericValue > MAX_PRICE) {
                    showPriceError(translations.priceMaxError.replace('{{ max_price }}', formatNumber(MAX_PRICE)));
                    if (!hasErrors) {
                        priceField.focus();
                        hasErrors = true;
                    }
                }
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è
            if (titleField && (!titleField.value || titleField.value.trim() === '')) {
                showFieldError(titleField, translations.enterProductName);
                if (!hasErrors) {
                    titleField.focus();
                    hasErrors = true;
                }
            } else if (titleField && !validateText(titleField, 'title')) {
                showFieldError(titleField, translations.nameValidationError);
                if (!hasErrors) {
                    titleField.focus();
                    hasErrors = true;
                }
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏—è
            if (descriptionField && (!descriptionField.value || descriptionField.value.trim() === '')) {
                showFieldError(descriptionField, translations.enterDescription);
                if (!hasErrors) {
                    descriptionField.focus();
                    hasErrors = true;
                }
            } else if (descriptionField && !validateText(descriptionField, 'description')) {
                showFieldError(descriptionField, translations.descriptionValidationError);
                if (!hasErrors) {
                    descriptionField.focus();
                    hasErrors = true;
                }
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            if (!validateImages()) {
                showImagesError(translations.atLeastOneImage);
                hasErrors = true;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if (!validateMainImage()) {
                showImagesError(translations.selectMainImage);
                hasErrors = true;
            }

            if (hasErrors) {
                e.preventDefault();
                return;
            }

            if (priceField) {
                const numericValue = parseFormattedNumber(priceField.value);
                priceField.value = numericValue;
            }
        });

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        function parseFormattedNumber(formattedNumber) {
            return parseInt(formattedNumber.replace(/\s/g, '')) || 0;
        }

        function showPriceError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-danger small price-error mt-1';
            errorDiv.textContent = message;
            priceField.parentNode.parentNode.appendChild(errorDiv);
            priceField.classList.add('is-invalid');
            setTimeout(() => {
                errorDiv.remove();
                priceField.classList.remove('is-invalid');
            }, 5000);
        }

        function showFieldError(field, message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-danger small field-error mt-1';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
            field.classList.add('is-invalid');
            setTimeout(() => {
                errorDiv.remove();
                field.classList.remove('is-invalid');
            }, 5000);
        }

        function showImagesError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger images-error mt-3';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
            document.querySelector('#image-forms').parentNode.insertBefore(errorDiv, document.querySelector('#image-forms'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        initializeAllHandlers();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateMainCheckboxes();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.querySelectorAll('input[name$="-is_main"]').forEach(checkbox => {
            if (checkbox.checked && hasImageFile(checkbox.closest('.image-form'))) {
                hasMainImage = true;
            }
        });
    });
</script>
{% endblock %}