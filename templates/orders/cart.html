{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% trans "Shopping Cart" %} | HandmadeMarket{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="fw-bold mb-2">üõí {% trans "Shopping Cart" %}</h1>

            {% if cart_items %}
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    {% for item in cart_items %}
                    <div class="row align-items-center mb-4 pb-4 border-bottom">
                        <div class="col-md-2">
                            {% if item.product.images.all %}
                            <img src="{{ item.product.images.first.image.url }}" class="img-fluid rounded"
                                alt="{{ item.product.title }}" style="width: 100px; height: 100px; object-fit: cover;">
                            {% else %}
                            <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                style="width: 100px; height: 100px;">
                                <span class="text-muted">üé®</span>
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <h6 class="fw-bold mb-1">{{ item.product.title }}</h6>
                            <p class="text-muted small mb-1">{{ item.product.description|truncatewords:15 }}</p>
                            <small class="text-muted">
                                üé® {% trans "Master:" %}
                                {% if item.product.master.get_full_name %}
                                {{ item.product.master.get_full_name }}
                                {% else %}
                                {{ item.product.master.email }}
                                {% endif %}
                            </small>
                        </div>

                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <form method="post" action="{% url 'orders:update_cart_item' item.id %}"
                                    class="d-flex align-items-center cart-item-form">
                                    {% csrf_token %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm decrement"
                                        data-item-id="{{ item.id }}">-</button>
                                    <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="99"
                                        class="form-control form-control-sm mx-2 text-center quantity-input"
                                        style="width: 60px;" data-item-id="{{ item.id }}">
                                    <button type="button" class="btn btn-outline-secondary btn-sm increment"
                                        data-item-id="{{ item.id }}">+</button>
                                </form>
                            </div>
                            <div class="text-danger small mt-1 validation-message" id="validation-{{ item.id }}"
                                style="display: none;">
                                {% trans "Quantity must be from 1 to 99" %}
                            </div>
                        </div>

                        <div class="col-md-2 text-center">
                            <span class="fw-bold text-brown h5">{{ item.total_price }} ‚ÇΩ</span>
                            <div class="text-muted small">{% trans "per piece:" %} {{ item.product.price }} ‚ÇΩ</div>
                        </div>

                        <div class="col-md-1 text-end">
                            <form method="post" action="{% url 'orders:remove_from_cart' item.id %}"
                                class="remove-form">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-danger btn-sm"
                                    onclick="return confirm('{% trans 'Remove product from cart?' %}')">
                                    ‚úï
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="card-footer bg-white">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="fw-bold text-brown mb-0">{% trans "Total:" %} {{ cart.total_price }} ‚ÇΩ</h4>
                            <small class="text-muted">{% trans "For" %} {{ cart.total_quantity }} {% trans "product(s)"
                                %}</small>
                        </div>
                        <div class="col-md-6 text-end">
                            <form method="post" action="{% url 'orders:create_order' %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary btn-lg px-5">
                                    üõí {% trans "Place Order" %}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <a href="{% url 'products:catalog' %}" class="btn btn-outline-secondary">
                    ‚Üê {% trans "Continue Shopping" %}
                </a>
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="mb-4" style="font-size: 4rem;">üõí</div>
                <h3 class="fw-bold mb-3">{% trans "Your cart is empty" %}</h3>
                <p class="text-muted mb-4">{% trans "Add products from the catalog to place an order" %}</p>
                <a href="{% url 'products:catalog' %}" class="btn btn-primary btn-lg px-4">
                    üõçÔ∏è {% trans "Go to Catalog" %}
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .text-brown {
        color: #8B4513;
    }

    .btn-primary {
        background-color: #8B4513;
        border-color: #8B4513;
        border-radius: 10px;
        font-weight: 600;
    }

    .btn-primary:hover {
        background-color: #654321;
        border-color: #654321;
    }
</style>

<script>
    // –û–±—ä–µ–∫—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è JavaScript
    const translations = {
        removeFromCart: "{% trans 'Remove product from cart?' %}",
        quantityValidation: "{% trans 'Quantity must be from 1 to 99' %}",
        productRemoval: "{% trans 'Remove product from cart?' %}"
    };

    document.addEventListener('DOMContentLoaded', function () {
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        function validateQuantity(value) {
            return value >= 1 &amp;&amp; value <= 99;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞
        function updateQuantity(itemId, newQuantity) {
            const form = document.querySelector(`.cart-item-form [data-item-id="${itemId}"]`).closest('form');
            const input = form.querySelector('input[name="quantity"]');

            if (validateQuantity(newQuantity)) {
                input.value = newQuantity;
                form.submit();
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                const validationMessage = document.getElementById(`validation-${itemId}`);
                validationMessage.style.display = 'block';

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –≤–∞–ª–∏–¥–Ω–æ–º—É
                input.value = input.defaultValue;

                // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    validationMessage.style.display = 'none';
                }, 3000);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ +/-
        document.querySelectorAll('.increment').forEach(button => {
            button.addEventListener('click', function () {
                const itemId = this.getAttribute('data-item-id');
                const input = this.parentElement.querySelector('input[name="quantity"]');
                const currentValue = parseInt(input.value);
                updateQuantity(itemId, currentValue + 1);
            });
        });

        document.querySelectorAll('.decrement').forEach(button => {
            button.addEventListener('click', function () {
                const itemId = this.getAttribute('data-item-id');
                const input = this.parentElement.querySelector('input[name="quantity"]');
                const currentValue = parseInt(input.value);

                if (currentValue > 1) {
                    updateQuantity(itemId, currentValue - 1);
                } else {
                    // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è 0, —É–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä
                    const removeForm = document.querySelector(`.remove-form [data-item-id="${itemId}"]`).closest('form');
                    if (confirm(translations.productRemoval)) {
                        removeForm.submit();
                    }
                }
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function () {
                const itemId = this.getAttribute('data-item-id');
                const newQuantity = parseInt(this.value);

                if (isNaN(newQuantity) || !validateQuantity(newQuantity)) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    const validationMessage = document.getElementById(`validation-${itemId}`);
                    validationMessage.style.display = 'block';

                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –≤–∞–ª–∏–¥–Ω–æ–º—É
                    this.value = this.defaultValue;

                    // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        validationMessage.style.display = 'none';
                    }, 3000);
                } else {
                    // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–∞–ª–∏–¥–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
                    this.closest('form').submit();
                }
            });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—Ç–∫–∞—Ç–∞
            input.defaultValue = input.value;
        });

        // –ó–∞–ø—Ä–µ—â–∞–µ–º –≤–≤–æ–¥ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö —á–∏—Å–µ–ª –∏ –¥—Ä—É–≥–∏—Ö –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('keydown', function (e) {
                // –†–∞–∑—Ä–µ—à–∞–µ–º: backspace, delete, tab, escape, enter, —Ç–æ—á–∫–∏, —Ü–∏—Ñ—Ä—ã
                if ([46, 8, 9, 27, 13, 110, 190].includes(e.keyCode) ||
                    // –†–∞–∑—Ä–µ—à–∞–µ–º: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 &amp;&amp; e.ctrlKey === true) ||
                    (e.keyCode === 67 &amp;&amp; e.ctrlKey === true) ||
                    (e.keyCode === 86 &amp;&amp; e.ctrlKey === true) ||
                    (e.keyCode === 88 &amp;&amp; e.ctrlKey === true) ||
                    // –†–∞–∑—Ä–µ—à–∞–µ–º: —Ü–∏—Ñ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –∏ numpad
                    (e.keyCode >= 48 &amp;&amp; e.keyCode <= 57) ||
                    (e.keyCode >= 96 &amp;&amp; e.keyCode <= 105)) {
                    return;
                }
                // –ó–∞–ø—Ä–µ—â–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ
                e.preventDefault();
            });

            input.addEventListener('input', function () {
                // –£–¥–∞–ª—è–µ–º –ª—é–±—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
                this.value = this.value.replace(/[^0-9]/g, '');

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                if (this.value > 99) {
                    this.value = 99;
                }
            });
        });
    });
</script>
{% endblock %}